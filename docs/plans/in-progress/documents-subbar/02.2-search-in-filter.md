# Phase 2.2: Search in Filter Dropdown

**Goal:** Move document search from ExpandableSearch into FilterButton dropdown, matching Linear-style UX.

**Architecture:** Search input at top of dropdown, wired to existing `filterValue` context. Search shows as dismissible pill in FilterBar.

**Tech Stack:** shadcn/ui Input, existing DocumentsFilterContext

**IMPORTANT - Design Reference:** The search input styling MUST match `StacksDropdown` (`frontend/components/documents/stacks-dropdown.tsx`). Key patterns:
- Input at top with `h-5 text-sm border-0 shadow-none focus-visible:ring-0 pl-0.5 pr-0`
- Wrapper div with `px-2 py-1`
- `onKeyDown={(e) => e.stopPropagation()}` to prevent dropdown typeahead
- `DropdownMenuSeparator` below search input

---

## Task 9: Add Search Input to FilterButton Dropdown

**Files:**
- Modify: `frontend/components/layout/filter-button.tsx`

**Step 1: Add imports and get filterValue from context**

```tsx
import { Input } from '@/components/ui/input'
import { DropdownMenuSeparator } from '@/components/ui/dropdown-menu'

// In component, add to useDocumentsFilter destructure:
const {
  filterValue,
  setFilterValue,
  dateRange,
  // ... rest
} = useDocumentsFilter()
```

**Step 2: Add search input at top of DropdownMenuContent**

```tsx
<DropdownMenuContent align="start" className="w-52" onCloseAutoFocus={(e) => e.preventDefault()}>
  {/* Search input */}
  <div className="px-2 py-1">
    <Input
      placeholder="Search documents..."
      aria-label="Search documents"
      value={filterValue}
      onChange={(e) => setFilterValue(e.target.value)}
      onKeyDown={(e) => e.stopPropagation()}
      className="h-5 text-sm border-0 shadow-none focus-visible:ring-0 pl-0.5 pr-0"
    />
  </div>
  <DropdownMenuSeparator />

  {/* Date sub-menu */}
  {/* ... rest unchanged */}
</DropdownMenuContent>
```

**Step 3: Verify build**

Run: `cd frontend && npm run build`

**Step 4: Commit**

```bash
git add frontend/components/layout/filter-button.tsx
git commit -m "feat: add search input to FilterButton dropdown"
```

---

## Task 10: Add Search Pill to FilterBar

**Files:**
- Modify: `frontend/components/layout/filter-bar.tsx`

**Step 1: Get filterValue from context**

```tsx
const { dateRange, stackFilter, filterValue, setFilterValue, clearDateFilter, clearStackFilter } = useDocumentsFilter()
```

**Step 2: Add search pill (render before date pill)**

```tsx
return (
  <div className="flex items-center gap-2">
    <FilterButton stacks={stacks} />

    {/* Search pill */}
    {filterValue && (
      <FilterPill
        label={`"${filterValue}"`}
        onClear={() => setFilterValue('')}
      />
    )}

    {/* Date pill */}
    {dateRange !== 'all' && (
      <FilterPill ... />
    )}

    {/* Stack pills */}
    {Array.from(stackFilter).map(...)}
  </div>
)
```

**Step 3: Update activeFilterCount to include search (optional)**

In `documents-filter-context.tsx`, update the count:

```tsx
const activeFilterCount = useMemo(() => {
  let count = 0
  if (filterValue) count += 1  // Add this line
  if (dateRange !== 'all') count += 1
  count += stackFilter.size
  return count
}, [filterValue, dateRange, stackFilter])
```

**Step 4: Verify build**

Run: `cd frontend && npm run build`

**Step 5: Commit**

```bash
git add frontend/components/layout/filter-bar.tsx frontend/components/documents/documents-filter-context.tsx
git commit -m "feat: add search pill to FilterBar"
```

---

## Task 11: Remove ExpandableSearch from SubBar

**Files:**
- Modify: `frontend/app/(app)/@subbar/documents/page.tsx`

**Step 1: Remove ExpandableSearch import and usage**

```tsx
// REMOVE this import:
// import { ExpandableSearch } from '@/components/layout/expandable-search'

// REMOVE from useDocumentsFilter destructure:
// filterValue, setFilterValue (no longer needed in this component)

// REMOVE from SubBar left:
// <ExpandableSearch
//   value={filterValue}
//   onChange={setFilterValue}
//   placeholder="Search documents..."
// />
```

**Step 2: Simplified SubBar**

```tsx
export default function DocumentsSubBar() {
  const { selectedCount } = useDocumentsFilter()
  const { stacks } = useStacks()
  const openFlow = useAgentStore((state) => state.openFlow)

  return (
    <SubBar
      left={<FilterBar stacks={stacks} />}
      right={
        <>
          <SelectionActions selectedCount={selectedCount} />
          <ActionButton
            icon={<Icons.Upload />}
            onClick={() => openFlow({ type: 'upload', step: 'dropzone', data: initialUploadData })}
          >
            Upload
          </ActionButton>
        </>
      }
    />
  )
}
```

**Step 3: Verify build**

Run: `cd frontend && npm run build`

**Step 4: Commit**

```bash
git add frontend/app/(app)/@subbar/documents/page.tsx
git commit -m "refactor: remove ExpandableSearch, search now in FilterButton"
```

---

## Task 12: Cleanup (Optional)

**Files:**
- Consider: `frontend/components/layout/expandable-search.tsx`

**Decision:** Keep or delete ExpandableSearch component?

- If used elsewhere (e.g., document detail subbar) → Keep
- If only used in documents list subbar → Can delete

Check usage:
```bash
grep -r "ExpandableSearch" frontend --include="*.tsx" -l
```

If safe to delete:
```bash
git rm frontend/components/layout/expandable-search.tsx
git commit -m "chore: remove unused ExpandableSearch component"
```

---

## Task 13: Add Filter Button to Document Detail SubBar (Search Only)

**Goal:** Add FilterButton to document detail page for searching extracted fields.

**Files:**
- Modify: `frontend/app/(app)/@subbar/documents/[id]/page.tsx`
- Modify: `frontend/components/documents/document-detail-sub-bar.tsx`

**Step 1: Create a simple FilterButton variant for detail page**

The document detail uses `DocumentDetailFilterContext` (separate from documents list).
Create a lightweight filter button with search only:

```tsx
// In document-detail-sub-bar.tsx or new component

interface DetailFilterButtonProps {}

function DetailFilterButton() {
  const { fieldSearch, setFieldSearch } = useDocumentDetailFilter()

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <ActionButton icon={<Icons.Filter />}>
          {!fieldSearch && 'Filter'}
        </ActionButton>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="start" className="w-52">
        <div className="px-2 py-1">
          <Input
            placeholder="Search fields..."
            aria-label="Search fields"
            value={fieldSearch}
            onChange={(e) => setFieldSearch(e.target.value)}
            onKeyDown={(e) => e.stopPropagation()}
            className="h-5 text-sm border-0 shadow-none focus-visible:ring-0 pl-0.5 pr-0"
          />
        </div>
      </DropdownMenuContent>
    </DropdownMenu>
  )
}
```

**Step 2: Replace ExpandableSearch in DocumentDetailSubBar**

```tsx
// Remove ExpandableSearch, add DetailFilterButton
<SubBar
  left={
    <>
      <DetailFilterButton />
      {fieldSearch && (
        <FilterPill label={`"${fieldSearch}"`} onClear={() => setFieldSearch('')} />
      )}
    </>
  }
  right={/* ... */}
/>
```

**Step 3: Verify build**

Run: `cd frontend && npm run build`

**Step 4: Commit**

```bash
git add frontend/components/documents/document-detail-sub-bar.tsx
git commit -m "feat: add FilterButton with search to document detail subbar"
```

---

## Summary

| Task | Description | Files |
|------|-------------|-------|
| 9 | Add search input to FilterButton dropdown | `filter-button.tsx` |
| 10 | Add search pill to FilterBar | `filter-bar.tsx`, `documents-filter-context.tsx` |
| 11 | Remove ExpandableSearch from SubBar | `@subbar/documents/page.tsx` |
| 12 | Cleanup unused component (optional) | `expandable-search.tsx` |
| 13 | Add FilterButton to document detail (search only) | `document-detail-sub-bar.tsx` |

**Result:**
- Documents list: FilterButton with search + date + stacks filters
- Document detail: FilterButton with search only (for fields)
