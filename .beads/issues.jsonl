{"id":"stackdocs-0b5","title":"Scroll padding for agent bar","description":"[Migrated from ACTIVE.md #38]\n\nContent cannot scroll past agent bar at bottom.\n\n- Documents table and extracted data table cut off behind agent bar\n- Need scroll padding/margin so users can scroll content past the floating bar\n- Affects both documents list and document detail views\n\nDate: 2026-01-01","status":"tombstone","priority":2,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:08:47.068792+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"bug"}
{"id":"stackdocs-0nt","title":"TEMPLATE_WIDTHS in desktop-card.tsx duplicates hardcoded widths from card className — can drift","status":"open","priority":3,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T19:03:12.021466+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T19:03:12.021466+11:00"}
{"id":"stackdocs-1jc","title":"Agent bar visual styling exploration","description":"[Migrated from ACTIVE.md #34]\n\nBackdrop blur, enhanced shadows, animation refinements.\n\nCurrent: Basic bg-sidebar with shadow-md\nExplore: Backdrop blur effects, depth/layering, dark mode polish\nRelated: Agent bar redesign\n\nDate: 2026-01-01","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:08:39.498048+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-2d5","title":"Improve canvas tool descriptions to reduce agent retries","description":"**Problem:** Agent wastes 8-9 tool call retries guessing block types and field names when creating cards. Each retry costs ~$0.02. The create_card tool description only says `blocks: list` with no schema info.\n\n**Evidence:** Full trace in Session 133. Agent tried: header→heading, divider→separator, text.text→text.content, paragraph, markdown — all invalid. Took 10 attempts to get it right.\n\n**Root cause:** Tool decorator in `sprite/src/agents/shared/canvas_tools.py:176` provides no block schema:\n```python\n@tool('create_card', 'Create a new card...', {'title': str, 'card_type': str, 'blocks': list})\n```\n\n**Fix:** Expand the tool description string to include:\n1. Valid card_type values: table, document, notes\n2. Valid block types with exact field names:\n   - heading: {type, text, subtitle?}\n   - stat: {type, value, label, trend?}\n   - key-value: {type, pairs: [{label, value}]}\n   - table: {type, columns: string[], rows: Record[]}\n   - badge: {type, text, variant: default|success|warning|destructive}\n   - progress: {type, value: number, label?}\n   - text: {type, content: string}  (NOTE: 'content' not 'text')\n   - separator: {type} (NOTE: not 'divider')\n3. Block id field is auto-generated (agent should NOT provide it)\n\n**Impact:** ~$0.20 wasted per card creation. Multiply by every user interaction = significant cost.\n\n**Files:** `sprite/src/agents/shared/canvas_tools.py` — update @tool description strings for create_card and update_card","status":"closed","priority":1,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-08T12:57:55.811458+11:00","created_by":"thebrownproject","updated_at":"2026-02-08T17:04:36.547899+11:00","closed_at":"2026-02-08T17:04:36.547899+11:00","close_reason":"Tool descriptions expanded with full block schema — valid types, field names, gotchas (content not text, separator not divider). Deployed to sd-e2e-test."}
{"id":"stackdocs-2km","title":"Agent bar max height and scroll behavior","description":"[Migrated from ACTIVE.md #35]\n\nDefine expanded height limits and scroll UX.\n\nDefine max expanded height before scrolling\nScroll behavior for long content (steps list, flow content)\nRelated: Agent bar redesign\n\nDate: 2026-01-01","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:08:40.952745+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-39p","title":"Inline stack creation during upload","description":"[Migrated from ACTIVE.md #12]\n\n\"+ New Stack\" chip in upload dialog to create stack without leaving flow.\n\nDate: 2025-12-24","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:07:07.264132+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-41u","title":"Drag-and-drop anywhere on documents page","description":"[Migrated from ACTIVE.md #11]\n\nDrop file anywhere to start upload, skip dialog step 1, jump straight to extraction config.\n\nDate: 2025-12-24","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:07:05.316195+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-42c","title":"TanStack Query for instant navigation","description":"[Migrated from ACTIVE.md #27]\n\nAdd client-side caching to eliminate loading screens on repeat visits.\n\nProblem: Server Components refetch on every navigation, causing skeleton flashes\nSolution: TanStack Query with staleTime for documents list, detail pages\nGoal: File browser feel - cached data shown instantly, background sync\nScope: Start with documents list, expand to stacks if successful\n\nDate: 2025-12-29","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:07:54.879335+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-4dj","title":"OS-aware keyboard shortcut display","description":"[Migrated from ACTIVE.md #31]\n\nCreate useModifierKey() hook to show Cmd on Mac, Ctrl on Windows/Linux in tooltips.\n\nCurrently: Tooltips hardcode Cmd symbol (e.g., \"Toggle sidebar (Cmd+B)\", \"Search (Cmd+K)\")\nGoal: Detect OS and show appropriate modifier key\nFiles: frontend/app/(app)/layout.tsx:53, frontend/components/layout/sidebar/sidebar-header-menu.tsx:116\n\nDate: 2025-12-31","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:08:33.776189+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-4pv","title":"Reusable EmptyState component","description":"[Migrated from ACTIVE.md #41]\n\nConsistent empty state UI across all pages.\n\nProps: icon, title, description, optional action button\nUse cases: no documents uploaded, no search results, no filters match, no stacks, preview panel (no doc selected)\nDesign: Simple illustration + text pattern, keep it lightweight\n\nDate: 2026-01-07","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:08:50.218523+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-4tx","title":"Card visual design overhaul — premium glass aesthetic","description":"Cards currently look basic and need a premium visual overhaul for demo-readiness. Areas to address: (1) Glass card chrome — richer backdrop blur, subtle inner glow, refined border treatment. (2) Block content layout — better spacing, visual hierarchy, content density. (3) Title bar — consider traffic-light dots or macOS-style window chrome. (4) Size-responsive content — blocks should adapt layout to card width (e.g. tables in large cards, compact stats in small). (5) Hover/focus states — subtle interactions that make cards feel alive. (6) Processing/status states — animated badges, loading skeletons. Reference: Apple Notes, Linear, Notion cards for inspiration. This is the frontend/design counterpart to the block renderer polish done in Session 130.","status":"open","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T10:40:17.805422+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T10:40:17.805422+11:00"}
{"id":"stackdocs-4z3","title":"Stacks Feature","description":"Frontend stacks UI feature - pages and tables. Phases 1-2 complete (foundation, pages). Phase 3 partially complete (table view done, pending tasks deferred until Stack Agent built).","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:28:27.746807+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-4z3.1","title":"Add 'Not extracted' indicator for pending docs","description":"Show pending extraction indicator in StackTableView for documents not yet in stack_table_rows. Blocked until Stack Agent is built.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:30:23.225618+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-4z3.2","title":"Add CSV export functionality","description":"Create frontend/lib/export-csv.ts utility and wire up Export button in stack-detail-client.tsx. Blocked until Stack Agent populates data.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:30:24.679191+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-4z3.3","title":"Create stacks component barrel export","description":"Create frontend/components/stacks/index.ts with exports for StackDetailClient, StackDocumentsTab, StackTableView, createStackTableColumns.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:30:26.070896+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-53t","title":"Remove gradient from top tab switcher pill","status":"closed","priority":2,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-16T22:18:31.761794+11:00","created_by":"thebrownproject","updated_at":"2026-02-16T22:20:35.877078+11:00","closed_at":"2026-02-16T22:20:35.877078+11:00","close_reason":"Removed pulsing gradient glow from glass-tab-switcher.tsx"}
{"id":"stackdocs-5it","title":"Voice bars — rightmost bar never animates","status":"closed","priority":2,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-16T22:18:32.828882+11:00","created_by":"thebrownproject","updated_at":"2026-02-17T07:41:02.439732+11:00","closed_at":"2026-02-17T07:41:02.439732+11:00","close_reason":"Fixed: voice bars now sample frequency bands within speech range (200Hz-4kHz) instead of single bins across full spectrum. Bar 4 was sampling ~9.3kHz where speech has no energy."}
{"id":"stackdocs-5k1","title":"Create useLocalStorage hook","description":"[Migrated from ACTIVE.md #29 - was tech-debt]\n\nReusable hook for localStorage state with SSR handling.\n\nCurrently: Inline localStorage usage in preview-panel-context.tsx\nGoal: DRY pattern for persisting UI state (sidebar, panels, preferences)\nConsider: useSyncExternalStore for proper SSR support\n\nDate: 2025-12-29","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:07:58.055575+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-61y","title":"article-card.tsx uses font-serif with no serif font loaded — fix or remove","status":"open","priority":3,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-20T19:03:12.38189+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T19:03:12.38189+11:00"}
{"id":"stackdocs-6e9","title":"Changed field highlight animation not visible","description":"[Migrated from ACTIVE.md #8]\n\nAnimation exists but too subtle or clearing too fast.\n\nFiles:\n- frontend/app/globals.css:130-142\n- frontend/components/documents/document-detail-client.tsx (changedFields state)\n- frontend/components/documents/extracted-data-table.tsx:97\n\nFix: Increase opacity (currently 15%), extend duration, or check if class is being applied.\n\nDate: 2025-12-24","status":"tombstone","priority":2,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:07:02.224812+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"bug"}
{"id":"stackdocs-6x8","title":"Field type definitions for custom extraction","description":"[Migrated from ACTIVE.md #2]\n\nAdd type selector (text, number, date, array) to field badges, enforce type safety in agent output.\n\nDate: 2025-12-23","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:06:52.728008+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-705","title":"Document upload, rendering, and OCR viewer on Canvas","description":"Explore and design the full document pipeline: drag-and-drop upload from OS → transfer to Sprite via Bridge → render PDF/document on Canvas card → OCR text toggle view. Needs brainstorm session to evaluate transfer approaches (HTTP proxy vs WS base64 vs hybrid), PDF rendering library choice, OCR viewer UX, and Canvas card integration. Existing infrastructure: FileUploadMessage protocol type, gateway stub, Sprites.dev FS API, api-proxy pattern in Bridge. See HOUSTON comment for initial recommendation (HTTP proxy preferred).","status":"closed","priority":1,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-14T11:22:47.889987+11:00","created_by":"thebrownproject","updated_at":"2026-02-18T21:01:06.752222+11:00","closed_at":"2026-02-18T21:01:06.752222+11:00","close_reason":"Design decision made: WS base64 approach chosen for demo sprint. Implementation tracked in m7b.5.1 and m7b.5.2."}
{"id":"stackdocs-73j","title":"Investigate Mistral OCR markdown output","description":"[Migrated from ACTIVE.md #7]\n\nCurrently exporting as raw text, check if API supports structured markdown output.\n\nDate: 2025-12-23","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:07:00.936626+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-7cw","title":"Realtime subscription breaks on document detail pages","description":"[Migrated from ACTIVE.md #25]\n\nChannel fails with \"CLOSED undefined\" after 1-2 minutes, likely Clerk JWT expiry not refreshing Supabase connection.\n\nError: [Realtime Debug] Channel failed: CLOSED undefined in useExtractionRealtime.useEffect\n\nFiles:\n- frontend/hooks/useExtractionRealtime.ts\n\nInvestigate: JWT token refresh, Supabase realtime auth, channel reconnection logic.\n\nDate: 2025-12-28","status":"tombstone","priority":2,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:07:51.071101+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"bug"}
{"id":"stackdocs-7vb","title":"Documents Redesign","description":"Transform Documents section from file+extraction hybrid into pure file management. AI-generated metadata on upload, metadata review step, simplified document table.","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:28:16.524937+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-7vb.1","title":"Phase 1: Create database migration for metadata columns","description":"Add display_name, tags, summary, updated_at columns to documents table. Create migration file, apply via Supabase, verify trigger works.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:28:39.069143+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Code review verified implementation complete (Phases 1-3 of Documents Redesign)","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.10","title":"Phase 3: Add streamDocumentMetadata API helper","description":"Add SSE streaming function to frontend/lib/agent-api.ts for metadata generation endpoint.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:21.053622+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Code review verified implementation complete (Phases 1-3 of Documents Redesign)","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.11","title":"Phase 3: Create UploadProcessing step component","description":"Create upload-processing.tsx showing spinner and tool events during OCR + metadata generation.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:22.383628+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Code review verified implementation complete (Phases 1-3 of Documents Redesign)","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.12","title":"Phase 3: Create UploadMetadata step component","description":"Create upload-metadata.tsx with editable display name, tags, summary, optional stack picker, regenerate and save buttons.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:24.077493+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Code review verified implementation complete (Phases 1-3 of Documents Redesign)","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.13","title":"Phase 3: Update UploadComplete and flow metadata","description":"Update complete step messaging, update steps/index.ts exports, update metadata.ts flow config.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:25.749419+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Code review verified implementation complete (Phases 1-3 of Documents Redesign)","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.14","title":"Phase 3: Rewrite use-upload-flow hook","description":"Implement new flow: file select -\u003e upload -\u003e OCR -\u003e metadata generation -\u003e review -\u003e save. Handle regenerate and stack assignment.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:27.120824+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Code review verified implementation complete (Phases 1-3 of Documents Redesign)","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.15","title":"Phase 3: Delete old step components","description":"Delete upload-configure.tsx, upload-fields.tsx, upload-extracting.tsx, extraction-method-card.tsx, field-tag-input.tsx after verifying build.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:29.284491+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Code review verified implementation complete (Phases 1-3 of Documents Redesign)","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.16","title":"Phase 4: Delete /documents/[id] routes","description":"Remove document detail page routes if they exist (main, @header, @subbar).","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:46.405235+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.17","title":"Phase 4: Change document name from Link to span","description":"Update columns.tsx to remove Link navigation from document name cell.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:48.075016+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.18","title":"Phase 4: Update preview panel with new metadata display","description":"Add displayName, tags, summary to PreviewMetadata. Remove fieldCount. Show tags as badges, summary with tooltip.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:49.862677+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.19","title":"Phase 4: Update selected document context and data flow","description":"Add displayName, tags, summary to context. Update Document type. Update documents-table.tsx and layout.tsx.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:51.141593+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.2","title":"Phase 1: Update SCHEMA.md documentation","description":"Update docs/specs/SCHEMA.md with new columns, trigger function, and migration entry.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:28:40.661365+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Code review verified implementation complete (Phases 1-3 of Documents Redesign)","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.20","title":"Phase 4: Add selected document breadcrumb to header","description":"Extend PageHeader to show selected document name. Update @header/documents/page.tsx to display.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:52.632574+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.21","title":"Phase 4: Deprecate extract-document flow","description":"Remove from agent-actions.tsx, registry.ts, agent-store.ts. Add deprecation comments to flow files.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:54.352751+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.22","title":"Phase 4: Clean up deprecated components and queries","description":"Add deprecation comments to document detail components, getDocumentWithExtraction, streamAgentExtraction. Update CLAUDE.md.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:55.688625+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.23","title":"Phase 4: Verify build and manual testing","description":"Run npm run build, test all functionality in browser per manual testing checklist.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:56.948486+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.3","title":"Phase 2: Create document_processor_agent directory structure","description":"Create backend/app/agents/document_processor_agent/ with __init__.py, agent.py, prompts.py, and tools/ subdirectory.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:28:54.373887+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Code review verified implementation complete (Phases 1-3 of Documents Redesign)","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.4","title":"Phase 2: Create shared read_ocr tool (DRY)","description":"Extract read_ocr tool to backend/app/agents/shared/tools/ for reuse by extraction_agent and document_processor_agent.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:28:56.408671+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Code review verified implementation complete (Phases 1-3 of Documents Redesign)","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.5","title":"Phase 2: Create save_metadata tool","description":"Create save_metadata tool that writes display_name, tags, summary to documents table with validation.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:28:58.189322+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Code review verified implementation complete (Phases 1-3 of Documents Redesign)","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.6","title":"Phase 2: Create metadata system prompt","description":"Create METADATA_SYSTEM_PROMPT in prompts.py with guidelines for display_name, tags, and summary generation.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:28:59.708814+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Code review verified implementation complete (Phases 1-3 of Documents Redesign)","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.7","title":"Phase 2: Create process_document_metadata agent function","description":"Implement process_document_metadata() in agent.py with Claude Agent SDK streaming.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:01.336482+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Code review verified implementation complete (Phases 1-3 of Documents Redesign)","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.8","title":"Phase 2: Create POST /api/document/metadata endpoint","description":"Add SSE streaming endpoint to routes/document.py. Create shared sse_event utility in utils/sse.py.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:02.652837+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Code review verified implementation complete (Phases 1-3 of Documents Redesign)","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7vb.9","title":"Phase 3: Update agent store types for new upload flow","description":"Update UploadFlowStep and UploadFlowData types. Change steps to dropzone/processing/metadata/complete.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:29:18.972092+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Code review verified implementation complete (Phases 1-3 of Documents Redesign)","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-7zs","title":"Upload dialog UI/UX polish","description":"[Migrated from ACTIVE.md #21]\n\nRedesign wizard flow, integrate with AI chat bar for seamless upload-to-extraction experience.\n\nDate: 2025-12-28","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:07:49.381915+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-830","title":"Superpowers to Space-Agents Migration","status":"tombstone","priority":1,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T09:37:25.354634+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Migration complete: DEV-NOTES→CAPCOM, Issues→Beads, Features→Epics, CLAUDE.md updated, folders restructured, commands archived","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-830.1","title":"Transform DEV-NOTES to CAPCOM","description":"Convert 111 sessions from DEV-NOTES.md to CAPCOM format using Python script","status":"tombstone","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T09:37:36.841507+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Closed","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-830.10","title":"BLOCKER: Pod reported blocker","status":"tombstone","priority":2,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:25:15.871147+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Stale blocker - task .3 already completed successfully","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"bug"}
{"id":"stackdocs-830.2","title":"Migrate Issues to Beads","description":"Convert 31 issues from ACTIVE.md to Beads","status":"tombstone","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T09:37:36.947583+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Closed","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-830.3","title":"Update CLAUDE.md Files","description":"Update root and docs/ CLAUDE.md to reference Space-Agents workflow","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T09:37:37.05302+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Closed","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-830.4","title":"Migrate Features to Beads","description":"Convert 4 features from plans/ to Beads epics: documents-redesign, stacks, stack-agent, backend-hardening","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T09:37:43.161905+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Closed","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-830.5","title":"Restructure Folders","description":"Archive old docs/plans/ and docs/sessions/ to docs/archive/","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T09:37:53.80588+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Archived docs/plans/ and docs/sessions/ to docs/archive/, updated CLAUDE.md references","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-830.6","title":"Cleanup Commands","description":"Archive or delete old .claude/commands/ that are replaced by Space-Agents","status":"tombstone","priority":3,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T09:37:53.909913+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Archived 6 replaced commands to .claude/commands/archive/, kept code-review.md and debug.md","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-830.7","title":"Cleanup Superpowers References","description":"Remove stale superpowers references from 20+ archived plan files (low priority)","status":"tombstone","priority":3,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T09:37:54.012286+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","close_reason":"Updated code-review.md to remove superpowers prefix, verified no active CLAUDE.md files reference superpowers, left archives unchanged","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-8dl","title":"Undo/Redo navigation in sidebar header","description":"[Migrated from ACTIVE.md #18]\n\nLinear-style back/forward/history buttons above search, requires navigation history system.\n\nDate: 2025-12-25","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:07:46.600801+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-8pg","title":"Preview panel redesign","description":"[Migrated from ACTIVE.md #36]\n\nUI tweaks to right-side document preview.\n\n- PDF/Visual tab styling improvements\n- Document metadata section (filename, date, size, status)\n- Visual (OCR) view markdown rendering polish\n- Loading states when switching documents\n\nDate: 2026-01-01","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:08:42.347018+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-8tb","title":"Preview panel Open button","description":"[Migrated from ACTIVE.md #40]\n\nAdd button in preview panel header to navigate to document detail.\n\n- When document is previewed in sidebar, show \"Open\" or expand icon in preview panel header\n- Clicking navigates to /documents/[id] detail page\n- Pattern similar to Linear/Notion preview panels\n- Related: Preview panel redesign (#36)\n\nDate: 2026-01-04","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:08:48.347265+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-92x","title":"PDF document block base64 data URI has ~1-2MB browser size limit","description":"The DocumentBlock embeds base64 PDF data as a data URI in an \u003cobject\u003e tag. Chrome/Firefox cap data URIs at ~2MB, so PDFs over ~1.5MB raw will silently fail (falls back to showing filename). Current upload limit is 25MB so users can upload files that won't render. Fix options: (1) react-pdf or pdf.js for client-side rendering, (2) serve files through Bridge HTTP endpoint instead of embedding, (3) convert first page to PNG thumbnail on Sprite. Gateway already guards at 5MB (skips embed for large files). This is cosmetic — the extraction still works, just no visual preview for large PDFs.","status":"open","priority":3,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-20T10:39:02.842221+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T10:39:13.77572+11:00"}
{"id":"stackdocs-97i","title":"Persist selected document in Zustand","description":"[Migrated from ACTIVE.md #37]\n\nRemember last selected doc on page reload.\n\n- Add localStorage persistence to selected document state\n- Use Zustand persist middleware\n- Restore selection when navigating back to documents page\n\nDate: 2026-01-01","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:08:45.678181+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-ag6","title":"Review and trim protocol + Bridge bloat","description":"Inspector flagged Bridge src/ at ~910 lines vs ~300 target. protocol.ts alone is 448 lines. Investigate: excessive comments, over-engineered type guards, verbose patterns. Trim all three protocol files (bridge TS, frontend TS, sprite Python) in sync. Target: Bridge src/ closer to 300 lines excluding shared protocol. Run all tests after.","status":"open","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T23:09:15.0507+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T23:09:15.0507+11:00"}
{"id":"stackdocs-ag6.1","title":"Cleanup: remove unused Bridge exports + stale script","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T21:31:34.327828+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T21:35:11.927814+11:00","closed_at":"2026-02-12T21:35:11.927814+11:00","close_reason":"Removed 5 unused exports (generateSpriteName, buildServerExecUrl, getPending, getSpriteConnectionCount, isKeepaliveActive), deleted parseMessage(), deleted stale test-sprite-e2e.ts. 107 tests pass (5 tests for removed functions also removed).","dependencies":[{"issue_id":"stackdocs-ag6.1","depends_on_id":"stackdocs-ag6","type":"parent-child","created_at":"2026-02-12T21:31:34.330112+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-aq3","title":"Cards load at (0,0) after restart — position not persisted to WorkspaceDB","description":"## Problem\nWhen cards are restored from state_sync after a server restart, they all appear at position (0,0) instead of where the user placed them. The cards table in WorkspaceDB doesn't store position or z_index — these only exist in the frontend's localStorage (desktop-store).\n\n## Root Cause\nstate_sync.py line 56 hardcodes card positions:\n```python\nposition=CardPosition(x=0.0, y=0.0),\nz_index=0,\n```\n\nThe workspace.db cards table schema (from bootstrap.ts) only has: card_id, stack_id, title, blocks, size, status, updated_at, archived_at. No position or z_index columns.\n\nCard positions are managed entirely in the frontend's Zustand desktop-store (persisted to localStorage). When state_sync sends cards, the frontend creates new DesktopCard objects at (0,0), overwriting any localStorage positions.\n\n## Impact\n- Cards pile up at origin after server restart, page refresh across devices, or state_sync\n- Users lose their spatial organization of cards\n- Breaks the 'desktop' metaphor where card placement is meaningful\n\n## Fix Options\n1. **Add position/z_index to cards table** — Sprite persists position. Frontend sends position updates to Sprite via canvas_interaction messages. state_sync includes real positions.\n2. **Merge strategy** — Frontend merges state_sync cards with localStorage positions. If localStorage has a position for a card_id, use it; otherwise use state_sync position. Simpler but doesn't sync across devices.\n3. **Frontend-authoritative** — state_sync only provides card content (title/blocks), frontend owns layout entirely. Cards not in state_sync get removed, new cards get auto-placed.\n\nOption 2 is quickest. Option 1 is correct long-term (enables multi-device).\n\n## Files\n- sprite/src/state_sync.py:56 — hardcoded CardPosition(x=0.0, y=0.0)\n- sprite/src/database.py — WorkspaceDB cards table schema (no position columns)\n- bridge/src/bootstrap.ts — INIT_DB_SCRIPT for cards table\n- frontend/lib/stores/desktop-store.ts — Zustand store with card positions\n- frontend/components/desktop/ws-provider.tsx — handles state_sync messages","status":"closed","priority":1,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-15T16:14:09.477034+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T18:36:26.427864+11:00","closed_at":"2026-02-15T18:36:26.427864+11:00","close_reason":"Closed"}
{"id":"stackdocs-aq3.1","title":"Add position columns to WorkspaceDB + update data layer","description":"## What\nAdd position_x, position_y, z_index columns to the cards table in WorkspaceDB. Update data access methods to store and retrieve position data.\n\n## Changes\n1. **database.py** — Add `position_x REAL DEFAULT 0.0`, `position_y REAL DEFAULT 0.0`, `z_index INTEGER DEFAULT 0` columns to cards table schema (WORKSPACE_SCHEMA)\n2. **database.py** — Update `upsert_card()` to accept optional `position_x`, `position_y`, `z_index` params and include in INSERT/UPDATE\n3. **database.py** — Add `update_card_position(card_id, position_x, position_y, z_index)` method\n4. **database.py** — Ensure `get_cards_by_stack()` (or equivalent query used by state_sync) returns position columns\n5. **bootstrap.ts** — Update INIT_DB_SCRIPT cards table to include position columns\n\n## Context\n- Current cards table schema: card_id, stack_id, title, blocks, size, status, archived_at, updated_at\n- upsert_card currently at database.py:226-244\n- Cards table schema at database.py:150-160\n- Bootstrap INIT_DB_SCRIPT at bootstrap.ts (search for CREATE TABLE.*cards)\n\n## Tests\n- [ ] upsert_card with position stores position_x, position_y, z_index correctly\n- [ ] upsert_card without position defaults to 0.0, 0.0, 0\n- [ ] update_card_position updates position for existing card\n- [ ] update_card_position returns false/error for non-existent card\n- [ ] Query used by state_sync returns position columns","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-15T16:31:21.421055+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T17:02:32.769702+11:00","closed_at":"2026-02-15T17:02:32.769702+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-aq3.1","depends_on_id":"stackdocs-aq3","type":"parent-child","created_at":"2026-02-15T16:31:21.423113+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-aq3.2","title":"Wire position through state_sync + gateway move handler","description":"## What\nUpdate state_sync to read real positions from DB. Add gateway handler for 'move' canvas_interaction that persists position to WorkspaceDB.\n\n## Changes\n1. **state_sync.py** — Read position_x, position_y, z_index from DB rows instead of hardcoding `CardPosition(x=0.0, y=0.0)` and `z_index=0`\n2. **gateway.py** — Add handler for `action: 'move'` in `_handle_canvas()` that calls `workspace_db.update_card_position(card_id, x, y, z_index)`\n3. **protocol.py** — Verify `CanvasAction` already includes 'move' (it does at line 58), ensure CanvasInteractionMessage has position fields or the move payload is well-defined\n\n## Context\n- state_sync.py:56 currently hardcodes position\n- gateway.py:123-153 handles canvas_interaction but has no 'move' handler\n- protocol.py:58 already defines 'move' as a valid CanvasAction\n- Depends on Task 1 (position columns in DB)\n\n## Tests\n- [ ] state_sync returns real positions from DB (not hardcoded 0,0)\n- [ ] state_sync returns default 0,0 for cards with no stored position (backwards compat)\n- [ ] Gateway handles 'move' canvas_interaction and persists position to DB\n- [ ] Gateway 'move' with invalid card_id returns error\n- [ ] Round-trip: upsert card with position → state_sync returns same position","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-15T16:31:29.764368+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T18:36:26.330288+11:00","closed_at":"2026-02-15T18:36:26.330288+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-aq3.2","depends_on_id":"stackdocs-aq3","type":"parent-child","created_at":"2026-02-15T16:31:29.765989+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-aq3.2","depends_on_id":"stackdocs-aq3.1","type":"blocks","created_at":"2026-02-15T16:31:51.956057+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-aq3.3","title":"Frontend sends move on drag end + merges state_sync positions","description":"## What\nFrontend sends canvas_interaction 'move' message when user finishes dragging a card. ws-provider merges state_sync positions with existing store positions instead of full replacement.\n\n## Changes\n1. **desktop-card.tsx** — On drag end (after momentum settles or on pointerUp), send `canvas_interaction` message with `action: 'move'`, `card_id`, `position: {x, y}`, `z_index` via WebSocket\n2. **ws-provider.tsx** — Change state_sync handler: instead of `store.setCards(cardRecord)` (full replace), merge with existing cards. For each card in state_sync: if store already has that card_id with a non-default position, keep the store position. For new cards, use state_sync position or auto-place if (0,0).\n3. **desktop-store.ts** — Add `mergeCards(cards: Record\u003cstring, DesktopCard\u003e)` method that merges instead of replacing. Existing cards keep their position; new cards get state_sync position.\n4. **types/ws-protocol.ts** — Ensure CanvasInteractionMessage type supports move payload with position fields (may already exist)\n\n## Context\n- desktop-card.tsx handles drag via pointer events + momentum physics\n- ws-provider.tsx:177 currently does `store.setCards(cardRecord)` — full replacement\n- desktop-store.ts:121-127 `setCards` replaces entire cards Record\n- WebSocket send available via `sendMessage` from ws-provider or websocket.ts\n- Protocol already defines 'move' as valid CanvasAction\n- Depends on Task 2 (gateway handles move)\n\n## Tests\n- [ ] Dragging a card and releasing sends canvas_interaction 'move' message via WebSocket\n- [ ] Move message includes card_id, position.x, position.y, z_index\n- [ ] state_sync merge: existing cards keep their stored position\n- [ ] state_sync merge: new cards (not in store) get auto-placed or use state_sync position\n- [ ] state_sync merge: removed cards (in store but not in state_sync) get cleaned up\n- [ ] No move message spam during drag — only sent on drag end","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-15T16:31:41.90126+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T18:36:26.38171+11:00","closed_at":"2026-02-15T18:36:26.38171+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-aq3.3","depends_on_id":"stackdocs-aq3","type":"parent-child","created_at":"2026-02-15T16:31:41.902764+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-aq3.3","depends_on_id":"stackdocs-aq3.2","type":"blocks","created_at":"2026-02-15T16:31:52.097566+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-cch","title":"Document status stuck at ocr_complete","description":"[Migrated from ACTIVE.md #16]\n\nExtraction agent saves data but doesn't call complete tool, so document/extraction status never updates to completed.\n\nFiles:\n- backend/app/agents/extraction_agent/agent.py\n- backend/app/agents/extraction_agent/tools/complete.py\n\nAgent needs to reliably call complete tool after saving extraction.\n\nDate: 2025-12-24","status":"tombstone","priority":2,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:07:45.419036+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"bug"}
{"id":"stackdocs-cpy","title":"Evaluate column separation pattern for dynamic tables","description":"[Migrated from ACTIVE.md #26 - was tech-debt]\n\nStack tables use separated columns file (stack-table-columns.tsx) following documents pattern, but columns are dynamically generated from schema. Consider if inline definition would be simpler for this use case.\n\nCurrent: columns.tsx separate, documents-table.tsx imports it (static columns, 170 lines)\nStack tables: Dynamic createStackTableColumns(schema) function - tightly coupled anyway\nQuestion: Does separation still provide value for dynamic column generation?\n\nDate: 2025-12-29","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:07:53.260241+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-drg","title":"Stack Agent","description":"Backend stack extraction agent with SSE routes. Create FastAPI routes for stack agent operations (extract, correct) and Claude Agent SDK tools for reading documents and writing stack table rows.","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:28:29.682019+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-drg.1","title":"Create stack_agent directory structure","description":"Create backend/app/agents/stack_agent/ with __init__.py, agent.py, prompts.py, and tools/ subdirectory.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:30:48.653958+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-drg.2","title":"Create stack agent prompts","description":"Write STACK_EXTRACTION_SYSTEM_PROMPT and task templates for auto/custom modes and correction workflow.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:30:49.916701+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-drg.3","title":"Create stack agent read tools","description":"Implement read_document_extraction, read_ocr, read_rows tools in tools/read_tools.py.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:30:51.173611+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-drg.4","title":"Create stack agent write tools","description":"Implement define_columns, save_row, update_row, complete tools in tools/write_tools.py.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:30:52.936255+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-drg.5","title":"Create stack agent tool factory","description":"Implement create_extraction_tools and create_correction_tools in tools/__init__.py.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:30:54.304639+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-drg.6","title":"Implement extract_stack_table and correct_stack_table","description":"Main agent functions in agent.py with Claude Agent SDK streaming.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:30:55.957614+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-drg.7","title":"Create stack router with SSE endpoints","description":"Create backend/app/routes/stack.py with POST /api/stack/{stack_id}/tables/{table_id}/extract and /correct endpoints.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:31:03.262825+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-drg.8","title":"Register stack router in main.py","description":"Import and register stack_router with prefix /api/stack in backend/app/main.py.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:31:04.819038+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-e2p","title":"Parallelize Deepgram token fetch and getUserMedia","description":"In use-stt.ts startListening(), token fetch (lines 73-92) and getUserMedia (lines 94-110) are sequential. Use Promise.all to run both in parallel. Handle errors for each independently. This alone saves ~300-800ms.","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-15T21:45:17.368057+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T21:55:25.252882+11:00","closed_at":"2026-02-15T21:55:25.252882+11:00","close_reason":"Parallelized token fetch + getUserMedia with Promise.allSettled. 13/13 tests passing. ~300-800ms saved on STT startup."}
{"id":"stackdocs-e7z","title":"Backend Production Hardening","description":"Harden FastAPI backend for production: security headers, CORS restrictions, rate limiting, file content validation, structured logging, global exception handling.","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:28:31.441145+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-e7z.1","title":"Phase 1: Add security headers middleware","description":"Create middleware/security.py with HSTS, X-Content-Type-Options, X-Frame-Options, X-XSS-Protection, Referrer-Policy, Permissions-Policy.","status":"tombstone","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:31:25.8324+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-e7z.10","title":"Phase 5: Enhance Pydantic settings validation","description":"Add field validators for CLAUDE_MODEL, ENVIRONMENT. Add min_length constraints to API keys.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:32:04.230035+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-e7z.11","title":"Phase 6: Enhance health check endpoint","description":"Add database connectivity check. Return 'degraded' status if checks fail. Include individual check results.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:32:09.945997+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-e7z.12","title":"Phase 7: Finalize middleware stack order","description":"Organize middleware in correct order: RequestID (outermost), CORS, SecurityHeaders, SlowAPI. Verify integration.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:32:18.381707+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-e7z.13","title":"Phase 7: Add graceful shutdown to Dockerfile","description":"Add --timeout-graceful-shutdown 30 to uvicorn CMD for in-flight request completion.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:32:19.797667+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-e7z.14","title":"Phase 7: Create PRODUCTION.md documentation","description":"Document security checklist, rate limits, environment variables, and deployment configuration.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:32:21.136839+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-e7z.2","title":"Phase 1: Restrict CORS configuration","description":"Update CORS middleware to explicit methods (GET, POST, PUT, DELETE, OPTIONS) and headers (Authorization, Content-Type, X-Request-ID).","status":"tombstone","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:31:27.89389+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-e7z.3","title":"Phase 2: Install slowapi and create rate limiter","description":"Add slowapi to requirements.txt. Create middleware/rate_limit.py with user/IP-based keys and 100/minute default.","status":"tombstone","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:31:35.0243+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-e7z.4","title":"Phase 2: Apply rate limits to routes","description":"Add rate decorators: upload 10/min, retry-ocr 5/min, extract 20/min, correct 30/min. Register in main.py.","status":"tombstone","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:31:37.393508+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-e7z.5","title":"Phase 3: Install python-magic and validate file content","description":"Add python-magic to requirements.txt, libmagic to Dockerfile. Update _validate_file to check actual MIME type from bytes.","status":"tombstone","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:31:43.391485+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-e7z.6","title":"Phase 4: Create global exception handlers","description":"Create middleware/exceptions.py with global, HTTP, and validation exception handlers. Hide internal details in production.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:31:52.250002+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-e7z.7","title":"Phase 4: Add request ID middleware","description":"Create middleware/request_id.py to generate/propagate X-Request-ID for tracing.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:31:53.671952+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-e7z.8","title":"Phase 4: Sanitize error messages in services","description":"Update storage.py and document.py to return generic error messages, log details internally.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:31:55.436419+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-e7z.9","title":"Phase 5: Add structured logging configuration","description":"Create logging_config.py with JSON formatter for production, readable format for development. Initialize in main.py.","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:32:02.531313+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-fb9","title":"Buffer audio before Deepgram WS opens — start MediaRecorder immediately","description":"Currently MediaRecorder.start(250) is called inside the Deepgram Open event handler (line ~145). Instead: start MediaRecorder immediately after getUserMedia returns, buffer dataavailable chunks in an array, and flush the buffer to connection.send() when Open fires. Saves ~100-300ms of WS handshake latency and captures early audio. Handle edge case: if buffer grows too large (\u003e10s) before connection opens, stop and error.","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-15T21:45:18.729066+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T22:05:30.134111+11:00","closed_at":"2026-02-15T22:05:30.134111+11:00","close_reason":"Audio buffered before Deepgram WS opens. MediaRecorder starts immediately after getUserMedia. Overflow guard at 40 chunks. 15/15 tests passing.","dependencies":[{"issue_id":"stackdocs-fb9","depends_on_id":"stackdocs-e2p","type":"blocks","created_at":"2026-02-15T21:45:27.413404+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-fg6","title":"Sidebar collapsible section state persistence","description":"[Migrated from ACTIVE.md #28]\n\nRemember open/closed state across page refreshes.\n\nChallenge: SSR hydration mismatch when reading localStorage on client\nOptions: Cookies (server-readable), localStorage with hydration workaround, or accept flash\nFiles: frontend/components/layout/sidebar/collapsible-section.tsx\n\nDate: 2025-12-29","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:07:56.473476+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-h3e","title":"Sub-bar button functionality","description":"[Migrated from ACTIVE.md #20]\n\nFilter dropdown options, Edit inline editing, Export format options need implementation.\n\nDate: 2025-12-28","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:07:48.116582+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-iic","title":"Auth timeout on Fly.io cold start (10s too short)","description":"Frontend hits auth timeout errors when Bridge machine is cold (auto_stop_machines=true, min_machines_running=0). Fly.io machine boot takes 3-10s, eating into the 10s AUTH_TIMEOUT_MS (bridge/src/index.ts:45). Users see 2-3 connection attempts before succeeding (~26s total). Options: (1) Bump AUTH_TIMEOUT_MS to 30s, (2) HTTP pre-warm /health before WS connect, (3) Set min_machines_running=1. Observed in debug panel session 164.","status":"open","priority":2,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-14T18:29:21.796927+11:00","created_by":"thebrownproject","updated_at":"2026-02-14T18:29:21.796927+11:00"}
{"id":"stackdocs-inb","title":"Daemon activity feed in debug panel","description":"Add a daemon_event WebSocket message type on the Sprite side so the ObservationProcessor reports its activity to the browser. Currently the processor (every 25 turns) runs entirely on-Sprite with no visibility — it reads transcript.db observations, calls Haiku to extract learnings, updates memory files (tools.md, files.md, user.md, context.md), and writes to memory.db. Add daemon_event messages for: batch start/end, observations processed count, memory files updated, learnings extracted. Display in the Debug Panel's Agent tab. Requires changes to sprite/src/memory/processor.py (emit events), sprite/src/protocol.py (new message type), bridge/src/protocol.ts (type definition), and frontend debug-panel.tsx (render daemon events).","status":"open","priority":3,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-14T10:12:37.580741+11:00","created_by":"thebrownproject","updated_at":"2026-02-14T10:12:37.580741+11:00"}
{"id":"stackdocs-k8w","title":"Documents table accessibility improvements","description":"[Migrated from ACTIVE.md #5 - was tech-debt]\n\nAdd keyboard navigation (Enter/Space) and ARIA labels to clickable rows in documents table.\n\nDate: 2025-12-23","status":"tombstone","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:06:57.301429+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"stackdocs-kfn","title":"Fix Sprite↔Bridge WebSocket communication through TCP proxy","description":"## Problem\n\nMessages sent through the Sprites.dev TCP proxy to the Sprite's WebSocket server on port 8765 are not being received by the gateway, OR the gateway processes them but the agent response times out.\n\n## What We Know\n\n### Working:\n- Sprite server starts fine (Database connects, WS server listens on 0.0.0.0:8765)\n- TCP proxy connects successfully (status: connected, target: 10.0.0.1:8765)\n- Claude Agent SDK is installed and finds bundled CLI binary\n- API key proxy on Bridge deployed and returns 401 without token (correct)\n- From INSIDE the Sprite: local Python WS client connects, gateway receives mission, SDK launches claude binary\n- Fly.io secrets set: SPRITES_PROXY_TOKEN, ANTHROPIC_API_KEY, MISTRAL_API_KEY\n\n### Broken:\n- Messages sent through TCP proxy → 0 events received back (60s timeout)\n- From inside Sprite: gateway receives mission, SDK starts, but no agent_event messages return within 60s\n\n### Bugs Found \u0026 Fixed This Session:\n1. **Relative import error**: server.py used relative imports but was run as script. Fixed: `bash -c 'cd /workspace \u0026\u0026 python3 -m src.server'`\n2. **Timestamp validation**: `is_websocket_message()` expects numeric timestamp (Unix epoch ms), test was sending ISO string. Fixed in test, but ALL callers must use `Date.now()` not `new Date().toISOString()`\n3. **Port 8765 stale**: Old server processes survive Sprite sleep/wake (CRIU). Must kill before restart.\n4. **TCP proxy init format**: Proxy returns `{type:'port_opened'}` then `{status:'connected'}`. Bridge sprite-connection.ts only checks for `status:'connected'` — works but should handle both.\n\n### Two Remaining Issues to Investigate:\n1. **TCP proxy message forwarding**: Do WS messages sent through the outer WS tunnel actually reach the Sprite's WS server as WS frames? The proxy creates a TCP connection — does it perform WS upgrade or just raw TCP? Server logs show `Connection opened` from localhost client but we need to verify proxy connections appear.\n2. **Agent SDK timeout**: Even from inside the Sprite (bypassing proxy), the SDK launches claude but no events stream back within 60s. Is the API call through the proxy failing silently? Check: is ANTHROPIC_BASE_URL being read correctly by the bundled CLI? Does the proxy token auth work end-to-end?\n\n## Files Involved\n- `bridge/src/api-proxy.ts` — HTTP reverse proxy (new, 130 lines)\n- `bridge/src/provisioning.ts` — Server command, env vars\n- `bridge/src/sprite-connection.ts` — TCP proxy client\n- `sprite/src/server.py` — WS server entry\n- `sprite/src/gateway.py` — Message router\n- `sprite/src/runtime.py` — Agent runtime (new, 141 lines)\n- `sprite/src/protocol.py` — is_websocket_message validation\n- `bridge/scripts/test-e2e-v2.ts` — E2E test script\n- `bridge/scripts/check-sprite.ts` — Sprite diagnostic script\n\n## Test Sprite\n- Name: `sd-e2e-test` (bootstrapped, VERSION=2, all packages installed)\n- Server command: `cd /workspace \u0026\u0026 python3 -m src.server`\n\n## Next Steps\n1. SSH/exec into Sprite, start server with real proxy token, test from inside with verbose SDK logging\n2. Verify the proxy token + ANTHROPIC_BASE_URL actually reaches Anthropic via Bridge proxy\n3. If SDK works from inside, investigate TCP proxy WS frame forwarding\n4. If SDK fails from inside, debug the proxy auth chain","status":"closed","priority":0,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-08T00:38:27.95056+11:00","created_by":"thebrownproject","updated_at":"2026-02-08T08:37:54.718704+11:00","closed_at":"2026-02-08T08:37:54.718704+11:00","close_reason":"All three root causes fixed and verified: (1) api-proxy.ts accepts x-api-key header, (2) sprite-connection.ts sends binary WS frames, (3) server.py uses TCP server matching TCP proxy. Clean e2e test passed: mission sent through TCP proxy, agent returned '4' for '2+2', complete event received with session_id and cost."}
{"id":"stackdocs-l0l","title":"Remove dead spike code: font-switcher.tsx and spike palette.ts have no consumers outside spike/","status":"open","priority":3,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T19:03:12.168268+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T19:03:12.168268+11:00"}
{"id":"stackdocs-lab","title":"Global context to persist SSE streams across navigation","description":"[Migrated from ACTIVE.md #10]\n\nCurrently if user navigates away mid-extraction/correction, progress panel is lost (agent continues server-side).\n\nDate: 2025-12-24","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:07:03.795937+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-lau","title":"AI prompt flow with auto-generated titles","description":"[Migrated from ACTIVE.md #33]\n\nNatural language input morphs to brief summary title, agent works on request.\n\nUser types prompt in agent bar -\u003e bar morphs to show AI-generated 3-5 word title\nAgent streams response in content area below\nSame unified card pattern as wizard flows\nRelated: Agent bar redesign (docs/plans/in-progress/agent-bar-redesign/)\n\nDate: 2026-01-01","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:08:37.67489+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-m7b","title":"Stackdocs v2 — Sovereign Agent Platform","description":"Rewrite Stackdocs from a multi-tenant SaaS into a personal AI computer where each stack runs on its own Sprite (microVM), connected via a Fly.io WebSocket Bridge, with a Canvas UI for visual output. 29 tasks across 6 phases. Spec: .space-agents/exploration/planned/2026-02-06-stackdocs-v2-revised-architecture/spec.md Plan: .space-agents/exploration/planned/2026-02-06-stackdocs-v2-revised-architecture/plan.md","status":"open","priority":0,"issue_type":"epic","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:16:58.403891+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:16:58.403891+11:00"}
{"id":"stackdocs-m7b.1","title":"Phase 0: Pre-flight Validation","description":"Mandatory gate before writing any code. Validates Sprites.dev and Fly.io viability.","status":"closed","priority":0,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:17:07.334352+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T17:06:24.838246+11:00","closed_at":"2026-02-06T17:06:24.838246+11:00","close_reason":"Phase 0 complete. Gate: PASS. Proceed to Phase 1.","dependencies":[{"issue_id":"stackdocs-m7b.1","depends_on_id":"stackdocs-m7b","type":"parent-child","created_at":"2026-02-06T15:17:07.335439+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.1.1","title":"Pre-flight validation (Fly.io + Sprites.dev)","description":"**Goal:** Validate Sprites.dev and Fly.io accounts, APIs, and critical assumptions before writing any code.\n**Files:** Create `docs/ops/preflight-results.md` (findings and measurements)\n**Depends on:** None\n\n**Steps:**\n1. Fly.io account setup + billing\n2. Sprites.dev account + API token\n3. Test Sprites APIs manually: create, exec, sleep, wake, services, TCP proxy\n4. **Verify Service auto-restart on wake** (MEDIUM confidence — the spec's biggest risk)\n5. Measure Sprites.dev region latency from Australia\n6. If auto-restart fails: document fallback (Bridge sends exec command after every wake)\n7. Write up findings in `docs/ops/preflight-results.md`\n\n**Tests:**\n- [ ] `docs/ops/preflight-results.md` exists with all 5 checks documented\n- [ ] Auto-restart result explicitly confirmed or denied with evidence\n- [ ] Latency measurement from Australia recorded (target \u003c 200ms)\n- [ ] If auto-restart failed: fallback documented and Bridge reconnection task updated\n\n**Gate:** All checks pass. If auto-restart fails, update Bridge reconnection task before proceeding.","status":"closed","priority":0,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:17:35.987205+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T17:06:24.712727+11:00","closed_at":"2026-02-06T17:06:24.712727+11:00","close_reason":"Pre-flight PASSED. All critical checks pass. Key finding: processes survive sleep/wake (CRIU/checkpoint), not killed as assumed. Services API has bug but is non-blocking. TCP Proxy works perfectly. AU latency avg 180ms (under 200ms target). See docs/ops/preflight-results.md","dependencies":[{"issue_id":"stackdocs-m7b.1.1","depends_on_id":"stackdocs-m7b.1","type":"parent-child","created_at":"2026-02-06T15:17:35.988156+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.10","title":"Cleanup: delete stale sprite test files","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T21:31:34.882346+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T21:34:35.557556+11:00","closed_at":"2026-02-12T21:34:35.557556+11:00","close_reason":"Deleted manual_canvas_test.py, trimmed test_memory_system.py from 357 to 73 lines. 45 tests pass.","dependencies":[{"issue_id":"stackdocs-m7b.10","depends_on_id":"stackdocs-m7b","type":"parent-child","created_at":"2026-02-12T21:31:34.883331+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.11","title":"Cleanup: move runtime.py legacy methods to test helpers","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T21:31:35.111834+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T21:35:12.480237+11:00","closed_at":"2026-02-12T21:35:12.480237+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.11","depends_on_id":"stackdocs-m7b","type":"parent-child","created_at":"2026-02-12T21:31:35.114098+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12","title":"One Sprite Per User (Stack Architecture Refactor)","description":"Migrate from one Sprite VM per stack to one Sprite VM per user. Stacks become lightweight canvas layouts (like macOS Spaces) — all on one Sprite. Archive model: nothing is ever destroyed. User-initiated actions handled by gateway directly. Agent actions via tools.\n\n**Spec:** .space-agents/exploration/planned/2026-02-13-one-sprite-per-user/spec.md\n**Plan:** .space-agents/exploration/planned/2026-02-13-one-sprite-per-user/plan.md","status":"closed","priority":1,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:13:19.805411+11:00","created_by":"thebrownproject","updated_at":"2026-02-14T09:25:58.0662+11:00","closed_at":"2026-02-14T09:25:58.0662+11:00","close_reason":"17/17 tasks complete. Bridge re-keyed per-user, Sprite WorkspaceDB + state sync, frontend routing + store + state sync. 136 bridge tests passing.","dependencies":[{"issue_id":"stackdocs-m7b.12","depends_on_id":"stackdocs-m7b","type":"parent-child","created_at":"2026-02-13T16:13:19.820711+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.1","title":"Protocol types — add stack_id, context, state_sync","description":"**Goal:** Update shared WebSocket protocol types across all 3 codebases.\n\n**Files:**\n- Modify `bridge/src/protocol.ts` (source of truth)\n- Modify `sprite/src/protocol.py`\n- Modify `frontend/types/ws-protocol.ts`\n\n**Steps:**\n1. Add `stack_id?: string` to `CanvasUpdate.payload`\n2. Add `context?: { stack_id: string }` to `MissionMessage.payload`\n3. Add new `StateSyncMessage` type with stacks, cards, chat_history\n4. Add `state_sync` to MESSAGE_TYPES and SpriteToBrowserMessage union\n5. Add `isStateSyncMessage` type guard\n6. Add archive/create/restore commands to canvas_interaction\n7. Mirror to Python dataclasses and frontend types\n\n**Tests:**\n- [ ] isCanvasUpdate validates messages with optional stack_id\n- [ ] isMissionMessage validates messages with optional context\n- [ ] isStateSyncMessage validates well-formed state_sync messages\n- [ ] canvas_interaction commands include archive/create/restore actions\n- [ ] Python is_state_sync validates equivalent structure","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:13:31.790622+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T20:15:12.375725+11:00","closed_at":"2026-02-13T20:15:12.375725+11:00","close_reason":"All 5 test criteria pass. Bridge 21/21, Sprite 19/19. Protocol files in sync across 3 codebases.","dependencies":[{"issue_id":"stackdocs-m7b.12.1","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:13:31.793298+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.10","title":"Sprite canvas tools + DB persistence","description":"**Goal:** Add stack_id to canvas tool output, persist card changes to WorkspaceDB. Gateway handles user-initiated archive commands.\n\n**Files:** Modify sprite/src/agents/shared/canvas_tools.py, sprite/src/runtime.py, sprite/src/gateway.py\n\n**Steps:**\n1. create_canvas_tools factory accepts workspace_db and stack_id as closure params\n2. create_card includes stack_id in canvas_update payload and persists to DB\n3. close_card archives (not deletes) via db.archive_card()\n4. Gateway handles user-initiated canvas_interaction commands directly: archive_card, archive_stack, create_stack, restore_stack\n5. Agent-initiated and user-initiated archives call same DB methods\n\n**Tests:**\n- [ ] create_card sends canvas_update with stack_id and persists\n- [ ] close_card archives card (not delete)\n- [ ] Gateway handles archive_card/archive_stack without agent\n- [ ] Agent-initiated vs user-initiated use same DB methods","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:14:29.101852+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T21:59:13.170065+11:00","closed_at":"2026-02-13T21:59:13.170065+11:00","close_reason":"All 7 criteria pass. 29/29 tests. Canvas tools persist to DB, gateway handles user-initiated actions directly, archive semantics correct.","dependencies":[{"issue_id":"stackdocs-m7b.12.10","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:14:29.102973+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.10","depends_on_id":"stackdocs-m7b.12.1","type":"blocks","created_at":"2026-02-13T16:16:57.631672+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.10","depends_on_id":"stackdocs-m7b.12.8","type":"blocks","created_at":"2026-02-13T16:16:57.786439+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.11","title":"Sprite chat persistence","description":"**Goal:** Store user messages and agent responses in chat_messages table.\n\n**Files:** Modify sprite/src/gateway.py, sprite/src/runtime.py\n\n**Steps:**\n1. On mission received: db.add_chat_message(\"user\", payload.text)\n2. Accumulate agent response text from streaming events\n3. On complete: db.add_chat_message(\"agent\", accumulated_text)\n4. WorkspaceDB flows from server → gateway → runtime\n\n**Tests:**\n- [ ] User messages saved with role='user'\n- [ ] Agent responses saved with role='agent' (full text)\n- [ ] Streaming chunks accumulated, not stored individually","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:14:29.256689+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T22:12:41.232045+11:00","closed_at":"2026-02-13T22:12:41.232045+11:00","close_reason":"All 4 criteria pass. 6/6 tests. 7 lines added total. Separate accumulator avoids TurnBuffer/Stop hook timing.","dependencies":[{"issue_id":"stackdocs-m7b.12.11","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:14:29.257744+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.11","depends_on_id":"stackdocs-m7b.12.8","type":"blocks","created_at":"2026-02-13T16:16:57.974086+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.12","title":"Frontend WS + routing (remove stackId from routing)","description":"**Goal:** Remove stackId from WS connection URL and page routing. Single page, no stack in URL.\n\n**Files:**\n- Modify frontend/lib/websocket.ts\n- Modify frontend/components/desktop/ws-provider.tsx\n- Create frontend/app/(desktop)/page.tsx\n- Remove/archive frontend/app/(desktop)/stacks/[id]/page.tsx\n\n**Steps:**\n1. websocket.ts: Remove stackId from options, connect to /ws\n2. ws-provider.tsx: Remove stackId prop, wrap at app layout level\n3. Create (desktop)/page.tsx using useCardsForActiveStack() selector\n4. Update landing page redirect and Clerk middleware\n\n**Tests:**\n- [ ] WebSocketManager connects to /ws (no stack ID in URL)\n- [ ] WebSocketProvider has no stackId prop\n- [ ] New route renders the glass desktop\n- [ ] Cards render from store filtered by activeStackId","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:15:01.626931+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T22:27:26.321145+11:00","closed_at":"2026-02-13T22:27:26.321145+11:00","close_reason":"All 4 criteria pass. TS clean. WS connects to /ws, no stackId prop, /desktop route created, old dynamic route deleted.","dependencies":[{"issue_id":"stackdocs-m7b.12.12","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:15:01.630089+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.12","depends_on_id":"stackdocs-m7b.12.1","type":"blocks","created_at":"2026-02-13T16:16:58.116647+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.12","depends_on_id":"stackdocs-m7b.12.3","type":"blocks","created_at":"2026-02-13T16:16:58.267354+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.13","title":"Frontend stack store (multi-stack)","description":"**Goal:** Refactor store to manage multiple stacks with card filtering.\n\n**Files:** Modify frontend/lib/stores/desktop-store.ts\n\n**Steps:**\n1. Add StackInfo type: { id, name, color? }\n2. Add stacks: StackInfo[] to state\n3. Add stackId: string to card interface\n4. Rename activeWorkspace to activeStackId\n5. Add actions: setStacks, addStack, archiveStack, restoreStack, renameStack\n6. Create useCardsForActiveStack() selector\n7. Bump persist version, add migration for old localStorage data\n\n**Tests:**\n- [ ] setStacks replaces stacks array\n- [ ] archiveStack hides stack and archives its cards\n- [ ] useCardsForActiveStack filters correctly\n- [ ] Persist migration handles old data without stackId","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:15:01.841917+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T22:35:15.847284+11:00","closed_at":"2026-02-13T22:35:15.847284+11:00","close_reason":"All 6 criteria pass. StackInfo imported, activeStackId renamed, persist migration, useCardsForActiveStack selector. Expected consumer breakages in m7b.12.15/16.","dependencies":[{"issue_id":"stackdocs-m7b.12.13","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:15:01.843361+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.13","depends_on_id":"stackdocs-m7b.12.1","type":"blocks","created_at":"2026-02-13T16:16:58.417978+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.14","title":"Frontend state sync handler","description":"**Goal:** Process state_sync message on WS connect, populate stack and chat stores.\n\n**Files:** Modify frontend/components/desktop/ws-provider.tsx\n\n**Steps:**\n1. Add state_sync case to handleMessage\n2. Populate stack store: setStacks, setActiveStackId\n3. Populate cards with stackId from each card\n4. Populate chat store from chat_history\n5. Persist via Zustand persist (automatic)\n\n**Tests:**\n- [ ] state_sync populates stacks and cards in store\n- [ ] state_sync populates chat history\n- [ ] Subsequent state_sync (reconnect) replaces stale state\n- [ ] Empty state_sync doesn't crash","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:15:02.036349+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T22:47:06.606628+11:00","closed_at":"2026-02-13T22:47:06.606628+11:00","close_reason":"All 5 criteria pass. state_sync populates stacks/cards/chat, reconnect replaces stale state, role mapping handles assistant→agent.","dependencies":[{"issue_id":"stackdocs-m7b.12.14","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:15:02.037505+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.14","depends_on_id":"stackdocs-m7b.12.12","type":"blocks","created_at":"2026-02-13T16:16:58.577082+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.14","depends_on_id":"stackdocs-m7b.12.13","type":"blocks","created_at":"2026-02-13T16:16:58.732779+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.15","title":"Frontend message context (ChatBar + canvas_update handler)","description":"**Goal:** ChatBar sends stack context with every mission; canvas_update handler routes by stack_id.\n\n**Files:** Modify frontend/components/desktop/chat-bar.tsx, ws-provider.tsx\n\n**Steps:**\n1. ChatBar: Include context: { stack_id: activeStackId } in mission payload\n2. canvas_update handler: Read stack_id from payload, set stackId on card\n3. Default to activeStackId if stack_id missing\n4. Cards on inactive stacks created but not visible\n\n**Tests:**\n- [ ] Mission messages include context.stack_id\n- [ ] create_card with stack_id sets correct stackId\n- [ ] create_card without stack_id defaults to activeStackId","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:15:02.212573+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T22:51:37.696315+11:00","closed_at":"2026-02-13T22:51:37.696315+11:00","close_reason":"All 4 criteria pass. ChatBar sends context.stack_id, canvas_update routes by stack_id with activeStackId fallback.","dependencies":[{"issue_id":"stackdocs-m7b.12.15","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:15:02.215017+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.15","depends_on_id":"stackdocs-m7b.12.12","type":"blocks","created_at":"2026-02-13T16:16:58.912197+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.15","depends_on_id":"stackdocs-m7b.12.13","type":"blocks","created_at":"2026-02-13T16:16:59.131351+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.16","title":"Frontend top bar wiring","description":"**Goal:** Wire tab switcher to real stacks from store with CRUD actions via gateway.\n\n**Files:** Modify frontend/components/desktop/desktop-top-bar.tsx\n\n**Steps:**\n1. Read stacks array from store (replace hardcoded tabs)\n2. Build tabs from stacks.map(s =\u003e { value: s.id, label: s.name, dot: s.color })\n3. onValueChange calls setActiveStackId\n4. Plus button sends canvas_interaction: create_stack to Sprite via WS\n5. Close button sends canvas_interaction: archive_stack (cascades to cards)\n6. Handle empty stacks state (loading before state_sync)\n\n**Tests:**\n- [ ] Tabs render from stacks in store (not hardcoded)\n- [ ] Plus button creates new stack via WS → Sprite gateway\n- [ ] Close button archives stack via WS → Sprite gateway\n- [ ] Empty state shows loading indicator","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:15:02.375138+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T22:58:25.792319+11:00","closed_at":"2026-02-13T22:58:25.792319+11:00","close_reason":"All 6 criteria pass. TS clean. Tabs from store, activeStackId wired, plus/close send canvas_interaction to Sprite, loading state.","dependencies":[{"issue_id":"stackdocs-m7b.12.16","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:15:02.376603+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.16","depends_on_id":"stackdocs-m7b.12.13","type":"blocks","created_at":"2026-02-13T16:16:59.285918+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.17","title":"Integration E2E test","description":"**Goal:** Validate the complete refactored flow across all layers.\n\n**Files:** Create bridge/tests/e2e-user-sprite.test.ts\n\n**Steps:**\n1. Browser connects to /ws (no stack ID in URL)\n2. Authenticates with Clerk JWT\n3. Bridge looks up user in users table for sprite mapping\n4. Bridge connects to user Sprite via userId\n5. Sprite sends state_sync with stacks/cards/chat\n6. User sends mission with context.stack_id\n7. Agent creates card with stack_id\n8. canvas_update with stack_id reaches browser\n9. Test multiple browser tabs sharing one Sprite connection\n\n**Tests:**\n- [ ] WS connection to /ws succeeds and authenticates\n- [ ] state_sync received after Sprite connects\n- [ ] Mission with context.stack_id reaches Sprite gateway\n- [ ] Multiple tabs share one Sprite TCP connection\n- [ ] Card lands on correct stack","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:15:02.533098+11:00","created_by":"thebrownproject","updated_at":"2026-02-14T09:25:52.778858+11:00","closed_at":"2026-02-14T09:25:52.778858+11:00","close_reason":"8 E2E tests passing: state_sync, mission context routing, multi-tab sharing, broadcast, cleanup","dependencies":[{"issue_id":"stackdocs-m7b.12.17","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:15:02.53424+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.17","depends_on_id":"stackdocs-m7b.12.7","type":"blocks","created_at":"2026-02-13T16:16:59.42993+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.17","depends_on_id":"stackdocs-m7b.12.9","type":"blocks","created_at":"2026-02-13T16:16:59.584899+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.17","depends_on_id":"stackdocs-m7b.12.10","type":"blocks","created_at":"2026-02-13T16:16:59.878938+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.17","depends_on_id":"stackdocs-m7b.12.11","type":"blocks","created_at":"2026-02-13T16:17:00.077888+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.17","depends_on_id":"stackdocs-m7b.12.14","type":"blocks","created_at":"2026-02-13T16:17:00.24997+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.17","depends_on_id":"stackdocs-m7b.12.15","type":"blocks","created_at":"2026-02-13T16:17:00.406003+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.17","depends_on_id":"stackdocs-m7b.12.16","type":"blocks","created_at":"2026-02-13T16:17:00.568887+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.2","title":"Supabase schema migration (additive)","description":"**Goal:** Move sprite_name/sprite_status to users table, add archive columns to stacks.\n\n**Files:** Create SQL migration file\n\n**Steps:**\n1. Add sprite_name TEXT and sprite_status TEXT to users table\n2. Copy sprite data from existing stacks to user rows\n3. Add status, archived_at, color, sort_order columns to stacks table\n4. Remove sprite_name/sprite_status from stacks table\n\n**Tests:**\n- [ ] users table has sprite_name and sprite_status columns\n- [ ] stacks table has status, archived_at, color, sort_order columns\n- [ ] stacks table no longer has sprite_name or sprite_status\n- [ ] Existing data preserved correctly","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:13:40.3664+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T20:19:30.993302+11:00","closed_at":"2026-02-13T20:19:30.993302+11:00","close_reason":"All 4 test criteria pass. SQL is transaction-wrapped, idempotent, deterministic data copy. SCHEMA.md updated.","dependencies":[{"issue_id":"stackdocs-m7b.12.2","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:13:40.373545+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.3","title":"Bridge core re-key (auth + index + connection store)","description":"**Goal:** Replace stackId with userId in auth, WS route, and connection store. stackId no longer used for Sprite routing.\n\n**Files:**\n- Modify bridge/src/auth.ts\n- Modify bridge/src/index.ts\n- Modify bridge/src/connection-store.ts\n- Update bridge/tests/auth.test.ts, bridge/tests/server.test.ts\n\n**Steps:**\n1. auth.ts: Remove stackId param, query users table, rename lookupStack to lookupUser\n2. index.ts: Change WS route /ws/{stack_id} to /ws, remove stackId from URL\n3. connection-store.ts: Remove stackId from Connection, rename getConnectionsByStack to getConnectionsByUser\n4. Update tests alongside source changes\n\n**Tests:**\n- [ ] authenticateConnection(token) returns AuthResult with userId, no stackId\n- [ ] Auth queries users table (not stacks) for sprite mapping\n- [ ] WS upgrade on /ws succeeds, /ws/{anything} returns 400\n- [ ] getConnectionsByUser(userId) returns correct connections","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:14:03.851867+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T20:34:52.807186+11:00","closed_at":"2026-02-13T20:34:52.807186+11:00","close_reason":"All 4 criteria pass. 128/128 tests, TS compiles clean. auth.ts queries users table, /ws exact match, getConnectionsByUser works.","dependencies":[{"issue_id":"stackdocs-m7b.12.3","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:14:03.854161+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.3","depends_on_id":"stackdocs-m7b.12.1","type":"blocks","created_at":"2026-02-13T16:16:55.541424+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.3","depends_on_id":"stackdocs-m7b.12.2","type":"blocks","created_at":"2026-02-13T16:16:55.709869+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.4","title":"Bridge proxy re-key","description":"**Goal:** Re-key spriteConnections Map and all proxy functions from stackId to userId.\n\n**Files:** Modify bridge/src/proxy.ts + bridge/tests/proxy.test.ts\n\n**Steps:**\n1. Re-key spriteConnections Map from stackId to userId\n2. Rename all function params to userId\n3. Update import getConnectionsByStack to getConnectionsByUser\n4. Update proxy tests\n\n**Tests:**\n- [ ] ensureSpriteConnection(userId, ...) creates and caches connection\n- [ ] forwardToSprite(userId, msg) routes correctly\n- [ ] disconnectSprite(userId) cleans up\n- [ ] broadcastToBrowsers(userId, data) sends to all user connections","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:14:04.146629+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T20:42:04.053742+11:00","closed_at":"2026-02-13T20:42:04.053742+11:00","close_reason":"All 4 criteria pass. 128/128 tests, TS clean. Proxy fully re-keyed from stackId to userId.","dependencies":[{"issue_id":"stackdocs-m7b.12.4","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:14:04.148671+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.4","depends_on_id":"stackdocs-m7b.12.3","type":"blocks","created_at":"2026-02-13T16:16:55.872394+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.5","title":"Bridge reconnect + keepalive re-key","description":"**Goal:** Mechanical rename of stackId to userId in reconnect and keepalive modules.\n\n**Files:** Modify bridge/src/reconnect.ts, bridge/src/keepalive.ts + their tests\n\n**Steps:**\n1. reconnect.ts: Rename stackId params to userId, re-key reconnectStates Map\n2. keepalive.ts: Rename stackId params to userId, re-key timers Map\n3. Update imports and tests\n\n**Tests:**\n- [ ] handleDisconnect(userId, deps) tracks by userId\n- [ ] startKeepalive(userId) / stopKeepalive(userId) manage timers","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:14:04.435333+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T20:51:18.404969+11:00","closed_at":"2026-02-13T20:51:18.404969+11:00","close_reason":"All 4 criteria pass. 128/128 tests, TS clean. Reconnect+keepalive re-keyed, deprecated alias removed.","dependencies":[{"issue_id":"stackdocs-m7b.12.5","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:14:04.436385+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.5","depends_on_id":"stackdocs-m7b.12.4","type":"blocks","created_at":"2026-02-13T16:16:56.034169+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.6","title":"Bridge provisioning per-user","description":"**Goal:** Sprite provisioning per user, status updates to users table.\n\n**Files:** Modify bridge/src/provisioning.ts + bridge/tests/provisioning.test.ts\n\n**Steps:**\n1. provisionSprite(userId) takes userId instead of stackId\n2. generateSpriteName(userId) generates from user ID\n3. updateSpriteStatus writes to users table\n4. Update provisioning tests\n\n**Tests:**\n- [ ] provisionSprite(userId) creates Sprite with user-derived name\n- [ ] updateSpriteStatus writes to users table\n- [ ] Status transitions: pending -\u003e provisioning -\u003e active","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:14:04.643451+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T21:00:16.761709+11:00","closed_at":"2026-02-13T21:00:16.761709+11:00","close_reason":"All 4 criteria pass. 128/128 tests. Provisioning writes to users table, sprite names user-derived.","dependencies":[{"issue_id":"stackdocs-m7b.12.6","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:14:04.645135+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.6","depends_on_id":"stackdocs-m7b.12.2","type":"blocks","created_at":"2026-02-13T16:16:56.197157+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.6","depends_on_id":"stackdocs-m7b.12.3","type":"blocks","created_at":"2026-02-13T16:16:56.341816+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.7","title":"Bridge test verification pass","description":"**Goal:** Ensure all existing Bridge tests pass with the refactored architecture.\n\n**Files:** All 11 files in bridge/tests/\n\n**Steps:**\n1. Run npx vitest run — fix any remaining failures\n2. Check e2e-echo.test.ts for old URL patterns\n3. Verify no stackId-as-routing-key references remain\n4. stackId only appears in protocol payload context\n\n**Tests:**\n- [ ] npx vitest run — 0 failures\n- [ ] No stackId used as Sprite connection key\n- [ ] No getConnectionsByStack imports remain","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:14:04.865739+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T21:01:38.025716+11:00","closed_at":"2026-02-13T21:01:38.025716+11:00","close_reason":"128/128 tests pass, TS clean. Zero stackId references in bridge/src/. Zero getConnectionsByStack imports. Full re-key verified.","dependencies":[{"issue_id":"stackdocs-m7b.12.7","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:14:04.867007+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.7","depends_on_id":"stackdocs-m7b.12.3","type":"blocks","created_at":"2026-02-13T16:16:56.494118+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.7","depends_on_id":"stackdocs-m7b.12.4","type":"blocks","created_at":"2026-02-13T16:16:56.646084+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.7","depends_on_id":"stackdocs-m7b.12.5","type":"blocks","created_at":"2026-02-13T16:16:56.798886+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.7","depends_on_id":"stackdocs-m7b.12.6","type":"blocks","created_at":"2026-02-13T16:16:56.964568+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.8","title":"Sprite WorkspaceDB","description":"**Goal:** Create SQLite database layer with stacks, cards, and chat_messages tables.\n\n**Files:** Create/modify sprite/src/database.py, create sprite/tests/test_database.py\n\n**Steps:**\n1. Create WorkspaceDB class with init(), close() methods\n2. Schema: stacks (id, name, color, sort_order, status, archived_at, created_at), cards (card_id, stack_id, title, blocks JSON, size, status, archived_at, updated_at), chat_messages (id, role, content, timestamp)\n3. Implement CRUD: create_stack, list_stacks (active), list_all_stacks, archive_stack (cascade cards), restore_stack, upsert_card, archive_card, get_cards_by_stack (active), get_all_cards, add_chat_message, get_chat_history\n4. Use aiosqlite, JSON serialization for blocks\n\n**Tests:**\n- [ ] init() creates all 3 tables with status/archived_at\n- [ ] archive_stack cascades to all its cards\n- [ ] restore_stack restores cards too\n- [ ] list_stacks returns active only, list_all_stacks includes archived\n- [ ] get_cards_by_stack returns active only, get_all_cards includes archived","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:14:28.707099+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T21:20:27.932071+11:00","closed_at":"2026-02-13T21:20:27.932071+11:00","close_reason":"All 12 criteria pass. 38/38 tests. WorkspaceDB subclasses _BaseDB, 14 CRUD methods, transactional cascades.","dependencies":[{"issue_id":"stackdocs-m7b.12.8","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:14:28.708918+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.8","depends_on_id":"stackdocs-m7b.12.1","type":"blocks","created_at":"2026-02-13T16:16:57.145055+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.12.9","title":"Sprite state sync","description":"**Goal:** Send state_sync message to browser on new WS connection.\n\n**Files:** Create sprite/src/state_sync.py, modify sprite/src/gateway.py or server.py\n\n**Steps:**\n1. Create build_state_sync_message(db, active_stack_id) function\n2. Query active stacks, active cards, last 50 chat messages\n3. If no stacks exist, create default (\"My Stack\")\n4. Send state_sync as first message after TCP connection\n5. active_stack_id defaults to first stack\n\n**Tests:**\n- [ ] New connection receives state_sync as first message\n- [ ] state_sync contains active stacks and cards\n- [ ] state_sync contains up to 50 recent chat messages\n- [ ] Empty DB creates default stack\n- [ ] Message validates against is_state_sync type guard","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T16:14:28.897237+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T21:38:37.993582+11:00","closed_at":"2026-02-13T21:38:37.993582+11:00","close_reason":"All 6 criteria pass. 10/10 tests. Data conversions handled (timestamp s→ms, id int→str, position defaults). Server integration clean.","dependencies":[{"issue_id":"stackdocs-m7b.12.9","depends_on_id":"stackdocs-m7b.12","type":"parent-child","created_at":"2026-02-13T16:14:28.899183+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.9","depends_on_id":"stackdocs-m7b.12.1","type":"blocks","created_at":"2026-02-13T16:16:57.297906+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.12.9","depends_on_id":"stackdocs-m7b.12.8","type":"blocks","created_at":"2026-02-13T16:16:57.467608+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.13","title":"Voice Integration (Deepgram STT + OpenAI TTS + Persona Orb)","description":"**Goal:** Add bidirectional voice to the desktop chat interface — users speak to the agent (STT) and optionally hear responses (TTS) — with a Persona orb as the visual interaction point.\n\nVoice is a browser I/O layer. Sprite agent stays the brain. Raw audio never touches Bridge or Sprite.\n- STT: Deepgram Nova-3 via browser WebSocket with temporary tokens\n- TTS: OpenAI gpt-4o-mini-tts via Next.js API route proxy\n- Visual: Vercel AI Elements Persona (Rive animation)\n- Two thin API routes, feature-flagged, frontend-only\n\n**Spec:** .space-agents/exploration/planned/2026-02-13-voice-integration/spec.md\n**Plan:** .space-agents/exploration/planned/2026-02-13-voice-integration/plan.md\n\n8 tasks, critical path 6 tasks. Depends on working chat pipeline (m7b.12 complete).","status":"closed","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-14T10:12:47.73923+11:00","created_by":"thebrownproject","updated_at":"2026-02-14T19:55:41.062279+11:00","closed_at":"2026-02-14T19:55:41.062279+11:00","close_reason":"All 8 tasks complete (m7b.13.1-m7b.13.8). 74 tests passing, build clean. Voice integration: Deepgram STT, OpenAI TTS, Zustand state machine, Persona orb, feature-gated.","dependencies":[{"issue_id":"stackdocs-m7b.13","depends_on_id":"stackdocs-m7b","type":"parent-child","created_at":"2026-02-14T10:12:47.740255+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.13.1","title":"Setup — deps, Vitest, Persona, voice-config, feature flag","description":"**Goal:** Install all dependencies, set up test infrastructure, create the feature flag/env validation module, and install the Persona component.\n\n**Files:**\n- Create: frontend/vitest.config.ts\n- Create: frontend/lib/voice-config.ts (isVoiceEnabled + validateVoiceEnv)\n- Create: frontend/components/ai-elements/persona.tsx (via npx ai-elements@latest add persona)\n- Modify: frontend/package.json (@deepgram/sdk, @rive-app/react-canvas, vitest, @testing-library/react, @testing-library/jest-dom, jsdom)\n- Modify: frontend/.env.local (DEEPGRAM_API_KEY, OPENAI_API_KEY, NEXT_PUBLIC_VOICE_ENABLED=false)\n\n**Steps:**\n1. Install npm packages\n2. Create vitest.config.ts with jsdom environment and @ path alias\n3. Create lib/voice-config.ts with isVoiceEnabled() and validateVoiceEnv()\n4. Run npx ai-elements@latest add persona\n5. Add env vars to .env.local\n6. Verify next build succeeds\n7. Measure @rive-app/react-canvas bundle impact\n\n**Tests:**\n- [ ] isVoiceEnabled() returns false when env var missing\n- [ ] isVoiceEnabled() returns true when set to \"true\"\n- [ ] validateVoiceEnv() returns invalid when API keys missing\n- [ ] validateVoiceEnv() returns valid when all keys present\n- [ ] App builds successfully with new deps","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-14T10:12:59.496204+11:00","created_by":"thebrownproject","updated_at":"2026-02-14T17:58:06.115778+11:00","closed_at":"2026-02-14T17:58:06.115778+11:00","close_reason":"All deliverables verified: vitest config, voice-config with feature flag, persona component, env placeholders, 6/6 tests passing, build clean","dependencies":[{"issue_id":"stackdocs-m7b.13.1","depends_on_id":"stackdocs-m7b.13","type":"parent-child","created_at":"2026-02-14T10:12:59.498109+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.13.2","title":"Voice store (Zustand state machine)","description":"**Goal:** Create the central voice state store with enforced state transitions and independent toggles.\n\n**Files:**\n- Create: frontend/lib/stores/voice-store.ts\n\n**Steps:**\n1. Define PersonaState type: 'asleep' | 'idle' | 'listening' | 'thinking' | 'speaking'\n2. Create Zustand store: personaState (default 'asleep'), micEnabled (false), ttsEnabled (false), transcript ('')\n3. Implement VALID_TRANSITIONS map as single source of truth\n4. Actions: setPersonaState() (validates), toggleMic(), toggleTts(), setTranscript(), clearTranscript()\n5. Follow chat-store pattern: flat, no middleware, no persist, named export useVoiceStore\n\n**Valid transitions:** asleep→idle, idle→listening, listening→thinking, listening→idle, thinking→speaking, thinking→idle, speaking→idle, ANY→asleep\n\n**Tests:**\n- [ ] Default state correct (asleep, false, false, '')\n- [ ] Valid transitions succeed\n- [ ] Invalid transitions rejected (asleep→listening, idle→speaking)\n- [ ] Any state → asleep always succeeds\n- [ ] toggleMic/toggleTts flip independently\n- [ ] setTranscript/clearTranscript work","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-14T10:13:09.226928+11:00","created_by":"thebrownproject","updated_at":"2026-02-14T18:10:00.554572+11:00","closed_at":"2026-02-14T18:10:00.554572+11:00","close_reason":"6/6 requirements pass, 24/24 tests pass. Voice store with 5-state machine, valid transitions, toggles, transcript. Minor: commit bundled unrelated changes (not blocking).","dependencies":[{"issue_id":"stackdocs-m7b.13.2","depends_on_id":"stackdocs-m7b.13","type":"parent-child","created_at":"2026-02-14T10:13:09.227901+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.13.3","title":"API routes (Deepgram token + TTS proxy)","description":"**Goal:** Create two authenticated Next.js API routes for voice provider communication.\n\n**Files:**\n- Create: frontend/app/api/voice/deepgram-token/route.ts (~20 lines)\n- Create: frontend/app/api/voice/tts/route.ts (~30 lines)\n\n**Steps:**\n1. Deepgram token route (GET): Clerk auth → validateVoiceEnv → Deepgram SDK grantToken() → return { token, expires_in }\n2. TTS proxy route (POST): Clerk auth → check OPENAI_API_KEY → parse { text } → fetch OpenAI /v1/audio/speech (gpt-4o-mini-tts, fable, mp3) → stream response through\n3. Both: 401 no auth, 503 missing keys, proper errors\n\n**Tests:**\n- [ ] Deepgram: 401 without auth, 503 without key, 200 with token\n- [ ] TTS: 401 without auth, 503 without key, 400 without text, 200 with audio/mpeg\n- [ ] TTS streams response (ReadableStream pass-through)\n- [ ] No API keys in response bodies","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-14T10:13:18.568086+11:00","created_by":"thebrownproject","updated_at":"2026-02-14T18:27:31.420678+11:00","closed_at":"2026-02-14T18:27:31.420678+11:00","close_reason":"4/4 requirements pass, 12/12 tests pass. Deepgram token + TTS proxy routes. Fixed malformed JSON handling per Inspector.","dependencies":[{"issue_id":"stackdocs-m7b.13.3","depends_on_id":"stackdocs-m7b.13","type":"parent-child","created_at":"2026-02-14T10:13:18.569189+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.13.3","depends_on_id":"stackdocs-m7b.13.1","type":"blocks","created_at":"2026-02-14T10:30:09.58745+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.13.4","title":"use-stt hook (Deepgram streaming STT)","description":"**Goal:** Create the speech-to-text hook managing mic capture, Deepgram streaming, and real-time transcript updates.\n\n**Files:**\n- Create: frontend/components/voice/use-stt.ts\n\n**Steps:**\n1. startListening(): fetch temp token from /api/voice/deepgram-token\n2. Request mic via navigator.mediaDevices.getUserMedia({ audio: true })\n3. Create Deepgram client, open streaming WS (nova-3, interim_results, smart_format)\n4. MediaRecorder(stream, { mimeType: 'audio/webm' }), 250ms chunks\n5. On ondataavailable, send to Deepgram connection\n6. On LiveTranscriptionEvents.Transcript, update voice-store.transcript\n7. stopListening(): stop MediaRecorder, stop mic tracks, close Deepgram WS\n8. Handle mic permission denied (set error, don't crash)\n\n**Tests:**\n- [ ] startListening fetches temp token\n- [ ] startListening requests microphone access\n- [ ] Mic permission denied sets error message\n- [ ] Transcript events update voice-store.transcript\n- [ ] stopListening stops tracks and closes connection\n- [ ] Cleanup on unmount","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-14T10:13:28.283601+11:00","created_by":"thebrownproject","updated_at":"2026-02-14T18:57:23.443945+11:00","closed_at":"2026-02-14T18:57:23.443945+11:00","close_reason":"6/6 requirements pass, 6/6 tests pass. use-stt hook with Deepgram nova-3 streaming, MediaRecorder, mic permission handling, unmount cleanup.","dependencies":[{"issue_id":"stackdocs-m7b.13.4","depends_on_id":"stackdocs-m7b.13","type":"parent-child","created_at":"2026-02-14T10:13:28.284428+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.13.4","depends_on_id":"stackdocs-m7b.13.1","type":"blocks","created_at":"2026-02-14T10:30:09.696342+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.13.4","depends_on_id":"stackdocs-m7b.13.2","type":"blocks","created_at":"2026-02-14T10:30:09.808964+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.13.4","depends_on_id":"stackdocs-m7b.13.3","type":"blocks","created_at":"2026-02-14T10:30:09.919043+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.13.5","title":"use-tts hook (OpenAI audio playback)","description":"**Goal:** Create the TTS hook that sends text to proxy, plays audio, manages queue, supports interruption.\n\n**Files:**\n- Create: frontend/components/voice/use-tts.ts\n\n**Steps:**\n1. speak(text): push to queue, set isSpeaking true, call playNext()\n2. playNext(): shift queue → fetch /api/voice/tts → AudioContext.decodeAudioData → createBufferSource → start\n3. source.onended: recursive playNext() until queue empty, then isSpeaking false\n4. interrupt(): source.stop() (try/catch), clear queue, isSpeaking false\n5. AudioContext created lazily on first speak() (iOS Safari user gesture requirement)\n6. playingRef flag prevents race conditions\n\n**Buffering:** Full-response-then-speak for MVP. Sentence chunking deferred.\n\n**Tests:**\n- [ ] speak() calls /api/voice/tts with text\n- [ ] speak() sets isSpeaking true\n- [ ] Multiple speak() calls queue sequentially\n- [ ] interrupt() stops audio and clears queue\n- [ ] After interrupt, isSpeaking is false\n- [ ] AudioContext created lazily","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-14T10:13:37.224125+11:00","created_by":"thebrownproject","updated_at":"2026-02-14T19:07:19.477817+11:00","closed_at":"2026-02-14T19:07:19.477817+11:00","close_reason":"6/6 requirements pass, 50/50 full suite. use-tts hook with AudioContext playback, queue, interrupt, lazy init. No bloat.","dependencies":[{"issue_id":"stackdocs-m7b.13.5","depends_on_id":"stackdocs-m7b.13","type":"parent-child","created_at":"2026-02-14T10:13:37.225438+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.13.5","depends_on_id":"stackdocs-m7b.13.2","type":"blocks","created_at":"2026-02-14T10:30:10.029143+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.13.5","depends_on_id":"stackdocs-m7b.13.3","type":"blocks","created_at":"2026-02-14T10:30:10.143659+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.13.6","title":"Voice provider (React context)","description":"**Goal:** Create the composition layer wiring STT→chat→TTS with state coordination.\n\n**Files:**\n- Create: frontend/components/voice/voice-provider.tsx\n\n**Steps:**\n1. Create VoiceContext with { startVoice, stopVoice, interruptTTS }\n2. startVoice(): set personaState 'listening', call startListening()\n3. stopVoice(): stopListening(), read transcript, send as chat message via WS, clear, set 'thinking'\n4. interruptTTS(): interrupt(), set personaState 'idle'\n5. Subscribe to useChatStore: isAgentStreaming true→false + ttsEnabled → speak(last agent msg), set 'speaking'\n6. Sync WS status → personaState: disconnected→asleep, connected+asleep→idle\n7. isSpeaking false + personaState 'speaking' → transition to 'idle'\n8. Cleanup on unmount: stopListening + interrupt\n9. Export MaybeVoiceProvider (passthrough when isVoiceEnabled() false)\n10. Export useVoice() hook\n\n**Tests:**\n- [ ] STT transcript sent as chat message via WebSocket\n- [ ] Agent completion triggers TTS when ttsEnabled\n- [ ] Agent completion does NOT trigger TTS when ttsEnabled false\n- [ ] PersonaState transitions correctly through full flow\n- [ ] WS disconnected sets personaState asleep\n- [ ] Cleanup on unmount","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-14T10:13:48.365307+11:00","created_by":"thebrownproject","updated_at":"2026-02-14T19:33:53.390576+11:00","closed_at":"2026-02-14T19:33:53.390576+11:00","close_reason":"6/6 requirements pass, 56/56 full suite. Voice provider composing STT+TTS+store, persona orchestration, MaybeVoiceProvider passthrough.","dependencies":[{"issue_id":"stackdocs-m7b.13.6","depends_on_id":"stackdocs-m7b.13","type":"parent-child","created_at":"2026-02-14T10:13:48.366366+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.13.6","depends_on_id":"stackdocs-m7b.13.4","type":"blocks","created_at":"2026-02-14T10:30:10.25291+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.13.6","depends_on_id":"stackdocs-m7b.13.5","type":"blocks","created_at":"2026-02-14T10:30:10.362259+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.13.7","title":"Persona orb component","description":"**Goal:** Create the visual Persona orb with animation state mapping, tap interactions, and toggle buttons.\n\n**Files:**\n- Create: frontend/components/voice/persona-orb.tsx\n\n**Steps:**\n1. Dynamic import Persona with ssr: false (Rive needs WebGL2)\n2. Map personaState to Persona animation states via STATE_MAP record\n3. Tap handler: idle→startVoice, listening→stopVoice, speaking→interruptTTS, asleep→disabled\n4. Mic toggle: GlassIconButton with Microphone/MicrophoneOff icons\n5. TTS toggle: GlassIconButton with Volume/VolumeOff icons\n6. Transcript preview: glass pill above orb, visible when listening + transcript non-empty\n7. Orb sized ~36-48px to fit mic button footprint\n\n**Tests:**\n- [ ] Persona animation reflects personaState\n- [ ] Tap idle→starts voice, listening→stops, speaking→interrupts\n- [ ] Tap asleep→does nothing (disabled)\n- [ ] Mic and TTS toggles independent\n- [ ] Transcript preview shows during listening","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-14T10:13:57.92101+11:00","created_by":"thebrownproject","updated_at":"2026-02-14T19:43:38.8038+11:00","closed_at":"2026-02-14T19:43:38.8038+11:00","close_reason":"5/5 requirements pass, 11/11 tests, 67/67 full suite. Persona orb with tap actions, toggles, transcript preview, dynamic import. Clean.","dependencies":[{"issue_id":"stackdocs-m7b.13.7","depends_on_id":"stackdocs-m7b.13","type":"parent-child","created_at":"2026-02-14T10:13:57.922107+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.13.7","depends_on_id":"stackdocs-m7b.13.1","type":"blocks","created_at":"2026-02-14T10:30:10.467954+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.13.7","depends_on_id":"stackdocs-m7b.13.6","type":"blocks","created_at":"2026-02-14T10:30:10.5774+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.13.8","title":"Chat integration + feature gate","description":"**Goal:** Wire PersonaOrb into chat-bar, wrap desktop page in VoiceProvider, gate behind feature flag.\n\n**Files:**\n- Modify: frontend/components/desktop/chat-bar.tsx\n- Modify: frontend/app/(desktop)/desktop/page.tsx\n\n**Steps:**\n1. chat-bar.tsx: Replace mic GlassIconButton with isVoiceEnabled() ? \u003cPersonaOrb /\u003e : original mic button\n2. chat-bar.tsx: In textarea onChange, if personaState==='listening' call stopVoice() (typing cancels recording)\n3. page.tsx: Nest MaybeVoiceProvider inside WebSocketProvider\n4. Verify icons barrel has Volume/VolumeOff, add if missing\n5. No-regression: Enter-to-send, Shift+Enter, chips, panel toggle all work\n\n**Tests:**\n- [ ] PersonaOrb renders when NEXT_PUBLIC_VOICE_ENABLED=true\n- [ ] Original mic button when NEXT_PUBLIC_VOICE_ENABLED=false\n- [ ] Typing during listening cancels recording\n- [ ] Full E2E: tap→speak→transcript→agent responds→TTS plays\n- [ ] Keyboard chat unchanged (no regression)\n- [ ] VoiceProvider inside WebSocketProvider in page tree","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-14T10:14:07.837471+11:00","created_by":"thebrownproject","updated_at":"2026-02-14T19:55:39.443692+11:00","closed_at":"2026-02-14T19:55:39.443692+11:00","close_reason":"5/5 verifiable requirements pass, 74/74 tests, build clean. Chat integration with PersonaOrb, feature gate, typing-cancels-listening, useVoiceMaybe pattern.","dependencies":[{"issue_id":"stackdocs-m7b.13.8","depends_on_id":"stackdocs-m7b.13","type":"parent-child","created_at":"2026-02-14T10:14:07.838468+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.13.8","depends_on_id":"stackdocs-m7b.13.6","type":"blocks","created_at":"2026-02-14T10:30:10.685123+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.13.8","depends_on_id":"stackdocs-m7b.13.7","type":"blocks","created_at":"2026-02-14T10:30:10.797012+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.14","title":"Connection Stability and Codebase Cleanup","description":"**Goal:** Fix every known connection bug, harden error handling, clean dead code, and add minimum UX for users to understand connection state.\n\n**Spec:** `.space-agents/exploration/ideas/2026-02-21-connection-stability-codebase-cleanup/spec.md`\n**Plan:** `.space-agents/exploration/ideas/2026-02-21-connection-stability-codebase-cleanup/plan.md`\n\n86 requirements across 8 tracks. 15 tasks across 5 waves. ~17-19h with parallelization.\n\n**Tracks:**\n1. Critical connection fixes (bridge)\n2. Auth \u0026 provisioning hardening (bridge)\n3. Frontend connection UX\n4. Frontend state reconciliation\n5. Protocol alignment (bridge + sprite)\n6. Sprite runtime fixes\n7. Database \u0026 performance (sprite)\n8. Dead code \u0026 cleanup (all)\n\n**Success criteria:** Messages survive sleep/wake without drops. First-time users get working Sprite in 15s. Connection status visible. All tests pass. Zero dead code.","status":"closed","priority":1,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-21T10:41:57.726661+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T18:22:23.347605+11:00","closed_at":"2026-02-21T18:22:23.347605+11:00","close_reason":"All 15/15 tasks complete. Connection stability, auth hardening, frontend UX, state reconciliation, protocol alignment, sprite runtime, database optimization, and dead code cleanup all done across 5 waves.","dependencies":[{"issue_id":"stackdocs-m7b.14","depends_on_id":"stackdocs-m7b","type":"parent-child","created_at":"2026-02-21T10:41:57.729357+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.14.1","title":"Bridge Critical Connection Pipeline","description":"**Goal:** Fix the three bugs that cause silent message loss on every reconnection, plus partial-line buffering and timeout fix.\n\n**Wave:** 1 (Foundation)\n**Size:** L\n**Depends on:** None\n\n**Files:**\n- Modify: `bridge/src/proxy.ts`, `bridge/src/reconnect.ts`, `bridge/src/sprite-connection.ts`, `bridge/src/provisioning.ts`\n- Test: `bridge/tests/proxy.test.ts`, `bridge/tests/reconnect.test.ts`, create `bridge/tests/sprite-connection.test.ts`, `bridge/tests/provisioning.test.ts`\n\n**Steps:**\n1. T1.1: Fix reconnect registration gap. After Sprite TCP reconnect, reconnect.ts stores new SpriteConnection in local state but never writes it back to spriteConnections Map in proxy.ts. Add registerConnection callback to ReconnectDeps, call after verify succeeds.\n2. T1.2: Fix socket registration before verify. createAndRegister adds connection to Map before verify() runs. Move registration into caller, after connect succeeds.\n3. T1.3: Fix zombie socket leak. In sprite-connection.ts, error handler after initDone=true calls onError but never this.close(). Add this.close() in post-init error path.\n4. T1.4: Add partial-line buffering. TCP frame splitting produces truncated JSON. Add _lineBuffer field to SpriteConnection, accumulate data, split on newline, keep incomplete last segment.\n5. T1.6: Fix startSpriteServer timeout to reject. In provisioning.ts, 3s timeout calls resolve() even if exec WS never opened. Change to reject.\n\n**Tests:**\n- [ ] After reconnect, getSpriteConnection(userId) returns the new connection\n- [ ] Messages sent after reconnect go through new connection, not buffer\n- [ ] Connection NOT added to spriteConnections until after connect() succeeds; verify both verify-success and verify-failure transitions\n- [ ] Post-init error handler calls close() so zombie sockets cleaned up\n- [ ] Partial JSON split across TCP frames reassembled correctly\n- [ ] Multiple complete messages in one frame all delivered\n- [ ] startSpriteServer timeout path rejects (not resolves)\n- [ ] All existing Bridge tests pass","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T10:43:05.0302+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T11:19:00.819962+11:00","closed_at":"2026-02-21T11:19:00.819962+11:00","close_reason":"8/8 tests pass, 152/152 suite passing. Split createAndRegister, added line buffering, fixed zombie sockets, fixed timeout reject.","dependencies":[{"issue_id":"stackdocs-m7b.14.1","depends_on_id":"stackdocs-m7b.14","type":"parent-child","created_at":"2026-02-21T10:43:05.031906+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.14.10","title":"Sprite Error Handling and I/O Safety","description":"**Goal:** Differentiate SDK error types, guard error paths, offload blocking I/O.\n\n**Wave:** 4 (Errors + Early Cleanup)\n**Size:** M\n**Depends on:** Sprite Gateway and Runtime Hardening (for T6.9/T6.10 which use _is_connected flag and task registry). T6.8 and T6.12 are independent and can start in Wave 3.\n\n**Files:**\n- Modify: `sprite/src/runtime.py`, `sprite/src/gateway.py`\n\n**Steps:**\n1. T6.9: Differentiate SDK error types. Catch RateLimitError, APIConnectionError, AuthenticationError specifically.\n2. T6.10: Guard extraction error path. Wrap _send_error in try/catch for closed-connection case.\n3. T6.8: Offload large file writes to thread. Wrap base64.b64decode() and write_bytes() in asyncio.to_thread() for \u003e1MB. Do NOT wrap mkdir.\n4. T6.12: Add upload path error handling. Base64 decode/write errors uncaught at gateway.py:223. Wrap in try/except.\n\n**Tests:**\n- [ ] Rate limit errors show \"rate limited, please wait\" message\n- [ ] Auth errors show clear \"API key issue\" message\n- [ ] _send_error on dead connection does not cause unhandled task exception\n- [ ] Large file writes (\u003e1MB) run in asyncio.to_thread()\n- [ ] Base64 decode and file write errors caught and reported","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T10:45:15.312897+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T17:18:52.076222+11:00","closed_at":"2026-02-21T17:18:52.076222+11:00","close_reason":"5/5 tests pass (13 new). Error classification, extraction guard, to_thread for \u003e1MB, upload error handling.","dependencies":[{"issue_id":"stackdocs-m7b.14.10","depends_on_id":"stackdocs-m7b.14","type":"parent-child","created_at":"2026-02-21T10:45:15.31604+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.14.10","depends_on_id":"stackdocs-m7b.14.9","type":"blocks","created_at":"2026-02-21T10:46:57.477452+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.14.11","title":"Sprite Database Indexes, Migrations, and Transactions","description":"**Goal:** Add missing indexes, fix error handling, add transaction context manager, fix atomicity, add retention limits.\n\n**Wave:** 1 (Foundation) -- independent, no dependencies\n**Size:** M\n**Depends on:** None\n\n**Files:**\n- Modify: `sprite/src/database.py`, `sprite/src/memory/processor.py`\n\n**Steps:**\n1. T7.1: Add index on observations.processed.\n2. T7.2: Add composite index on cards(stack_id, status).\n3. T7.3: Fix migration error handling. Replace bare except with sqlite3.OperationalError catch.\n4. T7.4: Add transaction context manager to _BaseDB. BEGIN IMMEDIATE / COMMIT / ROLLBACK. Per spec decision, use BEGIN IMMEDIATE for archive_stack and restore_stack.\n5. T7.5: Fix processor cross-DB atomicity. Batch insert learnings with executemany().\n6. T7.6: Add _conn guard. Check _conn is not None. Raise RuntimeError not AttributeError.\n7. T7.7: Optimize get_chat_history. Replace COUNT(*) with cursor-based pagination.\n8. T7.8: Add data retention. Prune on insert: 10k observations, 5k chat_messages, unlimited learnings.\n\n**Tests:**\n- [ ] Index exists on observations.processed (query sqlite_master)\n- [ ] Composite index exists on cards(stack_id, status)\n- [ ] Migration errors catch only sqlite3.OperationalError with \"duplicate column\" check\n- [ ] Transaction context manager commits on success, rolls back on exception\n- [ ] Processor batch inserts in one transaction; simulated crash mid-batch does not produce duplicates\n- [ ] Database methods after close() raise clean RuntimeError\n- [ ] get_chat_history uses cursor-based pagination\n- [ ] Observations pruned to 10k, chat_messages to 5k; newest rows preserved, oldest pruned first","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T10:45:29.696314+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T12:42:39.966934+11:00","closed_at":"2026-02-21T12:42:39.966934+11:00","close_reason":"8/8 tests pass after fix. Indexes, transactions, batch inserts, error handling, cursor pagination, retention pruning all implemented. Reverted frontend changes restored.","dependencies":[{"issue_id":"stackdocs-m7b.14.11","depends_on_id":"stackdocs-m7b.14","type":"parent-child","created_at":"2026-02-21T10:45:29.697881+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.14.12","title":"Bridge Cleanup and Test Fixes","description":"**Goal:** Fix E2E tests, remove fragile patterns, consolidate duplicate code, add missing cleanup and coverage.\n\n**Wave:** 4 (Errors + Early Cleanup)\n**Size:** L\n**Depends on:** Bridge Critical Connection Pipeline. NOTE: T8.14-T8.16, T8.23 only need Task 1. T8.21/T8.8 touch index.ts which Auth Hardening modifies, so wait for that.\n\n**Files:**\n- Modify: `bridge/src/reconnect.ts`, `bridge/src/proxy.ts`, `bridge/src/keepalive.ts`, `bridge/src/sprite-exec.ts`, `bridge/src/index.ts`\n- Test: `bridge/tests/e2e-user-sprite.test.ts`, create `bridge/tests/updater.test.ts`\n\n**Steps:**\n1. T8.14: Fix multi-tab E2E tests. Replace ws.once with message collector.\n2. T8.15: Fix reconnect.ts private field access. Add public replaceMessageHandler() or verifyAlive() method.\n3. T8.16: Break circular dependency proxy.ts \u003c-\u003e keepalive.ts. Accept connection-getter function.\n4. T8.17: Fix sprite-exec.ts stderr filtering. Always log, suppress only known noise.\n5. T8.8: Consolidate duplicate createSystemMessage into shared utility.\n6. T8.22: Fix reconnect to abort when no browsers connected.\n7. T8.21: Add SIGTERM cleanup for sprite connections, keepalive timers, reconnect states. Forced exit timeout.\n8. T8.23: Add checkAndUpdate test coverage for updater.ts.\n\n**Tests:**\n- [ ] Multi-tab E2E tests pass (collect all messages within window)\n- [ ] reconnect.ts uses public method on SpriteConnection\n- [ ] keepalive.ts accepts connection-getter function (no circular import)\n- [ ] sprite-exec.ts logs all stderr, suppresses only known noise\n- [ ] createSystemMessage consolidated into one shared function\n- [ ] Reconnect aborts when no browsers connected\n- [ ] SIGTERM handler cleans up all resources with forced exit timeout\n- [ ] checkAndUpdate has test coverage","status":"closed","priority":3,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T10:45:45.378666+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T17:40:24.138701+11:00","closed_at":"2026-02-21T17:40:24.138701+11:00","close_reason":"All 8 sub-tasks implemented. 177/177 bridge tests passing. Inspector verified 8/8 requirements.","dependencies":[{"issue_id":"stackdocs-m7b.14.12","depends_on_id":"stackdocs-m7b.14","type":"parent-child","created_at":"2026-02-21T10:45:45.380233+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.14.12","depends_on_id":"stackdocs-m7b.14.1","type":"blocks","created_at":"2026-02-21T10:46:57.619719+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.14.13","title":"Frontend Dead Code and File Removal","description":"**Goal:** Remove dead files, dead exports, spike fonts, and demo page.\n\n**Wave:** 5 (Final Cleanup)\n**Size:** M\n**Depends on:** Frontend State Reconciliation\n\n**Files:**\n- Delete: `frontend/app/(app)/test-chat/page.tsx`, `frontend/components/wallpaper/wallpaper-picker.tsx`, `frontend/lib/supabase.ts`, `frontend/lib/supabase-server.ts`, `frontend/hooks/use-mobile.ts`, `frontend/app/(desktop)/cards-demo/page.tsx`\n- Modify: `frontend/types/ws-protocol.ts`, `frontend/lib/websocket.ts`, `frontend/app/layout.tsx`\n\n**Steps:**\n1. T8.1: Remove dead files. Verify zero import references (rg search) before each deletion.\n2. T8.2: Remove dead exports. isBlock()/isBlockArray(), handlers Map + on(), SuggestionChip type. NOTE: useCardsForActiveStack is NOT dead (T4.8 wires it up).\n3. T8.3: Remove spike fonts from layout.tsx. DM_Sans, Plus_Jakarta_Sans, General Sans.\n4. T8.6: Remove cards-demo/page.tsx entirely.\n\n**Tests:**\n- [ ] All listed dead files removed (zero import references confirmed)\n- [ ] Dead exports removed from live files (zero consumers confirmed)\n- [ ] Spike fonts removed from layout.tsx\n- [ ] cards-demo/page.tsx removed\n- [ ] Build passes after all removals","status":"closed","priority":3,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T10:45:58.328992+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T17:48:46.096733+11:00","closed_at":"2026-02-21T17:48:46.096733+11:00","close_reason":"6 dead files deleted, dead exports removed, spike fonts removed, 804 lines deleted. Build clean. Inspector verified 5/5.","dependencies":[{"issue_id":"stackdocs-m7b.14.13","depends_on_id":"stackdocs-m7b.14","type":"parent-child","created_at":"2026-02-21T10:45:58.330191+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.14.13","depends_on_id":"stackdocs-m7b.14.8","type":"blocks","created_at":"2026-02-21T10:46:57.749006+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.14.14","title":"Frontend Lint, Test Fixes, and Minor Cleanup","description":"**Goal:** Fix lint errors blocking CI, fix test failures, consolidate duplicate code, fix minor component issues.\n\n**Wave:** 5 (Final Cleanup)\n**Size:** M\n**Depends on:** Frontend Connection Status and Message Queue, Frontend State Reconciliation. NOTE: ws-provider.tsx items (T8.12, T8.7) need both tasks done. Other items (T8.9, T8.10, T8.13, T8.27, T8.28) are independent.\n\n**Files:**\n- Modify: `frontend/components/desktop/ws-provider.tsx`, `frontend/components/desktop/desktop-card.tsx`, `frontend/components/ui/spinner.tsx`, `frontend/components/ui/glass-card.tsx`, `frontend/hooks/use-file-upload.ts`\n\n**Steps:**\n1. T8.12: Fix frontend lint errors in ws-provider.tsx, persona.tsx, desktop-viewport.tsx, use-momentum.ts.\n2. T8.13: Fix 10 voice/chat test failures. chat-bar visibility/linger + use-stt token/error paths.\n3. T8.7: Consolidate duplicate snake_case-to-camelCase mapping in ws-provider.tsx. Extract shared mapper.\n4. T8.9: Fix TEMPLATE_WIDTHS duplication. Single source of truth.\n5. T8.10: Fix Spinner import. Replace lucide-react with Tabler icons.\n6. T8.28: Fix GlassCard SVG filter reference. Remove dead #glass-blur.\n7. T8.27: Add file upload size validation. 10MB limit (matches Bridge).\n\n**Tests:**\n- [ ] npm run lint passes with zero errors\n- [ ] All voice/chat test failures fixed (10 currently failing)\n- [ ] Snake-to-camelCase mapping extracted to shared mapper\n- [ ] TEMPLATE_WIDTHS single source of truth\n- [ ] Spinner uses Tabler icons\n- [ ] GlassCard SVG filter reference fixed\n- [ ] File upload validates against 10MB limit","status":"closed","priority":3,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T10:46:12.60898+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T18:11:26.315437+11:00","closed_at":"2026-02-21T18:11:26.315437+11:00","close_reason":"7 sub-tasks complete. Lint 61→9 (all remaining out-of-scope). 193/193 tests passing. Inspector verified 7/7.","dependencies":[{"issue_id":"stackdocs-m7b.14.14","depends_on_id":"stackdocs-m7b.14","type":"parent-child","created_at":"2026-02-21T10:46:12.609942+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.14.14","depends_on_id":"stackdocs-m7b.14.6","type":"blocks","created_at":"2026-02-21T10:46:57.879946+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.14.14","depends_on_id":"stackdocs-m7b.14.8","type":"blocks","created_at":"2026-02-21T10:46:58.01018+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.14.15","title":"Sprite Dead Code, Version Pinning, and Docs","description":"**Goal:** Remove dead Sprite code, pin SDK version, add system prompt size bound, fix docs mismatch, fix backend pytest.\n\n**Wave:** 5 (Final Cleanup)\n**Size:** S\n**Depends on:** Sprite Gateway and Runtime Hardening (for T8.4 which removes code from gateway.py that Task 8 modifies). NOTE: T8.11, T8.24, T8.25, T8.26 are independent and can start anytime.\n\n**Files:**\n- Modify: `sprite/src/gateway.py`, `sprite/src/hooks.py`, `sprite/requirements.txt`, `sprite/src/memory/loader.py`\n- Fix: `backend/tests/test_agent_extractor.py`\n\n**Steps:**\n1. T8.4: Remove _check_correction_threshold from gateway.py (lines 68-109). Never called.\n2. T8.5: Clean up dead session_id paths. Remove code that creates/queries dead fields. Leave columns in schema.\n3. T8.11: Fix backend test_agent_extractor.py:25. Stale import. Delete file or update.\n4. T8.24: Pin SDK version to \u003e=0.1.17,\u003c0.2.0.\n5. T8.25: Add system prompt size bounding in memory/loader.py. Cap 50KB. Preserve soul.md/os.md, truncate daemon-managed files.\n6. T8.26: Fix batch threshold docs mismatch. Code says 10, docs say 25. Update docs.\n\n**Tests:**\n- [ ] _check_correction_threshold removed (no test references)\n- [ ] Dead session_id code paths cleaned up\n- [ ] Backend pytest collection succeeds\n- [ ] SDK pinned to \u003e=0.1.17,\u003c0.2.0\n- [ ] Memory loader caps total system prompt size (50KB)\n- [ ] Batch threshold documentation matches code (10)","status":"closed","priority":3,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T10:46:28.847846+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T18:22:17.835204+11:00","closed_at":"2026-02-21T18:22:17.835204+11:00","close_reason":"6 sub-tasks complete. Dead code removed, SDK pinned, 50KB prompt bounding added, docs updated. 258/258 sprite tests passing. Inspector verified 6/6.","dependencies":[{"issue_id":"stackdocs-m7b.14.15","depends_on_id":"stackdocs-m7b.14","type":"parent-child","created_at":"2026-02-21T10:46:28.848947+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.14.15","depends_on_id":"stackdocs-m7b.14.9","type":"blocks","created_at":"2026-02-21T10:46:58.138465+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.14.2","title":"Sprite Ping/Pong, Protocol Types, and Validation","description":"**Goal:** Make Sprite respond to ping with pong (fixes Bridge verification loop), register undocumented message types, align protocol types, add Python context validation.\n\n**Wave:** 2 (Protocol + Auth)\n**Size:** M\n**Depends on:** Bridge Critical Connection Pipeline\n\n**Files:**\n- Modify: `sprite/src/gateway.py`, `sprite/src/protocol.py`, `bridge/src/protocol.ts`, `bridge/src/keepalive.ts`, `frontend/types/ws-protocol.ts`\n- Test: create `sprite/tests/test_gateway_ping.py`, `sprite/tests/test_protocol.py`, `bridge/tests/keepalive.test.ts`\n\n**Steps:**\n1. T1.5: Add ping/pong response to Sprite gateway. When type==\"ping\", respond with pong containing matching id and timestamp. Currently silently dropped, causing Bridge verify to always fail.\n2. T5.1: Add ping, pong, heartbeat, state_sync_request to MESSAGE_TYPES in both protocol.ts, protocol.py, and frontend ws-protocol.ts. Update MessageType Literal in Python.\n3. T5.2: Add mandatory id field (UUID) to keepalive ping messages in keepalive.ts.\n4. T5.4: Replace hand-rolled AgentEventMeta camelCase conversion with systematic snake_case-to-camelCase.\n5. T5.5: Align preview_rows type. Unify to list[list[Any]] in Python.\n6. T5.3: Add context structure validation in Python is_mission_message to match TypeScript strictness.\n\n**Tests:**\n- [ ] Sprite receives ping and responds with pong containing matching id and timestamp\n- [ ] Bridge defaultVerifyServer succeeds without triggering unnecessary server restart\n- [ ] ping, pong, heartbeat, state_sync_request in MESSAGE_TYPES in both TS and Python\n- [ ] Keepalive ping includes mandatory id field (UUID)\n- [ ] AgentEventMeta systematic camelCase conversion handles all fields\n- [ ] preview_rows type matches between TS and Python\n- [ ] Malformed context dict in mission messages is rejected","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T10:43:20.05212+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T12:57:29.884701+11:00","closed_at":"2026-02-21T12:57:29.884701+11:00","close_reason":"7/7 tests pass. Sprite pong, MESSAGE_TYPES aligned, keepalive UUID, systematic camelCase, preview_rows Any, context validation.","dependencies":[{"issue_id":"stackdocs-m7b.14.2","depends_on_id":"stackdocs-m7b.14","type":"parent-child","created_at":"2026-02-21T10:43:20.05361+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.14.2","depends_on_id":"stackdocs-m7b.14.1","type":"blocks","created_at":"2026-02-21T10:46:56.687899+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.14.3","title":"Bridge Platform Crash Fixes (API Proxy)","description":"**Goal:** Fix two critical bugs that can crash the entire Bridge process, affecting all users.\n\n**Wave:** 1 (Foundation)\n**Size:** M\n**Depends on:** None\n\n**Files:**\n- Modify: `bridge/src/api-proxy.ts`\n- Test: `bridge/tests/api-proxy.test.ts`\n\n**Steps:**\n1. T2.10 (spec T8.19 promoted): Add streaming body size limit to collectBody. Count bytes during req.on('data'), abort if over 10MB. Return 413. Do NOT collect-then-check (defeats purpose on 256MB machine).\n2. T2.11 (spec T8.20 promoted): Guard against string[] header values. req.headers['x-api-key'] can be array if duplicate headers. Buffer.byteLength() on array throws TypeError crashing process. Use Array.isArray() check.\n3. T8.18: Move node:crypto from dynamic await import() to static import at file top.\n\n**Tests:**\n- [ ] Body collection rejects payloads over 10MB with 413 status\n- [ ] Duplicate HTTP headers (string[] values) handled gracefully without TypeError\n- [ ] node:crypto is a static import (not dynamic per-request)\n- [ ] All existing API proxy tests pass","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T10:43:31.119125+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T11:27:48.001871+11:00","closed_at":"2026-02-21T11:27:48.001871+11:00","close_reason":"4/4 tests pass, 157/157 suite. Body size limit (10MB/413), header string[] guard, static crypto import.","dependencies":[{"issue_id":"stackdocs-m7b.14.3","depends_on_id":"stackdocs-m7b.14","type":"parent-child","created_at":"2026-02-21T10:43:31.120856+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.14.4","title":"Bridge Auth and Provisioning Hardening","description":"**Goal:** Fix auth flow so first-time users get a working Sprite, add defensive error handling.\n\n**Wave:** 2 (Protocol + Auth)\n**Size:** L\n**Depends on:** Bridge Critical Connection Pipeline\n\n**Files:**\n- Modify: `bridge/src/index.ts`, `bridge/src/auth.ts`, `bridge/src/provisioning.ts`\n- Test: `bridge/tests/server.test.ts`, `bridge/tests/auth.test.ts`\n\n**Steps:**\n1. T2.1: Wire ensureSpriteProvisioned into auth flow. When spriteName is null or spriteStatus is failed/pending, call provisioning.\n2. T2.2: Add validateEnv() function. Check all required env vars before server.listen(). Also increase auth timeout from 10s to 30s per spec decision.\n3. T2.3: Send explicit error to browser when SPRITES_TOKEN undefined.\n4. T2.4: Differentiate auth vs infra errors in auth.ts. Return WS close code 4001 for auth failures, 1011 (standard \"unexpected condition\") for infra failures.\n5. T2.5: Check ws.readyState after async authenticateConnection returns. Auth timeout is 30s (spec decision).\n6. T2.6: Add process.on('unhandledRejection') handler to index.ts.\n7. T2.7: Wrap entire ws.on('message') async callback in try/catch.\n\n**Tests:**\n- [ ] New user with no Sprite triggers provisioning and gets working connection\n- [ ] User with spriteStatus failed/pending triggers re-provisioning\n- [ ] Missing required env vars cause fast failure at startup\n- [ ] Missing SPRITES_TOKEN sends explicit error to browser\n- [ ] Auth errors return WS close code 4001; infra errors return 1011\n- [ ] Auth timeout is 30s (not 10s)\n- [ ] Auth timeout race does not register connection on dead socket\n- [ ] unhandledRejection handler is registered\n- [ ] Async WS message handler errors are caught","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T10:43:49.716+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:08:54.866399+11:00","closed_at":"2026-02-21T13:08:54.866399+11:00","close_reason":"9/9 tests pass, 170/170 suite. Provisioning wired, validateEnv, infra vs auth errors (1011 vs 4001), 30s timeout, readyState guards, unhandledRejection, message handler safety.","dependencies":[{"issue_id":"stackdocs-m7b.14.4","depends_on_id":"stackdocs-m7b.14","type":"parent-child","created_at":"2026-02-21T10:43:49.717072+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.14.4","depends_on_id":"stackdocs-m7b.14.1","type":"blocks","created_at":"2026-02-21T10:46:56.822695+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.14.5","title":"Bridge Build and Dockerfile Fixes","description":"**Goal:** Fix Dockerfile determinism and sprite file access for production builds.\n\n**Wave:** 1 (Foundation) -- independent, no dependencies\n**Size:** S\n**Depends on:** None\n\n**Files:**\n- Modify: `bridge/Dockerfile`, possibly `bridge/src/bootstrap.ts`\n\n**Steps:**\n1. T2.8: Fix Dockerfile sprite file access. Investigate whether bootstrap.ts reads from ../../sprite/ (local filesystem) or uses FS API. If local reads, refactor to FS API exclusively.\n2. T2.9: Add package-lock.json to Dockerfile COPY, change npm install to npm ci --omit=dev.\n\n**Tests:**\n- [ ] docker build succeeds from clean state\n- [ ] docker run passes health check\n- [ ] Dockerfile uses npm ci --omit=dev with lockfile\n- [ ] Sprite source file access from container works","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T10:43:59.365642+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T12:28:25.920653+11:00","closed_at":"2026-02-21T12:28:25.920653+11:00","close_reason":"4/4 tests pass. Dockerfile uses npm ci, sprite files COPY'd, .dockerignore whitelist, getSpriteDir() for env-aware paths.","dependencies":[{"issue_id":"stackdocs-m7b.14.5","depends_on_id":"stackdocs-m7b.14","type":"parent-child","created_at":"2026-02-21T10:43:59.367352+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.14.6","title":"Frontend Connection Status and Message Queue","description":"**Goal:** Add visible connection status indicator, build outgoing message queue, fix optimistic send, handle terminal errors, wire send-failure toasts.\n\n**Wave:** 3 (UX + Runtime)\n**Size:** L\n**Depends on:** Bridge Critical Connection Pipeline, Sprite Ping/Pong and Protocol Types\n\n**Files:**\n- Modify: `frontend/lib/websocket.ts`, `frontend/components/desktop/chat-bar.tsx`\n- Create: status indicator component\n\n**Steps:**\n1. T3.1: Add connection status indicator. Subscribe to WebSocketManager.status (6 states). Suppress transient disconnects \u003c5s.\n2. T3.2: Build in-memory message queue in WebSocketManager. Bounded 100 messages, 60s TTL. send() returns 'sent'|'queued'|'dropped'. Queue flushes on sprite_ready. Two separate buffers (frontend queue for browser-to-Bridge, Bridge buffer for Bridge-to-Sprite) -- document in code comments.\n3. T3.3: Fix chat-bar optimistic send. Check send() return value before adding to store.\n4. T3.4: Handle reconnect_failed system event. Transition to error status with retry guidance.\n5. T3.5: Handle auth rejection (4001) as terminal. Do NOT reconnect.\n6. T3.9: Add Sprite cold-start feedback. Show \"Connecting to your workspace...\" during 1-12s wake.\n7. T3.10: Fix authenticate() fire-and-forget. Wrap getToken() in catch.\n8. T3.7 (partial): Wire send-failure Sonner toasts using send() return value.\n\n**Tests:**\n- [ ] Connection status visible during connecting, authenticating, sprite_waking, error\n- [ ] Transient disconnects \u003c5s show no indicator flicker\n- [ ] Longer outages \u003e5s show visible reconnecting indicator\n- [ ] Messages sent while disconnected are queued (up to 100, max 60s age)\n- [ ] Messages sent during sprite_waking are queued until sprite_ready\n- [ ] send() returns 'sent', 'queued', or 'dropped'\n- [ ] Queue flushes on sprite_ready event\n- [ ] Rapid reconnect churn does not cause duplicate delivery or queue corruption\n- [ ] Queue TTL expiration evicts old messages; max-queue drops oldest first\n- [ ] Chat-bar checks send() result before adding optimistic message\n- [ ] Send-failure toast shown when message is dropped\n- [ ] Auth rejection (4001) transitions to terminal error, no reconnect loop\n- [ ] reconnect_failed transitions to error with retry guidance\n- [ ] Sprite cold-start shows connecting indicator\n- [ ] getToken() failure caught and sets error status","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T10:44:20.100038+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:31:48.071633+11:00","closed_at":"2026-02-21T13:31:48.071633+11:00","close_reason":"15/15 tests pass. Connection status indicator, message queue (100/60s), send result types, terminal 4001, reconnect_failed, auth error handling, send-failure toasts, cold-start UX.","dependencies":[{"issue_id":"stackdocs-m7b.14.6","depends_on_id":"stackdocs-m7b.14","type":"parent-child","created_at":"2026-02-21T10:44:20.102148+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.14.6","depends_on_id":"stackdocs-m7b.14.1","type":"blocks","created_at":"2026-02-21T10:46:56.952273+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.14.6","depends_on_id":"stackdocs-m7b.14.2","type":"blocks","created_at":"2026-02-21T10:46:57.086103+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.14.7","title":"Frontend Error Feedback and Boundaries","description":"**Goal:** Add error boundary, wire Sonner toasts for connection and upload errors, fix invisible error messages.\n\n**Wave:** 2 (no hard dependency, start early)\n**Size:** S\n**Depends on:** None\n\n**Files:**\n- Create: `frontend/app/(desktop)/desktop/error.tsx`\n- Modify: `frontend/components/desktop/chat-panel.tsx`\n\n**Steps:**\n1. T3.6: Create error.tsx in desktop route (Next.js App Router convention). Export default component with { error, reset } props.\n2. T3.7 (partial): Wire Sonner toasts for connection errors and file upload errors. NOTE: send-failure toasts depend on queue send() return value from Frontend Connection Status task; deferred there.\n3. T3.8: Fix system error message visibility in chat-panel.tsx. Change text-[11px] text-white/25 to visible styling.\n\n**Tests:**\n- [ ] error.tsx exists; React crash shows recovery UI instead of white screen\n- [ ] Connection errors and file upload errors trigger visible Sonner toasts\n- [ ] System error messages in chat panel clearly visible (not 11px white/25%)","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T10:44:30.874883+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T12:34:05.146327+11:00","closed_at":"2026-02-21T12:34:05.146327+11:00","close_reason":"3/3 tests pass. Error boundary, WS/upload toasts with dedup, system message visibility fixed.","dependencies":[{"issue_id":"stackdocs-m7b.14.7","depends_on_id":"stackdocs-m7b.14","type":"parent-child","created_at":"2026-02-21T10:44:30.876325+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.14.8","title":"Frontend State Reconciliation","description":"**Goal:** Fix all state_sync correctness issues after reconnect.\n\n**Wave:** 3 (UX + Runtime + State)\n**Size:** L\n**Depends on:** Bridge Critical Connection Pipeline. NOTE: T4.1, T4.2, T4.5, T4.6, T4.7, T4.8 are independent of message queue and can start as soon as Bridge Connection done. Only T4.3 and T4.4 benefit from Frontend Connection Status being done first.\n\n**Files:**\n- Modify: `frontend/components/desktop/ws-provider.tsx`, `frontend/lib/stores/desktop-store.ts`, `frontend/lib/stores/chat-store.ts`, `frontend/app/(desktop)/desktop/page.tsx`\n\n**Steps:**\n1. T4.1: Reset isAgentStreaming on state_sync. Add chat.setAgentStreaming(false) at top of handler.\n2. T4.2: Reconcile archivedStackIds against server state on state_sync.\n3. T4.3: Fix mergeCards to use server state as authoritative. Fix (0,0) sentinel bug with userPositioned flag. Fix local-only card deletion.\n4. T4.4: Preserve user messages during state_sync. Merge by keeping local messages newer than sync timestamp, dedup by id.\n5. T4.5: Add status message handler to ws-provider.tsx switch statement.\n6. T4.6: Remove demo card seeding from production (or gate behind dev flag).\n7. T4.7: Fix clampCardPosition width handling. Pass actual template width.\n8. T4.8: Filter CardLayer by active stack. Wire up useCardsForActiveStack selector.\n\n**Tests:**\n- [ ] isAgentStreaming resets to false on state_sync\n- [ ] archivedStackIds reconciled against server state\n- [ ] mergeCards uses server state as authoritative (no (0,0) sentinel bug)\n- [ ] Local-only cards not silently deleted during merge\n- [ ] Optimistic messages preserved if newer than sync timestamp; dedup by message id handles conflicts\n- [ ] status message type handled in ws-provider switch\n- [ ] Demo cards not seeded in production\n- [ ] clampCardPosition uses actual template width\n- [ ] CardLayer renders only cards for active stack","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T10:44:47.929331+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:17:47.369161+11:00","closed_at":"2026-02-21T13:17:47.369161+11:00","close_reason":"9/9 tests pass. isAgentStreaming reset, archivedStackIds reconciliation, mergeCards userPositioned flag, mergeMessages dedup, status handler, dev-only demo cards, template widths, stack-filtered CardLayer.","dependencies":[{"issue_id":"stackdocs-m7b.14.8","depends_on_id":"stackdocs-m7b.14","type":"parent-child","created_at":"2026-02-21T10:44:47.930606+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.14.8","depends_on_id":"stackdocs-m7b.14.1","type":"blocks","created_at":"2026-02-21T10:46:57.211852+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.14.9","title":"Sprite Gateway and Runtime Hardening","description":"**Goal:** Fix gateway scoping, background task lifecycle, send_fn safety, timeouts, and proper shutdown.\n\n**Wave:** 3 (UX + Runtime)\n**Size:** L\n**Depends on:** Sprite Ping/Pong and Protocol Types\n\n**Files:**\n- Modify: `sprite/src/server.py`, `sprite/src/gateway.py`, `sprite/src/runtime.py`\n\n**Steps:**\n1. T6.1: Move mission_lock to server scope. Create in main(), pass to each SpriteGateway constructor.\n2. T6.2: Add background task registry. Store extraction task handles. Cancel on shutdown/disconnect.\n3. T6.3: Add _is_connected flag to AgentRuntime. Check before every _send_event() call.\n4. T6.4: Guard send_fn swap during reconnect. Add generation counter or async lock.\n5. T6.5: Add await server.wait_closed() after server.close(). Cancel active handlers on SIGINT/SIGTERM.\n6. T6.6: Add 120s readline timeout. Wrap reader.readline() in asyncio.wait_for().\n7. T6.7: Add timeouts to SDK calls. Wrap both _client.query() AND receive_response() in asyncio.wait_for().\n8. T6.11: Fix double SIGTERM. Guard stop.set_result() with if not stop.done().\n\n**Tests:**\n- [ ] mission_lock created once in main() and shared across all gateway instances\n- [ ] Background extraction tasks tracked and cancelled on shutdown/disconnect\n- [ ] _send_event checks is_connected flag; handles disconnect gracefully\n- [ ] send_fn swap uses generation counter; in-flight sends during reconnect do not crash\n- [ ] server.wait_closed() called; active handlers cancelled on shutdown\n- [ ] reader.readline() has 120s timeout\n- [ ] Both _client.query() and receive_response() wrapped in asyncio.wait_for()\n- [ ] Double SIGTERM does not raise InvalidStateError","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T10:45:02.339385+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:41:34.774577+11:00","closed_at":"2026-02-21T13:41:34.774577+11:00","close_reason":"8/8 tests pass. Shared mission_lock, task tracking+cancel, connected guard, generation counter, wait_closed, readline timeout, SDK timeouts, double SIGTERM guard.","dependencies":[{"issue_id":"stackdocs-m7b.14.9","depends_on_id":"stackdocs-m7b.14","type":"parent-child","created_at":"2026-02-21T10:45:02.341701+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.14.9","depends_on_id":"stackdocs-m7b.14.2","type":"blocks","created_at":"2026-02-21T10:46:57.345153+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.15","title":"Demo Readiness — Turn On, Make Work, Make Impressive","description":"**Goal:** Take Stackdocs from \"built but off\" to a working, demoable product.\n\n**Phases:**\n- A: Deploy API keys, remove scaffolding, smoke test (1 day)\n- B1: Extraction tool, table rendering, persistence (1.5-2 days)\n- B2: Markdown chat, welcome flow, CSV export, polish (1 day)\n\n**Prerequisite:** m7b.14 (Connection Stability) must be complete.\n\n**Plan:** .space-agents/mission/staged/demo-readiness-roadmap/plan.md\n**Spec:** .space-agents/mission/staged/demo-readiness-roadmap/spec.md","status":"open","priority":1,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-21T13:40:28.139102+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:40:28.139102+11:00","dependencies":[{"issue_id":"stackdocs-m7b.15","depends_on_id":"stackdocs-m7b","type":"parent-child","created_at":"2026-02-21T13:40:28.14318+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.15.1","title":"Deploy API Keys and Verify Bridge Secrets","description":"**Goal:** Set all required Fly.io secrets so the Bridge can boot and proxy API calls to Sprites.\n\n**Files:**\n- Modify: bridge/src/index.ts (REQUIRED_ENV_VARS array, lines 50-54)\n- Fly.io secrets via CLI\n\n**Steps:**\n1. Add ANTHROPIC_API_KEY, MISTRAL_API_KEY, SPRITES_PROXY_TOKEN, BRIDGE_PUBLIC_URL to REQUIRED_ENV_VARS\n2. Write unit test: validateEnv() throws listing ALL missing vars\n3. flyctl secrets set ANTHROPIC_API_KEY=... MISTRAL_API_KEY=... SPRITES_PROXY_TOKEN=... BRIDGE_PUBLIC_URL=https://ws.stackdocs.io\n4. Deploy and verify health endpoint\n5. Check logs for no secret leakage\n6. Document rollback commands\n\n**Tests:**\n- [ ] validateEnv() throws when ANTHROPIC_API_KEY is missing\n- [ ] validateEnv() throws when MISTRAL_API_KEY is missing\n- [ ] Error lists ALL missing vars, not just first\n- [ ] Health endpoint returns OK after deploy\n- [ ] No secret values in Bridge logs","status":"open","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T13:40:38.564887+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:40:38.564887+11:00","dependencies":[{"issue_id":"stackdocs-m7b.15.1","depends_on_id":"stackdocs-m7b.15","type":"parent-child","created_at":"2026-02-21T13:40:38.565961+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.15.10","title":"Add Welcome Message for New Users","description":"**Goal:** New users receive an agent-generated greeting explaining Stackdocs capabilities.\n\n**Files:**\n- Modify: sprite/src/gateway.py (welcome check after state_sync)\n\n**Steps:**\n1. In _handle_state_sync_request(), after sending state_sync, check if chat history empty\n2. If empty + runtime available, fire asyncio.create_task(_send_welcome_message())\n3. Welcome prompt: agent greets user, explains capabilities (2-3 sentences, no card creation)\n4. Use mission_lock to prevent race with user messages\n5. Do NOT block state_sync\n\n**Tests:**\n- [ ] New user (empty chat) receives welcome within 5 seconds\n- [ ] Existing user does NOT receive welcome\n- [ ] Welcome appears as normal agent message","status":"open","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T13:41:46.879315+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:41:46.879315+11:00","dependencies":[{"issue_id":"stackdocs-m7b.15.10","depends_on_id":"stackdocs-m7b.15","type":"parent-child","created_at":"2026-02-21T13:41:46.880988+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.15.11","title":"Wire CSV and JSON Export from Table Cards","description":"**Goal:** Users can download table card data as CSV or JSON files.\n\n**Files:**\n- Create: frontend/lib/export.ts\n- Modify: frontend/components/desktop/cards/table-card.tsx (export buttons)\n\n**Steps:**\n1. Create export.ts with exportAsCSV and exportAsJSON utilities\n2. CSV: headers + data rows, escaped values\n3. JSON: JSON.stringify with formatting\n4. Both use Blob + object URL + temporary anchor for download\n5. Add buttons to TableCard or card overlay\n6. Disable buttons when no data\n\n**Tests:**\n- [ ] CSV export produces valid CSV\n- [ ] JSON export produces valid JSON\n- [ ] Sensible filenames\n- [ ] Buttons disabled when no data","status":"open","priority":3,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T13:41:52.014742+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:41:52.014742+11:00","dependencies":[{"issue_id":"stackdocs-m7b.15.11","depends_on_id":"stackdocs-m7b.15","type":"parent-child","created_at":"2026-02-21T13:41:52.0159+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.15.11","depends_on_id":"stackdocs-m7b.15.7","type":"blocks","created_at":"2026-02-21T16:33:01.256103+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.15.12","title":"UX Polish Pass on Extraction Flow","description":"**Goal:** Polish loading states, error messages, and transitions during extraction.\n\n**Files:**\n- Modify: sprite/src/gateway.py (error messages)\n- Modify: frontend/components/desktop/block-renderer.tsx (badge rendering)\n- Modify: sprite/src/tools/extraction.py (type_badge)\n\n**Steps:**\n1. Verify Processing badge animates (add animation if static)\n2. Make extraction failure errors user-friendly (not raw Python traceback)\n3. Add Invoice type badge for visual identification\n4. Verify badge variant colors (default, success, warning, destructive)\n5. Ensure smooth card transition from processing to data\n\n**Tests:**\n- [ ] Processing card shows animated indicator\n- [ ] Failed extraction shows human-readable error\n- [ ] Badge variants render correct colors\n- [ ] Smooth card transition","status":"open","priority":3,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T13:41:57.366737+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:41:57.366737+11:00","dependencies":[{"issue_id":"stackdocs-m7b.15.12","depends_on_id":"stackdocs-m7b.15","type":"parent-child","created_at":"2026-02-21T13:41:57.368398+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.15.12","depends_on_id":"stackdocs-m7b.15.7","type":"blocks","created_at":"2026-02-21T16:33:01.368102+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.15.12","depends_on_id":"stackdocs-m7b.15.9","type":"blocks","created_at":"2026-02-21T16:33:01.526002+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.15.2","title":"Security Baseline and Scaffolding Removal","description":"**Goal:** Remove dev scaffolding, verify security baseline for external access.\n\n**Files:**\n- Modify: frontend/app/(desktop)/desktop/page.tsx (remove DEMO_CARDS, lines 43-67)\n- Verify: bridge/src/api-proxy.ts (proxy token validation)\n- Verify: bridge/src/index.ts (routes audit)\n\n**Steps:**\n1. Remove DEMO_CARDS constant and seeding useEffect from desktop/page.tsx\n2. Remove unused imports (setCards, DesktopCardType)\n3. Verify api-proxy.ts enforces proxy token validation via timingSafeEqual\n4. Audit Bridge routes: only /health, /v1/proxy/*, /ws should exist\n5. Verify frontend production build succeeds cleanly\n\n**Tests:**\n- [ ] No DEMO_CARDS references in production desktop page\n- [ ] npm run build in frontend/ succeeds without unused variable warnings\n- [ ] API proxy returns 401 for missing/invalid token\n- [ ] No dev-only routes exist beyond /health, /v1/proxy/*, /ws","status":"open","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T13:40:45.198764+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:40:45.198764+11:00","dependencies":[{"issue_id":"stackdocs-m7b.15.2","depends_on_id":"stackdocs-m7b.15","type":"parent-child","created_at":"2026-02-21T13:40:45.199579+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.15.3","title":"Fix Card Close to Send canvas_interaction","description":"**Goal:** Card close button sends archive_card to Sprite for persistence (optimistic UI removal).\n\n**Files:**\n- Modify: frontend/components/desktop/desktop-card.tsx (handleClose, lines 177-183)\n- Check: frontend/components/desktop/cards/base-card.tsx (template card close)\n\n**Steps:**\n1. In handleClose, after removeCard (optimistic), send canvas_interaction with action archive_card\n2. send function available from useWebSocket() already imported\n3. Add send to useCallback deps\n4. Check if template cards have separate close buttons in BaseCard — apply same fix if so\n5. Verify Sprite-side archive_card handler exists in gateway.py\n\n**Tests:**\n- [ ] Close removes card from viewport immediately (optimistic)\n- [ ] Close sends canvas_interaction with archive_card via WebSocket\n- [ ] Card does NOT reappear after reconnection\n- [ ] Close works for both template and generic cards","status":"open","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T13:40:51.126836+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:40:51.126836+11:00","dependencies":[{"issue_id":"stackdocs-m7b.15.3","depends_on_id":"stackdocs-m7b.15","type":"parent-child","created_at":"2026-02-21T13:40:51.127668+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.15.4","title":"End-to-End Smoke Test","description":"**Goal:** Validate Phase A gate: auth, chat, Canvas all work end-to-end.\n\n**Files:**\n- Create: scripts/smoke-test.ts\n- Manual checklist\n\n**Steps:**\n1. Write smoke test script (ws library, connect, auth, mission, wait for agent_event)\n2. Gate behind SMOKE_TEST=1 env var\n3. Run manual smoke test: sign up, connect, chat, card create, card close\n4. Document failures as bugs\n\n**Tests:**\n- [ ] New user sign-up completes without errors\n- [ ] Agent responds to \"hello\" within 10 seconds\n- [ ] Agent can create a Canvas card via tool call\n- [ ] No hardcoded demo data appears\n- [ ] Scripted smoke test exits 0 on success","status":"open","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T13:41:02.089048+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:41:02.089048+11:00","dependencies":[{"issue_id":"stackdocs-m7b.15.4","depends_on_id":"stackdocs-m7b.15","type":"parent-child","created_at":"2026-02-21T13:41:02.090078+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.15.4","depends_on_id":"stackdocs-m7b.15.1","type":"blocks","created_at":"2026-02-21T16:33:00.576545+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.15.4","depends_on_id":"stackdocs-m7b.15.2","type":"blocks","created_at":"2026-02-21T16:33:00.697916+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.15.4","depends_on_id":"stackdocs-m7b.15.3","type":"blocks","created_at":"2026-02-21T16:33:00.80823+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.15.5","title":"Install poppler-utils in Sprite Bootstrap","description":"**Goal:** Ensure pdftotext is available on Sprites for PDF text extraction.\n\n**Files:**\n- Modify: bridge/src/bootstrap.ts (apt-get step, line 172-174; CURRENT_VERSION)\n\n**Steps:**\n1. Add poppler-utils to apt-get install command in bootstrap.ts\n2. Bump CURRENT_VERSION to trigger lazy update on existing Sprites\n3. Note: lazy updater only deploys code, not apt packages. For existing Sprites, either extend updater with one-time apt-get or manually install via exec.\n\n**Tests:**\n- [ ] Bootstrap apt-get command includes poppler-utils\n- [ ] CURRENT_VERSION is bumped\n- [ ] On fresh Sprite, which pdftotext returns a path\n- [ ] Existing Bridge tests still pass","status":"open","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T13:41:08.114585+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:41:08.114585+11:00","dependencies":[{"issue_id":"stackdocs-m7b.15.5","depends_on_id":"stackdocs-m7b.15","type":"parent-child","created_at":"2026-02-21T13:41:08.116398+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.15.6","title":"Build Extraction Tool for Invoice Processing","description":"**Goal:** Create a structured extraction tool the agent calls after reading a PDF, outputting invoice data to a table card.\n\n**Files:**\n- Create: sprite/src/tools/extraction.py\n- Modify: sprite/src/gateway.py (_run_extraction prompt)\n- Modify: sprite/src/runtime.py (register tool)\n- Modify: bridge/src/bootstrap.ts (add to srcFiles)\n- Create: sprite/tests/test_extraction_tools.py\n\n**Steps:**\n1. Write tests first: tool validates inputs, creates table card, persists to DB\n2. Create extraction.py following tool factory pattern from canvas.py\n3. Implement extract_invoice tool: accepts vendor, date, line_items, subtotal, tax, grand_total\n4. Build blocks: HeadingBlock + KeyValueBlock + TableBlock + BadgeBlock\n5. CRITICAL: Set BOTH blocks AND headers/preview_rows on CanvasUpdatePayload\n6. Update _run_extraction prompt to guide agent to use extract_invoice\n7. Register tool in runtime.py\n8. Add to bootstrap srcFiles list\n9. Handle line_items arriving as JSON string\n\n**Schema:** vendor, date, line_items (description, quantity, unit_price, total), subtotal, tax, grand_total\n\n**Tests:**\n- [ ] extract_invoice validates required inputs (file_path, vendor)\n- [ ] Creates table card with correct columns\n- [ ] Sets both blocks and preview_rows\n- [ ] Persists card to workspace.db\n- [ ] Handles line_items as JSON string\n- [ ] Returns error (not crash) for empty inputs","status":"open","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T13:41:18.096903+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:41:18.096903+11:00","dependencies":[{"issue_id":"stackdocs-m7b.15.6","depends_on_id":"stackdocs-m7b.15","type":"parent-child","created_at":"2026-02-21T13:41:18.099046+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.15.6","depends_on_id":"stackdocs-m7b.15.5","type":"blocks","created_at":"2026-02-21T16:33:00.921618+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.15.7","title":"Wire Table Card Rendering for Extracted Data","description":"**Goal:** Verify extracted invoice data renders correctly in both collapsed (TableCard) and expanded (BlockRenderer) views.\n\n**Files:**\n- Verify: frontend/components/desktop/cards/table-card.tsx\n- Verify: frontend/components/desktop/block-renderer.tsx\n- Possibly modify extraction tool for format alignment\n\n**Steps:**\n1. Verify TableCard reads card.headers and card.previewRows for collapsed view\n2. Verify BlockRenderer handles TableBlock with columns/rows for expanded view\n3. Test with real extraction output\n4. Add empty-state handling to TableCard (fallback to blocks if no headers/rows)\n5. Verify column/row data types match\n\n**Tests:**\n- [ ] TableCard collapsed view shows headers and row data\n- [ ] Expanded overlay shows full table via BlockRenderer\n- [ ] Empty table shows appropriate fallback\n- [ ] Columns align with data","status":"open","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T13:41:28.372634+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:41:28.372634+11:00","dependencies":[{"issue_id":"stackdocs-m7b.15.7","depends_on_id":"stackdocs-m7b.15","type":"parent-child","created_at":"2026-02-21T13:41:28.374033+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.15.7","depends_on_id":"stackdocs-m7b.15.6","type":"blocks","created_at":"2026-02-21T16:33:01.035181+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.15.8","title":"Verify Extraction Persistence Across Reconnection","description":"**Goal:** Confirm extracted data cards survive Sprite sleep/wake and browser reconnects.\n\n**Files:**\n- Verify: sprite/src/state_sync.py\n- Verify: sprite/src/database.py\n- Verify: frontend/components/desktop/ws-provider.tsx\n\n**Steps:**\n1. Extract an invoice, see table card\n2. Close browser tab, reopen /desktop\n3. Card should reappear via state_sync with all data\n4. Check blocks stored as JSON text in workspace.db via _serialize_block()\n5. Verify snake_case to camelCase mapping in frontend\n\n**Tests:**\n- [ ] After extraction, disconnect and reconnect — card reappears with same data\n- [ ] state_sync includes extraction card with blocks\n- [ ] Frontend correctly maps snake_case to camelCase","status":"open","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T13:41:33.31346+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:41:33.31346+11:00","dependencies":[{"issue_id":"stackdocs-m7b.15.8","depends_on_id":"stackdocs-m7b.15","type":"parent-child","created_at":"2026-02-21T13:41:33.314354+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.15.8","depends_on_id":"stackdocs-m7b.15.7","type":"blocks","created_at":"2026-02-21T16:33:01.147316+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.15.9","title":"Add Markdown Rendering to Chat Messages","description":"**Goal:** Agent messages render markdown (headings, bold, code blocks, lists).\n\n**Files:**\n- Modify: frontend/components/desktop/chat-panel.tsx (MessageBubble)\n- Install: react-markdown + remark-gfm\n- Check: @tailwindcss/typography\n\n**Steps:**\n1. npm install react-markdown remark-gfm\n2. Check if @tailwindcss/typography installed, add if not\n3. Replace \u003cp\u003e with ReactMarkdown for agent messages\n4. Wrap in prose prose-invert prose-sm max-w-none for dark theme\n5. Keep user messages as plain text\n\n**Tests:**\n- [ ] **bold** renders as bold\n- [ ] # Heading renders as heading\n- [ ] Code blocks render with monospace font\n- [ ] - list items render as bullets\n- [ ] No layout overflow in chat panel","status":"open","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-21T13:41:38.414019+11:00","created_by":"thebrownproject","updated_at":"2026-02-21T13:41:38.414019+11:00","dependencies":[{"issue_id":"stackdocs-m7b.15.9","depends_on_id":"stackdocs-m7b.15","type":"parent-child","created_at":"2026-02-21T13:41:38.414894+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.2","title":"Phase 1: Infrastructure Scaffold","description":"Build the message pipeline: Browser → Bridge → Sprite → Bridge → Browser. 8 tasks.","status":"closed","priority":0,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:17:10.256359+11:00","created_by":"thebrownproject","updated_at":"2026-02-07T20:49:14.333376+11:00","closed_at":"2026-02-07T20:49:14.333376+11:00","close_reason":"All 9 tasks complete. Bridge deployed to Fly.io, wss://ws.stackdocs.io live, 84 tests passing, protocol defined, Sprites client built, provisioning + bootstrap + lazy update, reconnect + keepalive, Supabase migrated.","dependencies":[{"issue_id":"stackdocs-m7b.2","depends_on_id":"stackdocs-m7b","type":"parent-child","created_at":"2026-02-06T15:17:10.257193+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.2.1","title":"Define WebSocket message protocol","description":"**Goal:** Establish the shared contract between Bridge, Sprite, and Frontend — all message types with TypeScript and Python definitions.\n**Files:** Create `bridge/src/protocol.ts`, create `frontend/types/ws-protocol.ts`, create `sprite/src/protocol.py`\n**Depends on:** None\n\n**Steps:**\n1. Define all message interfaces from spec: WebSocketMessage (base), MissionMessage, FileUploadMessage, CanvasInteraction, AuthConnect, AgentEvent, CanvasUpdate, StatusUpdate, SystemMessage\n2. Include mandatory `id` (UUID), `timestamp`, optional `request_id` on every message\n3. Define `Block` union type (8 MVP types): `heading`, `stat`, `key-value`, `table`, `badge`, `progress`, `text`, `separator` — each block has mandatory `id` and `type`\n4. `CanvasUpdate` uses card commands: `create_card`, `update_card`, `close_card` with `card_id` and `blocks: Block[]`\n5. `CanvasInteraction` uses `card_id` + optional `block_id` for targeted interactions\n6. TypeScript types in `bridge/src/protocol.ts` (source of truth)\n7. Copy types to `frontend/types/ws-protocol.ts`\n8. Python dataclasses in `sprite/src/protocol.py` matching the same schema\n9. Include message validation helpers (type guard functions)\n\n**Tests:**\n- [ ] `tsc --noEmit` passes for `bridge/src/protocol.ts` and `frontend/types/ws-protocol.ts`\n- [ ] `python -c \"from src.protocol import *\"` succeeds in `sprite/`\n- [ ] Type guard functions return `true` for valid messages, `false` for malformed\n- [ ] Every message type includes `id` (UUID) and `timestamp` fields\n- [ ] `Block` union covers all 8 MVP types with correct props\n- [ ] `CanvasUpdate` uses `create_card`/`update_card`/`close_card` commands with `blocks` array\n- [ ] TypeScript and Python definitions cover identical message types","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:18:46.853241+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T22:49:57.629751+11:00","closed_at":"2026-02-06T22:49:57.629751+11:00","close_reason":"Protocol types implemented: bridge/src/protocol.ts (TS source of truth), frontend/types/ws-protocol.ts (frontend copy), sprite/src/protocol.py (Python dataclasses). All 8 message types, 8 block types, mandatory id/timestamp, type guards. tsc and python imports pass.","dependencies":[{"issue_id":"stackdocs-m7b.2.1","depends_on_id":"stackdocs-m7b.2","type":"parent-child","created_at":"2026-02-06T15:18:46.854343+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.2.2","title":"Create Bridge project scaffold and WS server","description":"**Goal:** Fly.io Bridge service that accepts WebSocket connections from browsers with Clerk JWT auth.\n**Files:** Create `bridge/` directory: `package.json`, `tsconfig.json`, `Dockerfile`, `fly.toml`, `src/index.ts`, `src/auth.ts`\n**Depends on:** Define WebSocket message protocol\n\n**Steps:**\n1. Initialize `bridge/` with Node.js project: `ws`, `@clerk/backend`, `@supabase/supabase-js`, `uuid` deps\n2. Create HTTP server that upgrades to WebSocket on `/ws/{stack_id}`\n3. First message must be `type: 'auth'` with Clerk JWT — validate with `@clerk/backend` `verifyToken()`\n4. Extract `user_id` from JWT, associate with connection\n5. Invalid/missing token closes connection with code 4001\n6. Look up stack from Supabase `stacks` table, verify user_id owns it\n7. Store connection mapping: `Map\u003cconnectionId, { userId, stackId, spriteName }\u003e`\n8. Create Dockerfile and `fly.toml` for deployment (256MB RAM, shared CPU)\n\n**Tests:**\n- [ ] `npm test` passes in `bridge/`\n- [ ] WS client connects to `/ws/{stack_id}` and receives upgrade\n- [ ] Invalid JWT → connection closed with code 4001\n- [ ] Valid JWT → connection stored in map with correct userId/stackId\n- [ ] Unauthorized stack_id (wrong user) → connection closed with code 4003\n- [ ] `docker build` succeeds for Bridge Dockerfile","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:19:28.228352+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T23:00:24.268707+11:00","closed_at":"2026-02-06T23:00:24.268707+11:00","close_reason":"Bridge scaffold complete: HTTP server with WS upgrade on /ws/{stack_id}, Clerk JWT auth (4001/4003 codes), Supabase stack lookup, connection tracking map. 26/26 tests pass, tsc clean. Dockerfile + fly.toml for Fly.io deployment.","dependencies":[{"issue_id":"stackdocs-m7b.2.2","depends_on_id":"stackdocs-m7b.2","type":"parent-child","created_at":"2026-02-06T15:19:28.230592+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.2.2","depends_on_id":"stackdocs-m7b.1.1","type":"blocks","created_at":"2026-02-06T15:23:13.700643+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.2.2","depends_on_id":"stackdocs-m7b.2.1","type":"blocks","created_at":"2026-02-06T15:23:19.846497+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.2.3","title":"Create Sprites API client and provisioning","description":"**Goal:** Bridge can provision new Sprites from golden checkpoint and manage their lifecycle.\n**Files:** Create `bridge/src/sprites-client.ts`, `bridge/src/provisioning.ts`\n**Depends on:** Create Bridge project scaffold and WS server\n\n**Phase 0 Finding:** Services API has bug (400 in v0.0.1-rc31). Server started via `exec` WS with `max_run_after_disconnect=0` instead. API keys injected as env vars via exec command.\n\n**Steps:**\n1. Create Sprites.dev REST API client: create sprite (from checkpoint), get status, exec command, TCP proxy, checkpoints\n2. Implement lazy provisioning: when `sprite_status: pending`, create Sprite from golden checkpoint\n3. Update Supabase `stacks` row: `pending` → `provisioning` → `active` with `sprite_name`\n4. Start Python WS server via exec WS with `max_run_after_disconnect=0`, injecting API keys as env vars (`ANTHROPIC_API_KEY`, `MISTRAL_API_KEY`)\n5. Handle provisioning failures: mark as `failed`, allow retry on next connect\n6. Handle already-active sprites: just connect (server is already running — persists through sleep/wake)\n\n**Tests:**\n- [ ] Unit tests for API client methods pass (mocked HTTP responses)\n- [ ] Provisioning flow: `pending` → `provisioning` → `active` updates Supabase correctly\n- [ ] Provisioning failure: status set to `failed`, retry on next connect works\n- [ ] Already-active sprite: skips provisioning, connects directly\n- [ ] API keys injected as env vars via exec command (verified in exec params)\n- [ ] Server started via exec WS with `max_run_after_disconnect=0`","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:19:32.446236+11:00","created_by":"thebrownproject","updated_at":"2026-02-07T10:39:49.428808+11:00","closed_at":"2026-02-07T10:39:49.428808+11:00","close_reason":"Sprites API client + provisioning implemented. 55/55 tests pass. Inspector PASS 6/6.","dependencies":[{"issue_id":"stackdocs-m7b.2.3","depends_on_id":"stackdocs-m7b.2","type":"parent-child","created_at":"2026-02-06T15:19:32.447142+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.2.3","depends_on_id":"stackdocs-m7b.2.2","type":"blocks","created_at":"2026-02-06T15:23:19.963401+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.2.4","title":"Create golden checkpoint on Sprites.dev","description":"**Goal:** Template Sprite with Python environment, packages, and directory structure ready for cloning.\n**Files:** Create `docs/ops/golden-checkpoint.md` (procedure), external Sprites.dev work\n**Depends on:** None (but needs Sprites.dev account from Phase 0)\n\n**Phase 0 Finding:** Server started via `exec` WS with `max_run_after_disconnect=0` persists through sleep/wake. Services API has bug (400) and is NOT needed for server lifecycle. Golden checkpoint should include the server code but NOT a pre-registered service.\n\n**Steps:**\n1. Create base Sprite on Sprites.dev\n2. Install Python packages: `websockets`, `aiosqlite`, `anthropic`, `claude-agent-sdk`, `mistralai`, `httpx`\n3. Create `/workspace/` directory structure: `documents/`, `ocr/`, `artifacts/`, `memory/`, `transcripts/`\n4. Initialize empty SQLite database at `/workspace/agent.db` with full schema from spec\n5. Create memory file templates: `soul.md`, `user.md`, `MEMORY.md`\n6. Deploy sprite/ source code to `/workspace/src/` on Sprite\n7. Save as golden checkpoint\n8. Document the exact procedure in `docs/ops/golden-checkpoint.md`\n9. Test: clone checkpoint, verify packages and dirs exist\n10. Document server startup strategy: Bridge starts server via `exec` WS with `max_run_after_disconnect=0` on first connect (NOT via Services API)\n\n**Tests:**\n- [ ] Clone checkpoint → `python -c \"import websockets, aiosqlite, anthropic, mistralai, httpx\"` succeeds\n- [ ] `/workspace/` dirs exist: `documents/`, `ocr/`, `artifacts/`, `memory/`, `transcripts/`\n- [ ] `/workspace/agent.db` has correct schema (all tables from spec)\n- [ ] Memory templates exist: `soul.md`, `user.md`, `MEMORY.md`\n- [ ] `/workspace/src/` contains sprite source code\n- [ ] `docs/ops/golden-checkpoint.md` documents full procedure + exec startup strategy","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:19:37.121674+11:00","created_by":"thebrownproject","updated_at":"2026-02-07T19:31:08.884058+11:00","closed_at":"2026-02-07T19:31:08.884058+11:00","close_reason":"Updater wired into proxy, DRY fix (shared deployCode), docs written, 79/79 tests passing","dependencies":[{"issue_id":"stackdocs-m7b.2.4","depends_on_id":"stackdocs-m7b.2","type":"parent-child","created_at":"2026-02-06T15:19:37.122592+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.2.4","depends_on_id":"stackdocs-m7b.1.1","type":"blocks","created_at":"2026-02-06T15:23:13.585179+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.2.5","title":"Create Sprite Python WebSocket server","description":"**Goal:** Minimal Python WebSocket server on Sprite that accepts Bridge TCP Proxy connections and routes messages.\n**Files:** Create `sprite/` directory: `requirements.txt`, `src/__init__.py`, `src/server.py`, `src/gateway.py`\n**Depends on:** Create golden checkpoint on Sprites.dev\n\n**Phase 0 Finding:** Sprites.dev freezes processes on sleep (checkpoint/CRIU, same PID on wake). Server started via `exec` WebSocket with `max_run_after_disconnect=0` persists indefinitely through sleep/wake cycles. Services API NOT needed.\n\n**Steps:**\n1. Initialize `sprite/` with Python project: `websockets`, `aiosqlite`, `anthropic`, `claude-agent-sdk`, `mistralai`, `httpx`\n2. Create `src/server.py`: WebSocket server on port 8765 using `websockets` library\n3. Create `src/gateway.py`: `SpriteGateway` class with `match/case` routing by message type\n4. Route: `mission` (async lock), `file_upload` (concurrent), `canvas_interaction` (concurrent), `heartbeat` (async lock), `system`\n5. Stub all handlers to log and echo acknowledgment\n6. Wire server to gateway: incoming messages → `gateway.route(message)`\n7. Server startup: via Sprites `exec` WS with `max_run_after_disconnect=0` (NOT Services API)\n\n**Tests:**\n- [ ] `python -m pytest sprite/tests/` passes\n- [ ] WS client connects to `ws://localhost:8765` successfully\n- [ ] Sending each message type returns echo acknowledgment\n- [ ] Unknown message type logs warning and does not crash\n- [ ] Gateway routes `mission` and `heartbeat` through async lock (verified by concurrent test)","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:19:40.765344+11:00","created_by":"thebrownproject","updated_at":"2026-02-07T12:12:35.508918+11:00","closed_at":"2026-02-07T12:12:35.508918+11:00","close_reason":"Sprite Python WS server + gateway implemented. 11/11 tests pass. Inspector PASS 5/5. Dependency on m7b.2.4 (golden checkpoint) is for deployment, not code.","dependencies":[{"issue_id":"stackdocs-m7b.2.5","depends_on_id":"stackdocs-m7b.2","type":"parent-child","created_at":"2026-02-06T15:19:40.766294+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.2.5","depends_on_id":"stackdocs-m7b.2.4","type":"blocks","created_at":"2026-02-06T15:23:20.075442+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.2.6","title":"Bridge TCP Proxy and message forwarding","description":"**Goal:** Bridge connects to Sprite via Sprites TCP Proxy API and forwards messages bidirectionally.\n**Files:** Create `bridge/src/sprite-connection.ts`, create `bridge/src/proxy.ts`\n**Depends on:** Create Sprites API client and provisioning, Create Sprite Python WebSocket server\n\n**Steps:**\n1. Establish WebSocket connection from Bridge to Sprite via `WSS /v1/sprites/{name}/proxy` with `ProxyInitMessage` targeting port 8765\n2. Forward browser messages → Sprite (inject `request_id` if present)\n3. Forward Sprite messages → browser\n4. Handle connection lifecycle: open, close, error\n5. Track active Sprite connections per stack\n\n**Tests:**\n- [ ] Message sent from browser WS arrives at Sprite WS (integration test with real Sprite)\n- [ ] Message sent from Sprite WS arrives at browser WS\n- [ ] `request_id` injected on forwarded messages when present\n- [ ] Connection tracking correctly maps stack_id → active Sprite connection\n- [ ] Connection close on either side propagates to the other","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:19:51.679187+11:00","created_by":"thebrownproject","updated_at":"2026-02-07T12:28:29.970596+11:00","closed_at":"2026-02-07T12:28:29.970596+11:00","close_reason":"Bridge TCP Proxy + message forwarding implemented. 65/65 tests pass. Inspector PASS. Circular dep fixed (connection-store.ts extracted).","dependencies":[{"issue_id":"stackdocs-m7b.2.6","depends_on_id":"stackdocs-m7b.2","type":"parent-child","created_at":"2026-02-06T15:19:51.680062+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.2.6","depends_on_id":"stackdocs-m7b.2.3","type":"blocks","created_at":"2026-02-06T15:23:20.191295+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.2.6","depends_on_id":"stackdocs-m7b.2.5","type":"blocks","created_at":"2026-02-06T15:23:20.312691+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.2.7","title":"Bridge sleep/wake reconnection and keepalive","description":"**Goal:** Bridge handles Sprite sleep/wake gracefully — reconnects TCP Proxy, buffers messages, keeps Sprites awake during active sessions.\n**Files:** Create `bridge/src/reconnect.ts`, create `bridge/src/keepalive.ts`, modify `bridge/src/proxy.ts`\n**Depends on:** Bridge TCP Proxy and message forwarding\n\n**Phase 0 Finding:** Processes survive sleep/wake (checkpoint/CRIU, same PID). The Python WS server persists — Bridge only needs to reconnect the TCP Proxy tunnel, NOT restart anything on the Sprite.\n\n**Steps:**\n1. Detect Sprite TCP Proxy connection drop (WS close/error event)\n2. Send `sprite_waking` system message to browser\n3. Call Sprites API to trigger wake (any API call wakes it), poll status until running\n4. Re-establish TCP Proxy connection to port 8765 (server is still running, same PID)\n5. Verify server responds (send ping through proxy, expect pong)\n6. If server NOT responding (crash, not sleep): send exec command to restart Python WS server\n7. Send `sprite_ready` system message to browser\n8. Replay buffered messages (max 50 messages, 60s TTL)\n9. Implement keepalive: ping Sprite every 15s during active browser sessions, stop on disconnect\n10. Handle race conditions: multiple wake attempts, messages during reconnect\n\n**Tests:**\n- [ ] Simulated connection drop → `sprite_waking` system message sent to browser\n- [ ] After reconnect → `sprite_ready` system message sent to browser\n- [ ] Buffered messages (up to 50, within 60s TTL) replayed after reconnect\n- [ ] Keepalive pings sent every 15s while browser connected (verified by timer mock)\n- [ ] Keepalive stops when browser disconnects\n- [ ] Concurrent wake attempts coalesce (no duplicate wake calls)\n- [ ] Server crash recovery: exec restart fallback works when server is unresponsive after wake","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:20:00.062315+11:00","created_by":"thebrownproject","updated_at":"2026-02-07T12:52:26.116834+11:00","closed_at":"2026-02-07T12:52:26.116834+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.2.7","depends_on_id":"stackdocs-m7b.2","type":"parent-child","created_at":"2026-02-06T15:20:00.063231+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.2.7","depends_on_id":"stackdocs-m7b.2.6","type":"blocks","created_at":"2026-02-06T15:23:20.43094+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.2.8","title":"End-to-end smoke test and deployment","description":"**Goal:** Validate the full message round-trip: Browser → Bridge → Sprite → response. Deploy Bridge to Fly.io.\n**Files:** Create `bridge/tests/e2e-echo.ts` or `scripts/test-pipeline.sh`, DNS config\n**Depends on:** Bridge sleep/wake reconnection and keepalive\n\n**Steps:**\n1. Write test script: connect WS to Bridge, send auth, send mission, verify echo response\n2. Measure round-trip latency (target \u003c 500ms excluding Sprite wake)\n3. Test sleep/wake cycle: disconnect, wait 35s, reconnect, verify wake\n4. Deploy Bridge to Fly.io\n5. Configure ws.stackdocs.io DNS CNAME to Fly.io app\n6. Test from browser against production Bridge\n7. Fix any issues discovered during integration\n\n**Tests:**\n- [ ] Test script passes: connect → auth → send mission → receive echo response\n- [ ] Round-trip latency \u003c 500ms (excluding Sprite wake time)\n- [ ] Sleep/wake cycle: wait 35s → reconnect → Sprite wakes → echo works\n- [ ] Bridge accessible at wss://ws.stackdocs.io (DNS resolves, TLS works)\n- [ ] Browser-based test against production Bridge succeeds","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:20:05.602183+11:00","created_by":"thebrownproject","updated_at":"2026-02-07T20:49:05.092285+11:00","closed_at":"2026-02-07T20:49:05.092285+11:00","close_reason":"84 tests passing, Bridge deployed to Fly.io (stackdocs-bridge.fly.dev), wss://ws.stackdocs.io live with TLS, smoke test passing. Sleep/wake E2E deferred to Phase 2 (needs Sprite server running).","dependencies":[{"issue_id":"stackdocs-m7b.2.8","depends_on_id":"stackdocs-m7b.2","type":"parent-child","created_at":"2026-02-06T15:20:05.602998+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.2.8","depends_on_id":"stackdocs-m7b.2.7","type":"blocks","created_at":"2026-02-06T15:23:20.548843+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.2.9","title":"Supabase schema migration for v2","description":"**Goal:** Add sprite columns to stacks table. Keep existing tables but stop writing to them.\n**Files:** Create migration SQL, modify `docs/specs/SCHEMA.md`\n**Depends on:** None (can run anytime in Phase 1)\n\n**Steps:**\n1. Add `sprite_name TEXT` and `sprite_status TEXT DEFAULT 'pending'` columns to `stacks` table\n2. Keep all existing v1 tables (don't drop — data is there, just unused)\n3. Update SCHEMA.md to document v2 platform tables (users + stacks)\n4. Test that Clerk auth + existing frontend still work (v1 and v2 coexist)\n\n**Tests:**\n- [ ] `sprite_name` and `sprite_status` columns exist on `stacks` table\n- [ ] `sprite_status` defaults to 'pending' for new rows\n- [ ] All v1 tables still exist (not dropped)\n- [ ] Existing frontend loads without errors (v1 and v2 coexist)\n- [ ] `SCHEMA.md` updated with v2 platform tables documentation","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:20:09.483676+11:00","created_by":"thebrownproject","updated_at":"2026-02-07T13:04:50.258045+11:00","closed_at":"2026-02-07T13:04:50.258045+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.2.9","depends_on_id":"stackdocs-m7b.2","type":"parent-child","created_at":"2026-02-06T15:20:09.484584+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.3","title":"Phase 2: Sprite Runtime","description":"Adapt existing v1 agent code to run on Sprites with SQLite + WebSocket output. 5 tasks. Runs in PARALLEL with Phase 3.","status":"closed","priority":1,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:17:12.761469+11:00","created_by":"thebrownproject","updated_at":"2026-02-08T10:37:10.011442+11:00","closed_at":"2026-02-08T10:37:10.011442+11:00","close_reason":"Phase 2 complete. 6/6 tasks closed: SQLite layer, tool factories, agent runtime, canvas tools (3), memory system (3+loader+journal+transcript). 56 sprite tests pass. Agent has 6 custom tools via single MCP server.","dependencies":[{"issue_id":"stackdocs-m7b.3","depends_on_id":"stackdocs-m7b","type":"parent-child","created_at":"2026-02-06T15:17:12.762415+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.3.1","title":"SQLite database layer","description":"**Goal:** Async SQLite wrapper with full schema, WAL mode, and query helpers.\n**Files:** Create `sprite/src/database.py`\n**Depends on:** Create Sprite Python WebSocket server\n\n**Steps:**\n1. Create `Database` class wrapping `aiosqlite`\n2. Initialize schema on first boot: `documents`, `ocr_results`, `extractions`, `memory_fts` tables\n3. Enable WAL mode for concurrent reads\n4. Provide `query()`, `execute()`, `fetchone()`, `fetchall()` async methods\n5. Connection pooling (single connection for MVP, serialize writes)\n\n**Tests:**\n- [ ] `python -m pytest sprite/tests/test_database.py` passes\n- [ ] Schema creates all tables on init: `documents`, `ocr_results`, `extractions`, `memory_fts`\n- [ ] `PRAGMA journal_mode` returns `wal`\n- [ ] CRUD operations work: insert, select, update, delete for each table\n- [ ] Concurrent reads don't block (WAL mode verified)\n- [ ] Database file created at expected path","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:20:20.518974+11:00","created_by":"thebrownproject","updated_at":"2026-02-07T22:49:13.198309+11:00","closed_at":"2026-02-07T22:49:13.198309+11:00","close_reason":"97-line Database class, 18 tests passing, schema matches bootstrap.ts DDL exactly, WAL mode, async context manager","dependencies":[{"issue_id":"stackdocs-m7b.3.1","depends_on_id":"stackdocs-m7b.3","type":"parent-child","created_at":"2026-02-06T15:20:20.519891+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.3.1","depends_on_id":"stackdocs-m7b.2.5","type":"blocks","created_at":"2026-02-06T15:23:23.236814+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.3.2","title":"Port tool factories from Supabase to SQLite","description":"**Goal:** All extraction agent tools work with SQLite instead of Supabase, preserving the scoped closure pattern.\n**Files:** Create `sprite/src/agents/extraction_agent/` (port from `backend/app/agents/extraction_agent/`), create `sprite/src/agents/shared/`\n**Depends on:** SQLite database layer\n\n**Steps:**\n1. Copy extraction agent structure: `agent.py`, `prompts.py`, `tools/` directory\n2. Replace `from supabase import Client` with local `Database` import in every tool\n3. Rewrite each tool's database calls: `db.table().select().eq()` → `db.query(\"SELECT ... WHERE ...\")`\n4. Port tools: `read_ocr`, `read_extraction`, `save_extraction`, `set_field`, `delete_field`, `complete`\n5. Preserve `create_tools(extraction_id, document_id, user_id, db)` factory signature (change `db` type)\n6. Port OCR service: `sprite/src/services/ocr.py` — Mistral OCR with env var API key, cache to `/workspace/ocr/`\n\n**Tests:**\n- [ ] Each tool (read_ocr, read_extraction, save_extraction, set_field, delete_field, complete) has unit test with SQLite\n- [ ] `create_tools(extraction_id, document_id, user_id, db)` returns all tools with correct signatures\n- [ ] Tools read/write SQLite correctly (verified by querying DB after tool call)\n- [ ] `save_extraction` writes JSON to `extracted_fields` column\n- [ ] OCR service caches text to `/workspace/ocr/{doc_id}.md` (file exists after call)\n- [ ] Factory closure scoping: tools only access their scoped extraction_id/document_id","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:20:31.423856+11:00","created_by":"thebrownproject","updated_at":"2026-02-07T23:01:55.454801+11:00","closed_at":"2026-02-07T23:01:55.454801+11:00","close_reason":"Obsolete: v2 agent uses Bash/Read/Write directly instead of tool factories. Extraction logic absorbed by m7b.3.3 (runtime), m7b.3.4 (canvas tools), m7b.3.5 (memory/soul.md). OCR deferred to Phase 4.","dependencies":[{"issue_id":"stackdocs-m7b.3.2","depends_on_id":"stackdocs-m7b.3","type":"parent-child","created_at":"2026-02-06T15:20:31.424641+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.3.2","depends_on_id":"stackdocs-m7b.3.1","type":"blocks","created_at":"2026-02-06T15:23:23.358846+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.3.3","title":"Agent runtime with WebSocket output","description":"**Goal:** Claude Agent SDK runs on Sprite and streams events as WebSocket messages instead of SSE.\n**Files:** Create `sprite/src/runtime.py`, modify `sprite/src/gateway.py`\n**Depends on:** Port tool factories from Supabase to SQLite\n\n**Steps:**\n1. Create `AgentRuntime` class wrapping Claude Agent SDK (ClaudeSDKClient, ClaudeAgentOptions)\n2. Map SDK event stream to `agent_event` WebSocket messages: text, tool, complete, error\n3. Register extraction tools via MCP server with allowed_tools whitelist\n4. Support session resume via ClaudeAgentOptions(resume=session_id)\n5. Wire into SpriteGateway.handle_mission(): load memory → build system prompt → invoke agent → stream events\n6. Serialize missions with async lock (one at a time)\n\n**Note:** Pre-compaction memory flush requires the raw anthropic SDK — claude-agent-sdk does not expose compaction controls. This is explicitly post-MVP.\n\n**Tests:**\n- [ ] Agent invocation streams agent_event messages over WS (mock WS captures text, tool, complete events)\n- [ ] Event type mapping: SDK events → correct event_type values (text, tool, complete, error)\n- [ ] mission_lock prevents concurrent missions (second mission waits until first completes)\n- [ ] Session resume: ClaudeAgentOptions(resume=session_id) restores previous conversation\n- [ ] Extraction tools registered and callable by agent via MCP server\n- [ ] Error in agent → agent_event with event_type: 'error' sent to browser","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:20:41.720708+11:00","created_by":"thebrownproject","updated_at":"2026-02-07T23:54:04.969061+11:00","closed_at":"2026-02-07T23:54:04.969061+11:00","close_reason":"AgentRuntime wrapping Claude Agent SDK, 137 lines. Streams text/tool/complete/error events over WS. Session resume support. 12 tests passing.","dependencies":[{"issue_id":"stackdocs-m7b.3.3","depends_on_id":"stackdocs-m7b.3","type":"parent-child","created_at":"2026-02-06T15:20:41.721638+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.3.3","depends_on_id":"stackdocs-m7b.3.2","type":"blocks","created_at":"2026-02-06T15:23:23.477671+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.3.3","depends_on_id":"stackdocs-m7b.3.6","type":"blocks","created_at":"2026-02-07T20:39:37.181692+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.3.3","depends_on_id":"stackdocs-kfn","type":"blocks","created_at":"2026-02-08T00:39:09.792337+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.3.4","title":"Canvas tools for agent","description":"**Goal:** Agent can create/update/close cards on the user's Canvas via custom tools, composing from the block catalog.\n**Files:** Create `sprite/src/agents/shared/canvas_tools.py`, modify `sprite/src/runtime.py`, update `bridge/src/bootstrap.ts`\n**Spec:** `.space-agents/exploration/ideas/2026-02-08-canvas-tools-and-memory-system/spec.md`\n**Depends on:** Agent runtime with WebSocket output (m7b.3.3 — DONE)\n\n**SDK Integration:**\n- `@tool` decorator + `create_sdk_mcp_server(name=\"sprite\")` pattern (proven from v1)\n- Tools appear to agent as `mcp__sprite__create_card`, etc.\n- Single MCP server for canvas + memory tools (shared with m7b.3.5)\n- Omit `allowed_tools` for MVP — agent gets all built-in + custom tools\n\n**Steps:**\n1. Create `sprite/src/agents/shared/` directory with `__init__.py`\n2. Create tool factory: `create_canvas_tools(send_fn)` — scoped with WebSocket send function\n3. `create_card(title, card_type, blocks)` → sends `canvas_update` message with `command: 'create_card'` and block array. `card_type`: \"table\"|\"document\"|\"notes\". `position`/`size` optional.\n4. `update_card(card_id, blocks)` → sends `canvas_update` with `command: 'update_card'` and changed blocks (matched by block `id`)\n5. `close_card(card_id)` → sends `canvas_update` with `command: 'close_card'`\n6. Use existing `CanvasUpdate`/`CanvasUpdatePayload` dataclasses from `protocol.py` + `to_json()` serializer\n7. Include `json.loads()` guards for list/dict params (Claude sometimes stringifies JSON)\n8. Register via `create_sdk_mcp_server` in `runtime.py`\n9. Update `bootstrap.ts` `deployCode()` to support `agents/shared/` subdirectory\n10. Agent composes cards from MVP block types: `heading`, `stat`, `key-value`, `table`, `badge`, `progress`, `text`, `separator`\n\n**Tests:**\n- [ ] `create_card(\"Test\", \"table\", [heading_block, table_block])` sends `canvas_update` with `command: 'create_card'` and blocks array over WS\n- [ ] `update_card(card_id, [updated_block])` sends `canvas_update` with `command: 'update_card'` and changed blocks\n- [ ] `close_card(card_id)` sends `canvas_update` with `command: 'close_card'`\n- [ ] All three tools registered in agent's tool list via MCP server\n- [ ] Message payloads match protocol schema (`CanvasUpdate` dataclass, card_id, title, blocks fields present)\n- [ ] Blocks validated: each has `id` (auto-UUID) and `type` matching MVP catalog\n- [ ] Tool returns confirmation with card_id for create, success/error for update/close","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:20:48.40387+11:00","created_by":"thebrownproject","updated_at":"2026-02-08T10:19:01.341682+11:00","closed_at":"2026-02-08T10:19:01.341682+11:00","close_reason":"Canvas tools implemented: create_card, update_card, close_card. 14 tests pass. DRY cleanup applied (390 lines). Inspector verified SDK pattern, v1 consistency, and protocol compliance.","dependencies":[{"issue_id":"stackdocs-m7b.3.4","depends_on_id":"stackdocs-m7b.3","type":"parent-child","created_at":"2026-02-06T15:20:48.404809+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.3.4","depends_on_id":"stackdocs-m7b.3.3","type":"blocks","created_at":"2026-02-06T15:23:23.601206+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.3.4","depends_on_id":"stackdocs-kfn","type":"blocks","created_at":"2026-02-08T00:39:09.941575+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.3.5","title":"Basic memory system (file loading + journals)","description":"**Goal:** Memory files load into agent system prompt at session start. Daily journals capture activity. Agent can update memory via tools.\n**Files:** Create `sprite/src/memory/` directory (`__init__.py`, `loader.py`, `journal.py`, `transcript.py`), create `sprite/src/agents/shared/memory_tools.py`, modify `sprite/src/runtime.py`, update `bridge/src/bootstrap.ts`\n**Spec:** `.space-agents/exploration/ideas/2026-02-08-canvas-tools-and-memory-system/spec.md`\n**Depends on:** Agent runtime with WebSocket output (m7b.3.3 — DONE)\n\n**SDK Integration:**\n- Memory tools use same `@tool` + `create_sdk_mcp_server(name=\"sprite\")` as canvas tools\n- Tools appear as `mcp__sprite__write_memory`, `mcp__sprite__update_soul`, `mcp__sprite__update_user_prefs`\n- Bundled into single \"sprite\" MCP server alongside canvas tools (m7b.3.4)\n\n**Note:** Bootstrap already creates soul.md/user.md/MEMORY.md templates on Sprite. `memory/__init__.py` is a fallback for first-boot if templates missing. `runtime.py` already loads soul.md — `loader.py` expands this to load all 5 sources.\n\n**Steps:**\n1. `memory/__init__.py`: ensure_templates() — create soul.md, user.md, MEMORY.md in `/workspace/memory/` if missing (fallback for bootstrap)\n2. `memory/loader.py`: load() → structured system prompt string from soul.md + user.md + MEMORY.md + today's journal + yesterday's journal\n3. `memory/journal.py`: append_journal(summary) → append to `/workspace/memory/YYYY-MM-DD.md`\n4. `memory/transcript.py`: TranscriptLogger class → log tool calls + responses to `/workspace/transcripts/YYYY-MM-DDTHH-MM-SS.jsonl`\n5. `agents/shared/memory_tools.py`: create_memory_tools() factory returning `@tool`-decorated functions:\n   - `write_memory(file, content)` — write to specified memory file in /workspace/memory/\n   - `update_soul(content)` — update soul.md\n   - `update_user_prefs(content)` — update user.md\n6. Modify `runtime.py`: replace `_load_system_prompt()` with `loader.load()`, call `journal.append_journal()` after mission, init TranscriptLogger\n7. Update `bootstrap.ts` `deployCode()` to support `memory/` subdirectory\n8. Register memory tools via same `create_sdk_mcp_server` as canvas tools\n\n**Tests:**\n- [ ] First boot creates soul.md, user.md, MEMORY.md in /workspace/memory/ if missing\n- [ ] Second boot skips creation (files already exist, not overwritten)\n- [ ] Loader returns structured string containing content from all 5 sources (soul + user + MEMORY + today + yesterday)\n- [ ] Journal appends to /workspace/memory/YYYY-MM-DD.md (correct date, append not overwrite)\n- [ ] Transcript logs to /workspace/transcripts/YYYY-MM-DDTHH-MM-SS.jsonl with valid JSON lines\n- [ ] Memory tools (write_memory, update_soul, update_user_prefs) write to correct files\n- [ ] System prompt at session start includes memory context from loader","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:20:56.723308+11:00","created_by":"thebrownproject","updated_at":"2026-02-08T10:36:55.878764+11:00","closed_at":"2026-02-08T10:36:55.878764+11:00","close_reason":"Memory system implemented: loader (5 sources), journal, transcript, 3 tools. DRY cleanup (172→101 lines). Fixed test isolation (sys.modules poisoning), transcript null bug, and updated runtime tests. 56/56 sprite tests pass.","dependencies":[{"issue_id":"stackdocs-m7b.3.5","depends_on_id":"stackdocs-m7b.3","type":"parent-child","created_at":"2026-02-06T15:20:56.724247+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.3.5","depends_on_id":"stackdocs-m7b.3.3","type":"blocks","created_at":"2026-02-06T15:23:23.71991+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.3.5","depends_on_id":"stackdocs-kfn","type":"blocks","created_at":"2026-02-08T00:39:10.06649+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.3.6","title":"Design API key proxy for Sprites (security)","description":"Sprites should NEVER hold master API keys (ANTHROPIC_API_KEY, MISTRAL_API_KEY). Prompt injection in uploaded documents could exfiltrate keys via Bash or WebFetch tools. Design an API proxy route on Bridge: Sprite sets ANTHROPIC_BASE_URL to Bridge endpoint, Bridge adds the real key to outbound requests. Must be done before agent runtime (m7b.3.3) ships. Options: (A) HTTP proxy route on Bridge ~50-100 lines, (B) per-user scoped keys (provider support unclear), (C) separate proxy service.","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-07T20:39:24.794608+11:00","created_by":"thebrownproject","updated_at":"2026-02-08T00:39:34.212762+11:00","closed_at":"2026-02-08T00:39:34.212762+11:00","close_reason":"API key proxy implemented. HTTP reverse proxy on Bridge (api-proxy.ts, 130 lines, 10 tests). Anthropic + Mistral. Shared SPRITES_PROXY_TOKEN auth. Inspector: 10/10 pass.","dependencies":[{"issue_id":"stackdocs-m7b.3.6","depends_on_id":"stackdocs-m7b.3","type":"parent-child","created_at":"2026-02-07T20:39:24.796097+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4","title":"Phase 3: Canvas UI — Grid Layout + Agent Prompt","description":"**Grid-based canvas** with composable card system (A2UI-inspired, custom block catalog). Agent streams cards composed from block primitives (heading, stat, key-value, table, badge, progress, text, separator). Uses react-grid-layout for responsive dashboard layout — cards snap to grid, drag to rearrange, resize between predefined sizes (small/medium/large/full). No zoom/pan — scroll only.\n\n**Agent prompt:** PA framing — Canvas cards are the primary output surface. Agent proactively creates cards for structured data. Text chat is short narration (\"I've pulled up the invoice details\").\n\n**Key decisions (Session 136 brainstorm):**\n- react-grid-layout replaces React Flow (homescreen widget metaphor, not whiteboard)\n- Predefined card sizes: small (1col), medium (2col), large (2col+), full (3col)\n- Height auto-sizes to content\n- No zoom, no pan — natural scroll\n- `size` parameter replaces `card_type` (table/document/notes) in tool API\n- Agent system prompt includes Canvas section with proactive card creation guidance\n- Cards pop in complete (no streaming for MVP)\n- Both user and agent can manage cards (create, close, resize, drag)\n- Layout state in browser localStorage (Zustand + persist), no Sprite sync for MVP\n- Responsive: 3 col desktop, 2 col tablet, 1 col mobile\n- A2UI-inspired visual styling — clean, content-first\n\n**Spec:** `.space-agents/exploration/ideas/2026-02-08-canvas-grid-layout-and-agent-prompt/spec.md`\n**Plan:** `.space-agents/exploration/ideas/2026-02-08-canvas-grid-layout-and-agent-prompt/plan.md`","status":"in_progress","priority":1,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:17:13.208677+11:00","created_by":"thebrownproject","updated_at":"2026-02-08T17:49:45.921621+11:00","dependencies":[{"issue_id":"stackdocs-m7b.4","depends_on_id":"stackdocs-m7b","type":"parent-child","created_at":"2026-02-06T15:17:13.209437+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.1","title":"WebSocket connection manager and store","description":"**Goal:** Frontend connects to Bridge via WebSocket with Clerk auth, dispatches messages, and tracks connection state.\n**Files:** Create `frontend/lib/websocket.ts`, create `frontend/lib/stores/ws-store.ts`\n**Depends on:** Define WebSocket message protocol, Create Bridge project scaffold and WS server\n\n**Steps:**\n1. websocket.ts: WebSocket client connecting to wss://ws.stackdocs.io/{stack_id}\n2. Send Clerk JWT as first message, handle auth response\n3. Exponential backoff reconnection (1s, 2s, 4s, max 30s)\n4. Message dispatch to registered handlers by type\n5. ws-store.ts: Zustand store exposing connectionStatus, sendMessage(), lastError\n6. Listen for system messages to update connection status\n7. Integrate with Clerk useAuth() for JWT\n\n**Tests:**\n- [ ] Connects to WS URL and sends auth message as first frame\n- [ ] Reconnects with exponential backoff (1s, 2s, 4s, max 30s) on disconnect\n- [ ] Message handlers dispatched by type field\n- [ ] Zustand store connectionStatus updates on system messages\n- [ ] sendMessage() serializes and sends over WS connection\n- [ ] `npm run build` passes with no TypeScript errors in new files","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:21:09.069787+11:00","created_by":"thebrownproject","updated_at":"2026-02-08T12:59:32.185287+11:00","closed_at":"2026-02-08T12:59:32.185287+11:00","close_reason":"websocket.ts created, TypeScript compiles clean, tested E2E through Bridge to Sprite","dependencies":[{"issue_id":"stackdocs-m7b.4.1","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-06T15:21:09.0713+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.1","depends_on_id":"stackdocs-m7b.2.1","type":"blocks","created_at":"2026-02-06T15:23:26.555204+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.1","depends_on_id":"stackdocs-m7b.2.2","type":"blocks","created_at":"2026-02-06T15:23:26.667909+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.10","title":"React 19 + react-grid-layout compatibility spike","description":"**Goal:** Verify react-grid-layout works with React 19.2.3 before committing to the layout engine swap. Quick spike on the test-chat page.\n\n**Files:** Modify `frontend/app/(app)/test-chat/page.tsx`, modify `frontend/package.json`\n\n**Steps:**\n1. Install `react-grid-layout` + `@types/react-grid-layout` alongside existing @xyflow/react (don't remove yet)\n2. Import react-grid-layout CSS (`react-grid-layout/css/styles.css` + `react-resizable/css/styles.css`)\n3. Add a temporary grid layout section to test-chat page (below or beside existing canvas)\n4. Render 3-4 mock cards in a `\u003cResponsiveGridLayout\u003e` with breakpoints (lg=3col, md=2col, sm=1col)\n5. Test: drag cards to rearrange, resize cards, verify responsive breakpoints\n6. Test auto-height approach: use ResizeObserver on card content, calculate grid `h` from scrollHeight\n7. Verify no React 19 synthetic event issues (drag handlers, resize handlers)\n8. Document results: works/doesn't work, any workarounds needed\n\n**Success:**\n- [ ] Cards render in grid layout on test-chat page\n- [ ] Drag to rearrange works (cards reflow)\n- [ ] Resize works (predefined width sizes)\n- [ ] ResponsiveGridLayout responds to viewport width changes\n- [ ] No React 19 console errors or broken event handlers\n- [ ] ResizeObserver auto-height approach validated or alternative documented\n\n**Fallback:** If react-grid-layout fails with React 19, evaluate `@dnd-kit/core` + CSS Grid as alternative.\n\n**Test at:** http://127.0.0.1:3000/test-chat","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-08T17:57:53.688956+11:00","created_by":"thebrownproject","updated_at":"2026-02-08T19:05:52.043667+11:00","closed_at":"2026-02-08T19:05:52.043667+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.10","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-08T17:57:53.690339+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.11","title":"Test and verify full Bridge → Sprite connection path","description":"**Goal:** Fix Bridge → Sprite connection pipe so messages flow both directions.\n\n**ROOT CAUSE (debugged Session 154):**\n\nThree bugs, one root cause — nobody starts the Sprite Python server:\n\n1. **`provisioning.ts`**: `bootstrapSprite()` deploys code but never starts the Python server. `buildServerExecUrl()` is defined (line 137) but never called.\n\n2. **`proxy.ts` / `index.ts`**: Initial TCP Proxy connection failure (1011 = nothing listening on port 8765) has NO fallback. Bridge gives up instead of trying to start the server.\n\n3. **`reconnect.ts`**: Has `defaultRestartServer` (line 112-122) that CAN start the server via exec, but only triggers after a previously-working connection drops — not on initial failure.\n\n**Fix required:**\n\nA) In `proxy.ts` `ensureSpriteConnection`: catch 1011 errors from `createAndRegister`, start server via exec (reuse `defaultRestartServer` pattern from reconnect.ts), retry connect.\n\nB) In `provisioning.ts` `provisionSprite`: after `bootstrapSprite()`, start the Python server via exec before marking as active.\n\nC) Tests: verify the retry logic works (mock 1011 → exec restart → successful connect).\n\n**Key files:**\n- `bridge/src/proxy.ts` — add retry-with-server-start to `ensureSpriteConnection`\n- `bridge/src/provisioning.ts` — add server start after bootstrap\n- `bridge/src/sprite-connection.ts` — no changes needed (working correctly)\n- `bridge/src/reconnect.ts` — extract `defaultRestartServer` for reuse, or move to shared util\n- `bridge/src/index.ts` — no changes needed (error handling is fine)\n\n**Evidence:** Browser connects, auth succeeds, then: `Sprite connection failed: TCP Proxy closed during init: 1011`\n\n**Server startup command** (from `provisioning.ts:30`):\n```\ncd /workspace \u0026\u0026 PYTHONPATH=/workspace/.os /workspace/.os/.venv/bin/python3 -m src.server\n```\n\n**Tests:**\n- [ ] Initial connect starts server if not running (1011 → exec restart → connect succeeds)\n- [ ] Provisioning starts server after bootstrap\n- [ ] Existing reconnect logic still works (regression)\n- [ ] Agent messages flow both directions through the pipe","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-08T18:28:59.194507+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T11:01:47.992987+11:00","closed_at":"2026-02-13T11:01:47.992987+11:00","close_reason":"FIXED: Full E2E pipe working. Three fixes: (1) startSpriteServer shared utility in provisioning.ts, (2) 1011 retry in proxy.ts, (3) env vars fix in reconnect.ts. Also fixed venv symlink + VERSION on sd-e2e-test Sprite. Deployed to Fly.io. Agent creates cards → canvas_update flows through Bridge → card appears in browser. Blocks render as raw JSON — m7b.4.12.9 handles that.","dependencies":[{"issue_id":"stackdocs-m7b.4.11","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-08T18:28:59.196039+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.12","title":"Phase A: Glass Desktop UI","description":"**Goal:** Ship the spatial glass desktop OS interface with data cards, chat, top bar, and workspace switching — replacing the v1 sidebar/header shell.\n\n**Spec:** `.space-agents/exploration/planned/2026-02-09-liquid-glass-ui-reskin/spec.md`\n**Plan:** `.space-agents/exploration/planned/2026-02-09-liquid-glass-ui-reskin/plan.md`\n**Prototype:** `frontend/app/(app)/test-chat/page.tsx` (529 lines)\n\n12 tasks, 8-10 mission sessions. Most code ports from test-chat prototype.\nSupersedes m7b.4.2, m7b.4.3, m7b.4.5, m7b.4.6, m7b.4.7 (closed).","status":"in_progress","priority":1,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-12T11:46:08.013404+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T13:09:35.097541+11:00","dependencies":[{"issue_id":"stackdocs-m7b.4.12","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-12T11:46:08.016158+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.12.1","title":"Desktop route group + glass tokens","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T13:09:52.596295+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T13:50:31.997284+11:00","closed_at":"2026-02-12T13:50:31.997284+11:00","close_reason":"Desktop route group created, Ein UI CSS vars added, CRT keyframe added. Build clean.","dependencies":[{"issue_id":"stackdocs-m7b.4.12.1","depends_on_id":"stackdocs-m7b.4.12","type":"parent-child","created_at":"2026-02-12T13:09:52.597812+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.12.10","title":"Chat panel (right side)","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T13:10:22.021435+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T10:21:56.388731+11:00","closed_at":"2026-02-13T10:21:56.388731+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.12.10","depends_on_id":"stackdocs-m7b.4.12","type":"parent-child","created_at":"2026-02-12T13:10:22.026195+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.12.10","depends_on_id":"stackdocs-m7b.4.12.2","type":"blocks","created_at":"2026-02-12T13:11:11.639182+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.12.10","depends_on_id":"stackdocs-m7b.4.12.6","type":"blocks","created_at":"2026-02-12T13:11:11.787821+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.12.11","title":"Documents panel (left-anchored)","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T13:10:25.217739+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T10:21:56.423574+11:00","closed_at":"2026-02-13T10:21:56.423574+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.12.11","depends_on_id":"stackdocs-m7b.4.12","type":"parent-child","created_at":"2026-02-12T13:10:25.222376+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.12.11","depends_on_id":"stackdocs-m7b.4.12.1","type":"blocks","created_at":"2026-02-12T13:11:11.934228+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.12.11","depends_on_id":"stackdocs-m7b.4.12.10","type":"blocks","created_at":"2026-02-12T13:11:12.111903+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.12.12","title":"Source wallpaper images","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T13:10:28.377624+11:00","created_by":"thebrownproject","updated_at":"2026-02-17T20:26:39.830994+11:00","closed_at":"2026-02-17T20:26:39.830994+11:00","close_reason":"Mesh gradients replaced static wallpaper images","dependencies":[{"issue_id":"stackdocs-m7b.4.12.12","depends_on_id":"stackdocs-m7b.4.12","type":"parent-child","created_at":"2026-02-12T13:10:28.385782+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.12.12","depends_on_id":"stackdocs-m7b.4.12.3","type":"blocks","created_at":"2026-02-12T13:11:12.26643+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.12.13","title":"Restyle desktop right-click context menu (glass sections)","description":"Implement a glass-styled right-click context menu for the desktop canvas.\n\n## Approach (from brainstorm session 155)\n- **Primitive:** Install shadcn `context-menu` (Radix ContextMenu), then create `glass-context-menu.tsx` wrapper with glass styling — same pattern as glass-button, glass-tooltip, etc.\n- **Positioning:** Radix ContextMenu handles right-click positioning natively\n- **Hook into desktop:** Add `onContextMenu` handler to `desktop-viewport.tsx` (currently blocks right-click with `if (e.button === 2) return`)\n\n## Menu Structure\nThree sections with uppercase `text-[10px]` section labels:\n\n### Environment\n- Wallpaper selection with small preview thumbnails (8x8 rounded squares showing wallpaper image)\n- Dark/light mode toggle\n- Reuse wallpaper-store data for thumbnails\n\n### View\n- Zoom controls in compact 3-column grid (icon-only buttons): zoom out, fit/reset, zoom in\n- \"Clean Up By Name\" button (auto-arrange cards)\n\n### Stack\n- Stack settings\n- Rename stack\n\n## Glass Styling\n- `bg-white/10 backdrop-blur-xl border border-white/20` (match existing glass components)\n- `hover:bg-white/10` on items\n- White/alpha color palette throughout\n- `shadow-2xl` on container\n\n## Reference\n- Google AI prototype: `docs/reference/spatial-glass-prototype/components/Desktop/ContextMenu.tsx`\n- Use **frontend-design skill** for creative quality","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T10:49:40.469606+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T14:13:33.974939+11:00","closed_at":"2026-02-13T14:13:33.974939+11:00","close_reason":"Tab popover replaced with shared DesktopMenuBody; context menu already working from session 155","dependencies":[{"issue_id":"stackdocs-m7b.4.12.13","depends_on_id":"stackdocs-m7b.4.12","type":"parent-child","created_at":"2026-02-13T10:49:40.476498+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.12.14","title":"Frontend cleanup: review findings (session 160)","description":"1. ChatPanel duplicates GlassSidePanel — refactor to use GlassSidePanel with side=right and ChatBar as footer. Saves ~25 lines.\n2. GlassButton unconditional wrapper div — glowEffect never used, extra DOM node may break Radix asChild. Remove or make conditional.\n3. ChatMessage uses array index as key — add id field to ChatMessage to fix React reconciliation during streaming.\n4. Streaming perf: appendToLastAgent copies array per token — consider debounced buffer or immer middleware at scale.","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-13T18:50:03.972045+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T20:21:20.887405+11:00","closed_at":"2026-02-13T20:21:20.887405+11:00","close_reason":"All 4 findings fixed: ChatPanel→GlassSidePanel refactor, GlassButton wrapper div removed, ChatMessage id field added, Finding 4 (appendToLastAgent perf) deferred as premature optimization","dependencies":[{"issue_id":"stackdocs-m7b.4.12.14","depends_on_id":"stackdocs-m7b.4.12","type":"parent-child","created_at":"2026-02-13T18:50:03.975557+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.12.2","title":"Zustand stores (desktop + chat)","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T13:09:56.220835+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T14:00:08.309563+11:00","closed_at":"2026-02-12T14:00:08.309563+11:00","close_reason":"Desktop store (persisted) + chat store (ephemeral) created. Build clean.","dependencies":[{"issue_id":"stackdocs-m7b.4.12.2","depends_on_id":"stackdocs-m7b.4.12","type":"parent-child","created_at":"2026-02-12T13:09:56.222039+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.12.3","title":"Wallpaper layer + wallpaper store","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T13:09:59.954243+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T14:11:44.238458+11:00","closed_at":"2026-02-12T14:11:44.238458+11:00","close_reason":"Wallpaper store + layer + picker created. 3 image presets, localStorage persist, wired into desktop page. Build clean.","dependencies":[{"issue_id":"stackdocs-m7b.4.12.3","depends_on_id":"stackdocs-m7b.4.12","type":"parent-child","created_at":"2026-02-12T13:09:59.955582+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.12.3","depends_on_id":"stackdocs-m7b.4.12.1","type":"blocks","created_at":"2026-02-12T13:11:09.968072+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.12.4","title":"Infinite canvas viewport","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T13:10:02.906271+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T14:16:12.619322+11:00","closed_at":"2026-02-12T14:16:12.619322+11:00","close_reason":"Infinite canvas viewport with pan/zoom, pointer capture, zoom-under-cursor math. Ported from spatial-glass-prototype reference. Build clean.","dependencies":[{"issue_id":"stackdocs-m7b.4.12.4","depends_on_id":"stackdocs-m7b.4.12","type":"parent-child","created_at":"2026-02-12T13:10:02.907433+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.12.4","depends_on_id":"stackdocs-m7b.4.12.1","type":"blocks","created_at":"2026-02-12T13:11:10.110762+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.12.4","depends_on_id":"stackdocs-m7b.4.12.2","type":"blocks","created_at":"2026-02-12T13:11:10.262218+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.12.5","title":"Desktop card component","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T13:10:05.840981+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T15:35:27.780506+11:00","closed_at":"2026-02-12T15:35:27.780506+11:00","close_reason":"Desktop card component + viewport zoom/pan polish","dependencies":[{"issue_id":"stackdocs-m7b.4.12.5","depends_on_id":"stackdocs-m7b.4.12","type":"parent-child","created_at":"2026-02-12T13:10:05.841896+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.12.5","depends_on_id":"stackdocs-m7b.4.12.2","type":"blocks","created_at":"2026-02-12T13:11:10.432415+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.12.5","depends_on_id":"stackdocs-m7b.4.12.4","type":"blocks","created_at":"2026-02-12T13:11:10.596067+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.12.6","title":"WebSocket provider + canvas_update wiring","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T13:10:08.97183+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T18:03:29.807295+11:00","closed_at":"2026-02-12T18:03:29.807295+11:00","close_reason":"WS provider + canvas_update wiring complete. 3 files: ws-provider.tsx (131 lines), auto-placer.ts (42 lines), page.tsx updated. Inspector 7/7 pass.","dependencies":[{"issue_id":"stackdocs-m7b.4.12.6","depends_on_id":"stackdocs-m7b.4.12","type":"parent-child","created_at":"2026-02-12T13:10:08.973072+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.12.6","depends_on_id":"stackdocs-m7b.4.12.2","type":"blocks","created_at":"2026-02-12T13:11:10.745708+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.12.7","title":"Top bar (three floating pills)","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T13:10:12.336727+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T15:47:10.418369+11:00","closed_at":"2026-02-12T15:47:10.418369+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.12.7","depends_on_id":"stackdocs-m7b.4.12","type":"parent-child","created_at":"2026-02-12T13:10:12.339332+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.12.7","depends_on_id":"stackdocs-m7b.4.12.1","type":"blocks","created_at":"2026-02-12T13:11:10.886968+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.12.7","depends_on_id":"stackdocs-m7b.4.12.2","type":"blocks","created_at":"2026-02-12T13:11:11.038997+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.12.8","title":"Chat bar (bottom pill)","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T13:10:15.640852+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T21:19:12.737569+11:00","closed_at":"2026-02-12T21:19:12.737569+11:00","close_reason":"Chat bar complete. Glass rounded-3xl, 500px, voice-forward design with GlassButton icons, glass tooltips, suggestion chips above, textarea with send button.","dependencies":[{"issue_id":"stackdocs-m7b.4.12.8","depends_on_id":"stackdocs-m7b.4.12","type":"parent-child","created_at":"2026-02-12T13:10:15.646952+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.12.8","depends_on_id":"stackdocs-m7b.4.12.2","type":"blocks","created_at":"2026-02-12T13:11:11.187713+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.12.8","depends_on_id":"stackdocs-m7b.4.12.6","type":"blocks","created_at":"2026-02-12T13:11:11.338796+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.12.9","title":"Restyle card-renderer for glass","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T13:10:18.914029+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T10:36:18.080332+11:00","closed_at":"2026-02-13T10:36:18.080332+11:00","close_reason":"BlockRenderer created (146 lines), all 8 block types, glass styling, wired into page.tsx. Inspector 10/10.","dependencies":[{"issue_id":"stackdocs-m7b.4.12.9","depends_on_id":"stackdocs-m7b.4.12","type":"parent-child","created_at":"2026-02-12T13:10:18.919256+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.12.9","depends_on_id":"stackdocs-m7b.4.12.5","type":"blocks","created_at":"2026-02-12T13:11:11.48656+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.13","title":"Agent model ignores size param, still passes card_type","description":"The Claude model (Sonnet via SDK) still passes card_type: 'notes'/'table'/'document' when calling create_card, ignoring the size parameter entirely. The code works — card_type is ignored, size defaults to 'medium', cards render fine. But the model never chooses small/large/full.\n\nVerified: deployed code has correct tool schema ({'title': str, 'size': str, 'blocks': list}), description mentions size, os.md has size guidance. Model appears to have strong training priors for card_type.\n\nPossible fixes:\n- Add 'NOTE: Do NOT use card_type. Use size instead.' to tool description\n- Investigate how @tool decorator surfaces params to the model (SDK internals)\n- Try stronger system prompt reinforcement in os.md\n- Test with a fresh Sprite (no conversation history)\n\nNon-blocking: cards work correctly with medium default.","status":"open","priority":2,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-13T14:03:39.953263+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T14:03:49.800242+11:00","dependencies":[{"issue_id":"stackdocs-m7b.4.13","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-13T14:03:39.970899+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.14","title":"Chat history disappears on page refresh","description":"Chat messages are lost on page refresh because chat-store.ts uses Zustand WITHOUT persist middleware. Desktop-store has persist (localStorage key 'stackdocs-desktop'), but chat-store does not. Fix: add persist middleware to chat-store, matching the desktop-store pattern. Alternatively, rely on state_sync from the Sprite to restore chat history on reconnect — but that only works when the Sprite is online.","status":"open","priority":2,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-14T09:51:29.113859+11:00","created_by":"thebrownproject","updated_at":"2026-02-14T09:51:36.413427+11:00","dependencies":[{"issue_id":"stackdocs-m7b.4.14","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-14T09:51:29.115335+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15","title":"Chat Bar \u0026 Voice Interaction Redesign","description":"Unify voice input into the textarea, reposition the pill inline left of the orb, and fix all voice system bugs found in audit.\n\n**Spec:** .space-agents/exploration/planned/2026-02-15-chat-bar-voice-redesign/spec.md\n**Plan:** .space-agents/exploration/planned/2026-02-15-chat-bar-voice-redesign/plan.md\n\n8 tasks: 4 parallel bug fixes (STT, TTS, VoiceBars, test assertions) + 4 sequential UX tasks (voice-provider, strip orb pill, build chatbar pill, integration test).","status":"in_progress","priority":1,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-15T15:29:55.421192+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T15:50:37.693034+11:00","dependencies":[{"issue_id":"stackdocs-m7b.4.15","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-15T15:29:55.424009+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.1","title":"Fix STT bugs (race condition, guards, error handlers, token TTL)","description":"**Goal:** Eliminate orphaned mic streams, Deepgram connections, and keepAlive intervals caused by rapid start/stop, error events, and close events. Increase token TTL for longer recordings.\n\n**Files:**\n- Modify: `frontend/components/voice/use-stt.ts`\n- Modify: `frontend/app/api/voice/deepgram-token/route.ts`\n- Modify: `frontend/components/voice/__tests__/use-stt.test.ts`\n\n**Steps:**\n1. Add generation counter (generationRef) to startListening — stale async callbacks become no-ops\n2. Add double-invocation guard: if (connectionRef.current || recorderRef.current) return\n3. Add AbortController with 10s timeout on /api/voice/deepgram-token fetch\n4. Deepgram Error handler: call full stopListening() cleanup (not just setError)\n5. Deepgram Close handler: stop MediaRecorder + release mic tracks\n6. Token TTL in deepgram-token/route.ts: 30s → 120s\n\n**Tests:**\n- [ ] startListening while already listening returns immediately\n- [ ] Rapid start/stop/start: first session cleaned up, second works\n- [ ] Token fetch timeout after 10s sets error state\n- [ ] Deepgram error event triggers full stopListening cleanup\n- [ ] Deepgram close event releases mic tracks and MediaRecorder\n- [ ] Token TTL is 120s\n\n**Plan ref:** Task A in plan.md","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-15T15:30:10.077276+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T15:55:18.910894+11:00","closed_at":"2026-02-15T15:55:18.910894+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.15.1","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-15T15:30:10.07954+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.10","title":"STT startup lag — first words cut off due to sequential init","description":"When the user presses the record button, there's a ~700-1600ms delay before audio is actually captured, causing the first 1-2 words to be cut off. Root cause: token fetch, getUserMedia, and Deepgram WS handshake are all sequential in use-stt.ts. Fix: (1) parallelize token fetch + getUserMedia, (2) start MediaRecorder immediately after mic ready and buffer audio until Deepgram WS opens.","status":"closed","priority":1,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-15T21:44:55.220892+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T22:05:35.345026+11:00","closed_at":"2026-02-15T22:05:35.345026+11:00","close_reason":"Both fixes implemented: (1) parallelized token+mic init, (2) audio buffered before WS open. Startup latency reduced from ~700-1600ms to ~300-500ms. 15/15 tests passing.","dependencies":[{"issue_id":"stackdocs-m7b.4.15.10","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-15T21:44:55.227759+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.15.10","depends_on_id":"stackdocs-e2p","type":"blocks","created_at":"2026-02-15T21:46:25.123153+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.15.10","depends_on_id":"stackdocs-fb9","type":"blocks","created_at":"2026-02-15T21:46:25.263084+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.11","title":"TTS audio blocked after STT use — dual AudioContext conflict","description":"TTS works when user types, but after using STT (speech-to-text), TTS no longer produces audio. Root cause: STT creates an AudioContext (for VoiceBars analyser) that competes with TTS AudioContext (24kHz) for speaker output. Closing STT context in stopListening didn't fully fix it — likely the warm mic stream or something else is still holding the audio device. Options to try: (1) share a single AudioContext between STT and TTS (pass from voice-provider), (2) fully release all audio resources between STT stop and TTS start, (3) suspend STT context instead of close. See exploration agent findings from session 177.","status":"closed","priority":1,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-15T22:48:40.025907+11:00","created_by":"thebrownproject","updated_at":"2026-02-17T20:26:39.725738+11:00","closed_at":"2026-02-17T20:26:39.725738+11:00","close_reason":"Fixed by shared audio-engine.ts — single AudioContext for both STT and TTS","dependencies":[{"issue_id":"stackdocs-m7b.4.15.11","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-15T22:48:40.03057+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.12","title":"STT Connecting UX + Word-Loss Fix","description":"Add a `connecting` state to the voice FSM. Show spinner during Deepgram WS setup, delay MediaRecorder until WS Open (fixing word loss on 2nd+ recordings), remove audio buffer mechanism entirely.\n\n**Problem:** Words lost on 2nd+ recordings because SDK load delay (1st recording only) accidentally masks audio pipeline warmup time. No visual feedback during connection setup.\n\n**Solution:** New `connecting` PersonaState between idle and listening. Spinner in chat bar during connecting. MediaRecorder starts only after WS Open. Zero buffering.\n\n**Spec:** .space-agents/exploration/planned/2026-02-16-stt-connecting-ux/spec.md\n**Plan:** .space-agents/exploration/planned/2026-02-16-stt-connecting-ux/plan.md","status":"closed","priority":1,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-16T20:55:33.75503+11:00","created_by":"thebrownproject","updated_at":"2026-02-16T21:42:16.004218+11:00","closed_at":"2026-02-16T21:42:16.004218+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.15.12","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-16T20:55:33.76251+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.13","title":"Add connecting state to voice-store FSM","description":"**Feature:** STT Connecting UX + Word-Loss Fix (m7b.4.15.12)\n\n**Goal:** Add 'connecting' to PersonaState union type and update VALID_TRANSITIONS to enforce idle → connecting → listening (removing direct idle → listening).\n\n**Files:**\n- Modify: lib/stores/voice-store.ts\n- Modify: lib/stores/__tests__/voice-store.test.ts\n\n**Steps:**\n1. Write failing tests: connecting transitions, idle→listening rejection, update allStates array\n2. Add 'connecting' to PersonaState type\n3. Update VALID_TRANSITIONS: idle: ['connecting', 'thinking'], connecting: ['listening', 'idle']\n4. Verify all tests pass\n\n**Tests:**\n- [ ] idle → connecting succeeds\n- [ ] connecting → listening succeeds\n- [ ] connecting → idle succeeds (cancel path)\n- [ ] idle → listening is rejected (must go through connecting)\n- [ ] All existing valid transitions still pass","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-16T20:56:14.900277+11:00","created_by":"thebrownproject","updated_at":"2026-02-16T21:12:05.239161+11:00","closed_at":"2026-02-16T21:12:05.239161+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.15.13","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-16T20:56:14.90276+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.14","title":"Refactor use-stt — onOpen callback, remove buffer, delay MediaRecorder","description":"**Feature:** STT Connecting UX + Word-Loss Fix (m7b.4.15.12)\n\n**Goal:** Add optional onOpen callback to startListening(), move recorder.start(100) into WS Open handler, remove entire buffer mechanism. Audio goes directly to Deepgram with zero buffering.\n\n**Files:**\n- Modify: components/voice/use-stt.ts\n- Modify: components/voice/__tests__/use-stt.test.ts\n\n**Steps:**\n1. Write failing tests: MediaRecorder not started until WS Open, onOpen fires, direct send, isListening after WS Open\n2. Add onOpen?: () =\u003e void parameter to startListening\n3. Remove audioBufferRef and wsOpenRef refs entirely\n4. Construct MediaRecorder eagerly but move .start(100) into WS Open handler\n5. In Open handler: stale check, stream.active check, recorder.start(100), setIsListening(true), keepalive, onOpen?.()\n6. Simplify ondataavailable to just connection.send(e.data)\n7. Keep connectAnalyser() before WS, token pre-fetch, generation guards\n\n**Tests:**\n- [ ] MediaRecorder NOT started until WS Open\n- [ ] onOpen callback fires when WS opens\n- [ ] ondataavailable sends directly (no buffer)\n- [ ] isListening true only after WS Open\n- [ ] audioBufferRef and wsOpenRef do not exist","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-16T20:56:18.298839+11:00","created_by":"thebrownproject","updated_at":"2026-02-16T21:24:54.412367+11:00","closed_at":"2026-02-16T21:24:54.412367+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.15.14","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-16T20:56:18.300549+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.15.14","depends_on_id":"stackdocs-m7b.4.15.13","type":"blocks","created_at":"2026-02-16T20:56:37.727732+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.15","title":"Update voice-provider — connecting state + onOpen callback","description":"**Feature:** STT Connecting UX + Word-Loss Fix (m7b.4.15.12)\n\n**Goal:** Wire startVoice to set personaState('connecting') on start and pass onOpen callback to startListening that transitions to 'listening'. Handle cancel during connecting.\n\n**Files:**\n- Modify: components/voice/voice-provider.tsx\n- Modify: components/voice/__tests__/voice-provider.test.tsx\n\n**Steps:**\n1. Write failing tests: startVoice sets connecting, onOpen transitions to listening, cancel from connecting\n2. In startVoice: change setPersonaState('listening') to setPersonaState('connecting')\n3. Pass onOpen callback: startListening(() =\u003e useVoiceStore.getState().setPersonaState('listening'))\n4. Verify stopRecordingOnly works from both connecting and listening\n5. Update existing tests that expect 'listening' immediately after startVoice\n\n**Tests:**\n- [ ] startVoice() sets personaState to 'connecting'\n- [ ] After WS opens (onOpen), personaState transitions to 'listening'\n- [ ] stopRecordingOnly() from 'connecting' transitions to 'idle'\n- [ ] Full flow: idle → connecting → listening → thinking → speaking → idle","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-16T20:56:21.178885+11:00","created_by":"thebrownproject","updated_at":"2026-02-16T21:30:49.91569+11:00","closed_at":"2026-02-16T21:30:49.91569+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.15.15","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-16T20:56:21.180433+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.15.15","depends_on_id":"stackdocs-m7b.4.15.14","type":"blocks","created_at":"2026-02-16T20:56:37.884158+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.16","title":"Update persona-orb — connecting state mapping","description":"**Feature:** STT Connecting UX + Word-Loss Fix (m7b.4.15.12)\n\n**Goal:** Map 'connecting' to Rive 'listening' animation, show 'Connecting...' tooltip, allow tap-to-cancel during connecting.\n\n**Files:**\n- Modify: components/voice/persona-orb.tsx\n- Modify: components/voice/__tests__/persona-orb.test.tsx\n\n**Steps:**\n1. Write failing tests: toRiveState mapping, tooltip, tap-to-cancel, pointer events\n2. Add connecting → listening in toRiveState()\n3. Add 'Connecting...' tooltip for connecting state\n4. Add connecting case in handleTap (fall through to listening — tap-to-cancel)\n5. Verify orb is interactive during connecting\n\n**Tests:**\n- [ ] toRiveState('connecting') returns 'listening'\n- [ ] Tooltip shows 'Connecting...'\n- [ ] Tap when connecting + no text calls stopRecordingOnly\n- [ ] Tap when connecting + hasText calls onSendMessage\n- [ ] Orb interactive during connecting","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-16T20:56:23.768313+11:00","created_by":"thebrownproject","updated_at":"2026-02-16T21:24:54.439298+11:00","closed_at":"2026-02-16T21:24:54.439298+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.15.16","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-16T20:56:23.769436+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.15.16","depends_on_id":"stackdocs-m7b.4.15.13","type":"blocks","created_at":"2026-02-16T20:56:38.050077+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.17","title":"Update chat-bar — spinner, controls, input wiring for connecting","description":"**Feature:** STT Connecting UX + Word-Loss Fix (m7b.4.15.12)\n\n**Goal:** Show Loader2 spinner during connecting, VoiceBars during listening. Controls visible during connecting. Textarea expands, Escape cancels, Send stops voice, transcript only during listening, linger on cancel.\n\n**Files:**\n- Modify: components/desktop/chat-bar.tsx\n- Modify: components/desktop/__tests__/chat-bar.test.tsx\n\n**Steps:**\n1. Write failing tests: spinner, VoiceBars, stop button, Escape, Send, expand, linger\n2. Derive isConnecting from personaState === 'connecting'\n3. Update controlsVisible: isListening || isConnecting || showControls || lingerVisible\n4. Conditional render: connecting → Loader2 animate-spin; listening → VoiceBars\n5. Stop button visible during both connecting and listening\n6. handleSend: stop voice during connecting\n7. Escape handler: cancel during connecting\n8. Textarea expand on isListening || isConnecting\n9. Transcript delta-append gated on isListening only\n10. Caret-transparent during connecting\n11. Typing during connecting calls stopRecordingOnly\n\n**Tests:**\n- [ ] Spinner visible during connecting\n- [ ] VoiceBars during listening\n- [ ] Stop button during connecting\n- [ ] Escape cancels during connecting\n- [ ] Send stops voice during connecting\n- [ ] Textarea expands during connecting\n- [ ] Transcript only during listening\n- [ ] Linger on connecting → idle","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-16T20:56:27.793824+11:00","created_by":"thebrownproject","updated_at":"2026-02-16T21:42:15.978171+11:00","closed_at":"2026-02-16T21:42:15.978171+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.15.17","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-16T20:56:27.795485+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.15.17","depends_on_id":"stackdocs-m7b.4.15.15","type":"blocks","created_at":"2026-02-16T20:56:38.213591+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.2","title":"Fix TTS error surfacing","description":"**Goal:** Add error state to TTS hook so failures are observable instead of silently swallowed.\n\n**Files:**\n- Modify: `frontend/components/voice/use-tts.ts`\n- Modify: `frontend/components/voice/__tests__/use-tts.test.ts`\n\n**Steps:**\n1. Add const [error, setError] = useState\u003cstring | null\u003e(null) to useTTS\n2. Clear error at start of speak()\n3. Set error on fetch failures (!response.ok) and non-AbortError exceptions\n4. Add error to return object: { speak, interrupt, isSpeaking, error }\n\n**Tests:**\n- [ ] error is initially null\n- [ ] When fetch returns non-ok, error is set and isSpeaking is false\n- [ ] error resets to null when speak() called again\n- [ ] Existing tests still pass\n\n**Plan ref:** Task B in plan.md","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-15T15:30:14.716913+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T15:58:13.326241+11:00","closed_at":"2026-02-15T15:58:13.326241+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.15.2","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-15T15:30:14.7179+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.3","title":"Fix VoiceBars performance (60fps → 15fps)","description":"**Goal:** Reduce React re-renders from ~60fps to ~15fps by throttling state updates.\n\n**Files:**\n- Modify: `frontend/components/voice/voice-bars.tsx`\n- Create: `frontend/components/voice/__tests__/voice-bars.test.tsx`\n\n**Steps:**\n1. Add lastUpdateRef timestamp tracker\n2. Gate setLevels() to fire only every ~66ms (performance.now comparison)\n3. Remove transition-[height] duration-75 CSS from bar divs\n4. Create voice-bars.test.tsx with basic rendering tests\n\n**Tests:**\n- [ ] Renders 4 bar divs\n- [ ] No transition-[height] class in output\n- [ ] setLevels called at most ~15 times per second\n\n**Plan ref:** Task C in plan.md","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-15T15:30:19.497079+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T16:01:43.66444+11:00","closed_at":"2026-02-15T16:01:43.66444+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.15.3","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-15T15:30:19.498657+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.4","title":"Fix persona-orb test assertions","description":"**Goal:** Correct two wrong test expectations so test suite reflects actual toRiveState behavior.\n\n**Files:**\n- Modify: `frontend/components/voice/__tests__/persona-orb.test.tsx`\n\n**Steps:**\n1. Line ~80: Change expected from 'thinking' to 'idle' (toRiveState('idle') returns 'idle')\n2. Line ~162: Change expected from 'thinking' to 'idle' (toRiveState('asleep') returns 'idle')\n3. Update comments to match\n4. Run tests to verify all 10 pass\n\n**Tests:**\n- [ ] All 10 persona-orb tests pass\n- [ ] Assertions match actual toRiveState behavior\n\n**Plan ref:** Task D in plan.md","status":"closed","priority":3,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-15T15:30:23.221823+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T16:06:04.258266+11:00","closed_at":"2026-02-15T16:06:04.258266+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.15.4","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-15T15:30:23.223137+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.5","title":"Add stopRecordingOnly, voiceSessionActive, WS disconnect cleanup","description":"**Goal:** Create new voice-provider functions that Tasks F and G depend on. Gate TTS so it only fires for voice-initiated interactions.\n\n**Files:**\n- Modify: `frontend/components/voice/voice-provider.tsx`\n- Modify: `frontend/components/voice/__tests__/voice-provider.test.tsx`\n\n**Steps:**\n1. Add voiceSessionRef = useRef(false). Set true in startVoice(), false in stopVoice() and stopRecordingOnly()\n2. Create stopRecordingOnly(): calls stopListening(), sets persona to idle, does NOT clear transcript, does NOT send message\n3. Gate TTS trigger: wrap speak() call with if (ttsEnabled \u0026\u0026 voiceSessionRef.current)\n4. WS disconnect: add stopListening() before setPersonaState('asleep')\n5. Export stopRecordingOnly via VoiceContextValue\n\nKey difference stopRecordingOnly vs stopVoice:\n- stopRecordingOnly: stop STT, set idle, keep transcript, no send (edit path)\n- stopVoice: stop STT, send message, clear transcript, set thinking (send path)\n\n**Tests:**\n- [ ] stopRecordingOnly calls stopListening, sets idle, does NOT send message\n- [ ] stopRecordingOnly does NOT clear voiceStore.transcript\n- [ ] TTS does NOT trigger for text-typed messages\n- [ ] TTS DOES trigger for voice-initiated messages\n- [ ] WS disconnect calls stopListening\n- [ ] voiceSessionRef false after stopVoice and stopRecordingOnly\n\n**Plan ref:** Task E in plan.md","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-15T15:30:31.628736+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T16:24:35.671551+11:00","closed_at":"2026-02-15T16:24:35.671551+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.15.5","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-15T15:30:31.631054+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.6","title":"Strip floating pill from PersonaOrb","description":"**Goal:** Simplify PersonaOrb to orb-only. Remove all pill UI, hover timer, transcript display, mic toggle, VoiceBars.\n\n**Files:**\n- Modify: `frontend/components/voice/persona-orb.tsx`\n- Modify: `frontend/components/voice/__tests__/persona-orb.test.tsx`\n\n**Steps:**\n1. Remove imports: GlassPill, GlassIconButton, GlassTooltip/Trigger/Content, VoiceBars, Icons\n2. Remove state/refs: showPill, hoverTimer, micEnabled, toggleMic, transcript, ttsEnabled, toggleTts\n3. Remove hover handlers: handleMouseEnter, handleMouseLeave, HOVER_DELAY constants\n4. Remove entire pill div (absolute bottom-full positioned div, lines ~106-141)\n5. Update tap handler:\n   - listening + hasText → call onSendMessage() (ChatBar handles stopVoice)\n   - listening + no text → call stopRecordingOnly() (stop mic, go idle)\n   - idle → startVoice (unchanged)\n   - speaking → interruptTTS (unchanged)\n6. Rewrite tests for orb-only behavior\n\n**Tests:**\n- [ ] No GlassPill, VoiceBars, or transcript elements rendered\n- [ ] Tap idle → startVoice\n- [ ] Tap listening + no text → stopRecordingOnly\n- [ ] Tap listening + hasText → onSendMessage\n- [ ] Tap speaking → interruptTTS\n- [ ] Asleep → pointer-events-none\n\n**Plan ref:** Task F in plan.md","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-15T15:30:39.887673+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T16:35:27.276625+11:00","closed_at":"2026-02-15T16:35:27.276625+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.15.6","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-15T15:30:39.889151+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.15.6","depends_on_id":"stackdocs-m7b.4.15.5","type":"blocks","created_at":"2026-02-15T15:31:15.331912+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.7","title":"Build inline pill in ChatBar + wire STT transcript to textarea","description":"**Goal:** Core UX task. Build new pill inline left of orb, wire voice transcript into textarea, add Escape key and stop button.\n\n**Files:**\n- Modify: `frontend/components/desktop/chat-bar.tsx`\n- Modify: `frontend/components/desktop/__tests__/chat-bar.test.tsx`\n\n**Part 1: Wire STT transcript into textarea**\n1. Subscribe to voiceStore.transcript + add prevTranscriptRef\n2. useEffect: when transcript grows during 'listening', append delta to inputValue (not replace)\n3. Auto-expand textarea when recording starts (setInputActive(true), focus)\n4. Reset prevTranscriptRef when leaving 'listening' state\n5. onChange during recording: call stopRecordingOnly() instead of stopVoice()\n6. handleSend during recording: stop STT first, then send inputValue, clear transcript\n\n**Part 2: Build inline pill**\n7. Add pill state + hover delay logic (moved from PersonaOrb)\n8. pillVisible = isRecording || showPill\n9. Render GlassPill in action bar flex row, LEFT of orb spacer div:\n   - Always: speaker toggle (GlassIconButton)\n   - Recording only: stop button (GlassIconButton) + VoiceBars\n   - Layout order: [🔊 speaker] [■ stop] [|||| bars] [orb]\n10. Import GlassPill, VoiceBars, Icons (Volume, VolumeOff, PlayerStop)\n\n**Part 3: Escape key**\n11. In handleKeyDown: if (Escape \u0026\u0026 listening) → stopRecordingOnly()\n\n**Part 4: Verify no mic toggle**\n12. New pill only has speaker toggle, stop, bars. No mic toggle anywhere.\n\n**Tests:**\n- [ ] Transcript appears in textarea during recording\n- [ ] User can edit textarea while recording\n- [ ] Escape during recording → stopRecordingOnly\n- [ ] Enter sends message (unchanged)\n- [ ] Stop button → stopRecordingOnly\n- [ ] Pill shows speaker on hover (idle)\n- [ ] Pill shows speaker+stop+bars during recording\n- [ ] Pill hidden when not hovered and not recording\n- [ ] handleSend during recording stops STT first\n- [ ] No mic toggle rendered\n- [ ] Embedded mode (400px) works\n\n**Plan ref:** Task G in plan.md","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-15T15:30:50.44238+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T16:53:59.607271+11:00","closed_at":"2026-02-15T16:53:59.607271+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.15.7","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-15T15:30:50.443804+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.15.7","depends_on_id":"stackdocs-m7b.4.15.5","type":"blocks","created_at":"2026-02-15T15:31:15.462335+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.15.7","depends_on_id":"stackdocs-m7b.4.15.6","type":"blocks","created_at":"2026-02-15T15:31:15.592+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.8","title":"Integration smoke test — full suite + manual verification","description":"**Goal:** Run full test suite, fix breakage, verify all success criteria.\n\n**Steps:**\n1. npm run test:run from frontend/ — fix any failures\n2. npx tsc --noEmit — fix TypeScript errors\n3. Manual checklist:\n   - [ ] Voice transcript appears in textarea as user speaks\n   - [ ] User can edit transcript while recording\n   - [ ] Orb tap during recording sends immediately\n   - [ ] Stop button/Escape keeps text for editing\n   - [ ] No floating pill above orb\n   - [ ] Pill left of orb: speaker (idle), speaker+stop+bars (recording)\n   - [ ] Rapid double-tap doesn't orphan mic\n   - [ ] WS disconnect releases mic\n   - [ ] TTS only for voice interactions\n   - [ ] Recordings \u003e30s work\n   - [ ] Standalone + embedded modes work\n\n**Plan ref:** Task H in plan.md","status":"open","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-15T15:30:54.28676+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T15:30:54.28676+11:00","dependencies":[{"issue_id":"stackdocs-m7b.4.15.8","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-15T15:30:54.287735+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.15.8","depends_on_id":"stackdocs-m7b.4.15.7","type":"blocks","created_at":"2026-02-15T15:31:15.724697+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.15.9","title":"TTS audio not playing — speak() called but no sound output","description":"## Problem\nTTS PCM streaming has audible clipping/popping for the first ~200-300ms of playback. Persists across all fix attempts.\n\n## What was tried (Session 182)\n1. **Increased worklet fade-in** (480→3600 samples / 20ms→150ms) — made it WORSE\n2. **Increased pre-buffer** (1200→4800 samples / 50ms→200ms) — made it WORSE\n3. **Moved pre-buffer inside worklet** — discovered process() runs before node.connect(), so fade-in was consumed before audio reached speakers. Fixed this but still clipped.\n4. **GainNode fade-in** — replaced manual per-sample fade with GainNode.gain.linearRampToValueAtTime(). Sample-accurate, audio thread. Still clipped.\n5. **Byte alignment fix** — copied ReadableStream chunks to fresh aligned buffer before Int16Array view (byteOffset may be odd). Still clipped.\n\n## Root cause unknown — theories remaining\n- OpenAI gpt-4o-mini-tts PCM output may have inherent onset artifacts\n- Browser AudioContext sample rate negotiation at 24kHz may cause transient\n- May need to switch from raw PCM to a codec format (mp3/opus) that browsers decode natively\n- Could try response_format: 'wav' (skip 44-byte header, same PCM after) to test if format matters\n- Could try logging first N samples to verify PCM data integrity\n\n## Constraints\n- Must keep streaming (can't download full response before playing)\n- Current format: response_format='pcm' → raw 24kHz 16-bit signed LE\n- AudioWorklet approach is correct for streaming PCM, issue is elsewhere\n\n## Files\n- frontend/components/voice/use-tts.ts — speak(), streamPCMToWorklet(), AudioWorklet setup\n- frontend/components/voice/audio-engine.ts — PcmStreamPlayer worklet, shared AudioContext\n- frontend/app/api/voice/tts/route.ts — OpenAI TTS proxy (confirmed working)","status":"closed","priority":1,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-15T19:56:22.129511+11:00","created_by":"thebrownproject","updated_at":"2026-02-17T07:34:40.266838+11:00","closed_at":"2026-02-17T07:34:40.266838+11:00","close_reason":"Fixed: moved pre-buffering into AudioWorklet (14400 samples/600ms), connect immediately, worklet buffers internally. Root cause was OpenAI TTS burst-then-pause streaming pattern causing underrun at 200ms.","dependencies":[{"issue_id":"stackdocs-m7b.4.15.9","depends_on_id":"stackdocs-m7b.4.15","type":"parent-child","created_at":"2026-02-15T19:56:22.134769+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.16","title":"Card content rendering artifacts — text overflow and layout issues","description":"Two issues:\n\n1. **Card content overflow** — Text overflow in key-value pairs, tables, and text blocks. Needs overflow-hidden on content container, min-w-0 on flex children, break-words on text.\n\n2. **Glass glow artifact (Chrome GPU compositor bug)** — backdrop-filter: blur() on glass elements creates visible lighter rectangles over mesh gradient wallpapers. CONFIRMED: removing backdrop-blur eliminates the glow. Position-dependent: left/top fine, right/bottom shows glow with SAME component and CSS. Gemini CLI identified as Compositor Capture Truncation — Chrome captures backdrop into viewport-sized buffer, blur kernel samples past right/bottom edge hitting window clear color. ALL attempted fixes FAILED: reducing blur radius, backdrop-brightness, backdrop-saturate, bg-black on page container, removing will-change:transform, removing grain overlay, Tailwind arbitrary backdrop-filter values, html bg #000, isolation:isolate on page container, transform-gpu on glass panels, transform-gpu on cards. Needs hands-on Chrome DevTools Layers panel debugging.","status":"open","priority":2,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-17T07:38:51.460327+11:00","created_by":"thebrownproject","updated_at":"2026-02-17T21:26:07.358264+11:00","dependencies":[{"issue_id":"stackdocs-m7b.4.16","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-17T07:38:51.461931+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.17","title":"Canvas card template system","description":"Replace the current \"dump everything\" card model with a 5-template system (Document, Metric, Table, Article, Data) where canvas cards show summaries and full content opens in a full-screen overlay.\n\n**Spec:** .space-agents/exploration/ideas/2026-02-20-canvas-card-templates/spec.md\n**Plan:** .space-agents/exploration/ideas/2026-02-20-canvas-card-templates/plan.md\n**Prototype:** docs/references/canvas-card-prototype/\n\nKey changes:\n- 5 card templates with distinct visual treatments (40px radius, editorial aesthetic)\n- Agent picks template + writes summary + sends full blocks\n- Click card to open full-screen overlay with all extracted content\n- Template-default colors with agent override from 9-color palette\n- Spike if/else code replaced with clean template dispatcher","status":"closed","priority":1,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-20T13:53:25.33065+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T19:11:17.328748+11:00","closed_at":"2026-02-20T19:11:17.328748+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.17","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-20T13:53:25.336441+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.17.1","title":"Add card template fields to protocol","description":"**Goal:** Extend WebSocket protocol across all 3 codebases with card_type, summary, tags, color, and template-specific fields.\n\n**Files:**\n- bridge/src/protocol.ts (source of truth)\n- frontend/types/ws-protocol.ts (frontend copy)\n- sprite/src/protocol.py (Python dataclasses)\n\n**Steps:**\n1. Add CardType union type and CARD_TYPES constant\n2. Add optional fields to CanvasUpdate.payload and CardInfo: card_type, summary, tags, color, type_badge, date, value, trend, trend_direction, author, read_time, headers, preview_rows\n3. Update isCanvasUpdate type guard (validate card_type when present, accept undefined)\n4. Copy to frontend ws-protocol.ts\n5. Update Python protocol.py dataclasses and validators\n6. Run bridge tests (all 136 should pass)\n\n**Tests:**\n- [ ] Bridge TypeScript compiles, all tests pass\n- [ ] isCanvasUpdate validates messages with/without new fields\n- [ ] Python to_json() serializes new fields correctly","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T13:53:44.503332+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T18:19:23.204656+11:00","closed_at":"2026-02-20T18:19:23.204656+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.17.1","depends_on_id":"stackdocs-m7b.4.17","type":"parent-child","created_at":"2026-02-20T13:53:44.505025+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.17.10","title":"Add Python protocol tests for card_type validation in is_canvas_update","status":"open","priority":3,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T18:19:19.552012+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T18:19:19.552012+11:00","dependencies":[{"issue_id":"stackdocs-m7b.4.17.10","depends_on_id":"stackdocs-m7b.4.17","type":"parent-child","created_at":"2026-02-20T18:19:19.553787+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.17.2","title":"Update Sprite canvas tools and database for templates","description":"**Goal:** Make Sprite agent able to create cards with template fields, persist in SQLite, include in state sync.\n\n**Files:**\n- sprite/src/tools/canvas.py\n- sprite/src/database.py\n- sprite/src/state_sync.py\n\n**Steps:**\n1. Add ALTER TABLE migration in WorkspaceDB for new columns (follow _migrate_card_position_columns pattern)\n2. Update upsert_card() to accept and persist new fields (tags/headers/preview_rows as JSON strings)\n3. Rewrite create_card tool: accept card_type (required), summary, tags, color, template-specific fields\n4. Update state_sync.py to include new fields in CardInfo (json.loads for JSON columns)\n5. Smoke test with in-memory SQLite\n\n**Tests:**\n- [ ] create_card accepts card_type=\"document\" and includes in WS message\n- [ ] New DB columns created on fresh init and via ALTER TABLE\n- [ ] state_sync includes template fields in card payloads\n- [ ] JSON fields round-trip correctly through DB","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T13:53:48.509264+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T18:26:24.2826+11:00","closed_at":"2026-02-20T18:26:24.2826+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.17.2","depends_on_id":"stackdocs-m7b.4.17","type":"parent-child","created_at":"2026-02-20T13:53:48.510357+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.17.2","depends_on_id":"stackdocs-m7b.4.17.1","type":"blocks","created_at":"2026-02-20T13:54:52.694947+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.17.3","title":"Update frontend store and ws-provider for card fields","description":"**Goal:** Extend DesktopCard interface with template fields, update message handlers, bump Zustand persist version.\n\n**Files:**\n- frontend/lib/stores/desktop-store.ts\n- frontend/components/desktop/ws-provider.tsx\n\n**Steps:**\n1. Add CardType type and new optional fields to DesktopCard: cardType, summary, tags, color, typeBadge, date, value, trend, trendDirection, author, readTime, headers, previewRows\n2. Bump persist version 1-\u003e2 (no-op migration, all fields optional)\n3. Update ws-provider canvas_update handler (snake_case to camelCase mapping)\n4. Update ws-provider state_sync handler\n5. Verify via debug panel\n\n**Tests:**\n- [ ] DesktopCard type includes all new fields\n- [ ] ws-provider maps card_type to cardType, trend_direction to trendDirection, etc.\n- [ ] localStorage migration v1-\u003ev2 preserves existing cards\n- [ ] Cards without card_type get cardType: undefined","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T13:53:52.169572+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T18:26:44.702883+11:00","closed_at":"2026-02-20T18:26:44.702883+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.17.3","depends_on_id":"stackdocs-m7b.4.17","type":"parent-child","created_at":"2026-02-20T13:53:52.17087+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.17.3","depends_on_id":"stackdocs-m7b.4.17.1","type":"blocks","created_at":"2026-02-20T13:54:52.826552+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.17.4","title":"Build BaseCard wrapper and color system","description":"**Goal:** Shared card wrapper with 40px radius, p-8 padding, color palette, text-adapts-to-background.\n\n**Reference:** Port styling from `docs/references/canvas-card-prototype/src/components/cards/BaseCard.tsx`. Match the exact color hex values, border radius (rounded-[40px]), padding (p-8), shadow, and text color adaptation.\n\n**Files:**\n- Create frontend/components/desktop/cards/base-card.tsx\n- Create frontend/components/desktop/cards/colors.ts\n\n**Steps:**\n1. Read the prototype BaseCard.tsx first — use its exact colorStyles map, rounded-[40px], p-8, shadow-2xl\n2. Create colors.ts with the 9-color palette matching prototype hex values exactly: cream (#F2E9E4), white (#F8F9FA), yellow (#F2E8CF), green (#D8F3DC), pink (#FFD6E0), blue (#D7E3FC), orange (#FFD8BE), purple (#E2C6FF), dark (#121212)\n3. Add DEFAULT_TEMPLATE_COLORS map and getCardColor() helper\n4. Create BaseCard: rounded-[40px], p-8, background from palette, adaptive text color (dark text on light cards per prototype), shadow\n5. Add click discrimination to desktop-card.tsx: track pointer distance, onCardClick if \u003c 5px (must be in desktop-card.tsx due to pointer capture)\n\n**Tests:**\n- [ ] BaseCard renders correct background for each palette color (exact hex match to prototype)\n- [ ] Dark cards get light text, light cards get dark text\n- [ ] 40px radius and p-8 padding applied\n- [ ] Click \u003c 5px triggers onCardClick, \u003e= 5px triggers drag","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T13:53:55.489258+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T18:35:16.58105+11:00","closed_at":"2026-02-20T18:35:16.58105+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.17.4","depends_on_id":"stackdocs-m7b.4.17","type":"parent-child","created_at":"2026-02-20T13:53:55.490651+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.17.4","depends_on_id":"stackdocs-m7b.4.17.3","type":"blocks","created_at":"2026-02-20T13:54:52.96184+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.17.5","title":"Build 5 template card components","description":"**Goal:** Create Document, Metric, Table, Article, Data components rendering summary-only content. Port directly from the Gemini prototype.\n\n**Reference:** Port each component from its prototype equivalent in `docs/references/canvas-card-prototype/src/components/cards/`. Read each prototype file FIRST and match its exact layout, typography, spacing, and styling:\n- DocumentCard.tsx → document-card.tsx\n- MetricCard.tsx → metric-card.tsx  \n- TableCard.tsx (prototype) → table-card.tsx\n- LongTextCard.tsx (prototype) → article-card.tsx\n- DataCard.tsx → data-card.tsx\n\n**Files:**\n- Create frontend/components/desktop/cards/document-card.tsx\n- Create frontend/components/desktop/cards/metric-card.tsx\n- Create frontend/components/desktop/cards/table-card.tsx\n- Create frontend/components/desktop/cards/article-card.tsx\n- Create frontend/components/desktop/cards/data-card.tsx\n- Create frontend/components/desktop/cards/index.ts (barrel)\n\n**Steps:**\n1. Read ALL 5 prototype card files before writing any code\n2. DocumentCard (400px, cream): match prototype exactly — type badge pill with FileText icon, date mono text, text-4xl bold title, text-lg summary, tag pills with border, dark \"Read Report\" CTA button with ArrowUpRight\n3. MetricCard (300px, green, h-[340px]): match prototype — title badge pill, text-6xl bold value, trend with TrendingUp/Down icon, decorative bar chart (7 static bars with hover effect)\n4. TableCard (600px, dark): match prototype — text-2xl title with ArrowUpRight button, table with th mono uppercase headers, td text-sm rows, entry count + \"Synced just now\" footer\n5. ArticleCard (500px, white, h-[600px]): match prototype LongTextCard — \"Article\" badge, read time mono, text-4xl title, subtitle, scrollable prose body, author with avatar circle\n6. DataCard (400px, yellow): match prototype — title with ArrowUpRight, table in rounded border with bg-white/50, Export CSV + Edit Data buttons\n7. Create barrel export index.ts\n8. Each receives card: DesktopCard + onCardClick callback. Map DesktopCard fields to prototype props.\n\n**Tests:**\n- [ ] Each template renders summary slots correctly\n- [ ] All handle missing optional fields gracefully\n- [ ] CTA buttons call onCardClick with stopPropagation\n- [ ] Visual fidelity matches prototype reference — same font sizes, spacing, colors, border styles","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T13:54:09.50538+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T18:41:32.63636+11:00","closed_at":"2026-02-20T18:41:32.63636+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.17.5","depends_on_id":"stackdocs-m7b.4.17","type":"parent-child","created_at":"2026-02-20T13:54:09.506646+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.17.5","depends_on_id":"stackdocs-m7b.4.17.4","type":"blocks","created_at":"2026-02-20T13:54:53.087343+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.17.6","title":"Rewrite desktop-card as template dispatcher","description":"**Goal:** Replace spike if/else branches with switch on cardType. Remove spike imports.\n\n**Files:**\n- Modify frontend/components/desktop/desktop-card.tsx\n- Modify frontend/app/(desktop)/desktop/page.tsx\n\n**Steps:**\n1. Define TEMPLATE_WIDTHS: document=400, metric=300, table=600, article=500, data=400\n2. Replace card body with switch on card.cardType routing to template components in BaseCard\n3. Cards without cardType fall back to legacy GlassCard + BlockRenderer\n4. Remove all spike imports (SPIKE_CARDS_ENABLED, palette, font-switcher)\n5. Update page.tsx: remove FontSwitcher, spike font style prop\n6. Add onCardClick prop, wire through to templates\n\n**Tests:**\n- [ ] card with cardType=\"document\" renders DocumentCard\n- [ ] card with no cardType renders legacy GlassCard\n- [ ] No spike imports remain\n- [ ] Cards still draggable, canvas zoom/pan works\n- [ ] Template-specific widths applied","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T13:54:16.506093+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T18:49:47.612182+11:00","closed_at":"2026-02-20T18:49:47.612182+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.17.6","depends_on_id":"stackdocs-m7b.4.17","type":"parent-child","created_at":"2026-02-20T13:54:16.50751+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.17.6","depends_on_id":"stackdocs-m7b.4.17.5","type":"blocks","created_at":"2026-02-20T13:54:53.220844+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.17.7","title":"Build card overlay for full-screen content view","description":"**Goal:** Full-screen overlay renders all blocks when a card is clicked.\n\n**Files:**\n- Create frontend/components/desktop/card-overlay.tsx\n- Modify frontend/app/(desktop)/desktop/page.tsx\n\n**Steps:**\n1. Create overlay context at page level (React.createContext for setOverlayCardId) — cards in viewport can open overlay outside viewport\n2. Create CardOverlay: fixed inset-0 z-50, dark backdrop with blur, content panel with card palette color, title header + close button, scrollable BlockRenderer (max-w-3xl centered)\n3. Wire into page.tsx as SIBLING of DesktopViewport (not inside — avoids zoom/pan transforms)\n4. Add Escape key handler to close\n5. Add backdrop click to close\n\n**Tests:**\n- [ ] Clicking template card opens overlay with that card's blocks\n- [ ] Close button, Escape, backdrop click all close overlay\n- [ ] Overlay scrolls for long content\n- [ ] Canvas not interactive while overlay open\n- [ ] Card deletion while overlay open closes it automatically","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T13:54:23.997136+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T19:05:48.29974+11:00","closed_at":"2026-02-20T19:05:48.29974+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.17.7","depends_on_id":"stackdocs-m7b.4.17","type":"parent-child","created_at":"2026-02-20T13:54:23.998874+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.17.7","depends_on_id":"stackdocs-m7b.4.17.6","type":"blocks","created_at":"2026-02-20T13:54:53.351009+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.17.8","title":"Clean block-renderer and delete spike code","description":"**Goal:** Remove all SPIKE_CARDS_ENABLED branches. Single rendering path. Delete spike directory.\n\n**Files:**\n- Modify frontend/components/desktop/block-renderer.tsx\n- Delete frontend/spike/card-redesign/ (config.ts, palette.ts, font-switcher.tsx)\n\n**Steps:**\n1. Add variant prop to BlockRenderer: 'light' (default, overlays) or 'glass' (legacy cards)\n2. Remove all if (SPIKE_CARDS_ENABLED) conditionals, keep spike styling as 'light', glass as 'glass'\n3. Remove spike config import\n4. Update legacy fallback in desktop-card.tsx to pass variant=\"glass\"\n5. Delete frontend/spike/card-redesign/ directory\n6. Grep for remaining spike references, remove all\n7. Verify build passes\n\n**Tests:**\n- [ ] BlockRenderer has no SPIKE_CARDS_ENABLED references\n- [ ] Overlay renders blocks correctly with light variant\n- [ ] Legacy glass cards render with glass variant\n- [ ] No file imports from @/spike/\n- [ ] Frontend builds with zero TypeScript errors","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T13:54:30.669083+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T19:11:13.294978+11:00","closed_at":"2026-02-20T19:11:13.294978+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.17.8","depends_on_id":"stackdocs-m7b.4.17","type":"parent-child","created_at":"2026-02-20T13:54:30.670925+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.17.8","depends_on_id":"stackdocs-m7b.4.17.7","type":"blocks","created_at":"2026-02-20T13:54:53.475874+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.17.9","title":"Add snap-to-grid on card drop","description":"**Goal:** Cards snap to nearest grid position when dropped. Overlapping allowed.\n\n**Files:**\n- Modify frontend/components/desktop/desktop-card.tsx (snap logic in handlePointerUp/syncToStore)\n- Possibly frontend/lib/stores/desktop-store.ts (grid constants)\n\n**Steps:**\n1. Define grid cell size (e.g., 20px or 40px — test what feels right with the 40px-radius cards)\n2. In desktop-card.tsx, after drag ends, round position to nearest grid cell: x = Math.round(x / GRID_SIZE) * GRID_SIZE, y = Math.round(y / GRID_SIZE) * GRID_SIZE\n3. Apply snapped position before syncing to store\n4. No collision detection needed — cards can overlap on same grid cell\n5. Auto-placer should also place on grid-aligned positions\n\n**Tests:**\n- [ ] Dropping a card snaps it to nearest grid position\n- [ ] Cards can overlap (no collision prevention)\n- [ ] Snap feels natural (grid size not too coarse or too fine)\n- [ ] Auto-placed cards also land on grid positions","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T14:01:11.090088+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T19:09:42.271644+11:00","closed_at":"2026-02-20T19:09:42.271644+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.4.17.9","depends_on_id":"stackdocs-m7b.4.17","type":"parent-child","created_at":"2026-02-20T14:01:11.091465+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.17.9","depends_on_id":"stackdocs-m7b.4.17.6","type":"blocks","created_at":"2026-02-20T14:01:30.960811+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.2","title":"Grid layout canvas and base card component","description":"**Goal:** Replace React Flow with react-grid-layout for a responsive grid canvas with draggable, resizable cards in predefined sizes.\n**Files:** Modify `frontend/components/canvas/stack-canvas.tsx`, modify `frontend/components/canvas/canvas-card.tsx`, modify `frontend/app/(app)/test-chat/page.tsx`, modify `frontend/package.json`, modify `frontend/types/ws-protocol.ts`\n**Spec:** `.space-agents/exploration/ideas/2026-02-08-canvas-grid-layout-and-agent-prompt/spec.md`\n**Depends on:** None\n\n**Steps:**\n1. Remove `@xyflow/react` dependency, install `react-grid-layout` + `@types/react-grid-layout`\n2. Rewrite `stack-canvas.tsx`: Use `\u003cResponsiveGridLayout\u003e` with breakpoints (lg=3col, md=2col, sm=1col). No zoom, no pan — natural page scroll.\n3. Restyle `canvas-card.tsx`: Remove React Flow node wrapper (NodeResizer, Handle). Keep title bar (drag handle, title, close button) + scrollable body with CardRenderer. Use shadcn Card styling. A2UI-inspired clean design.\n4. Card sizes map to grid units: small (w=1), medium (w=2), large (w=2, taller h), full (w=3). Height auto-sizes or uses content-based calculation.\n5. New cards append to bottom of grid (simplest auto-placement).\n6. Update test-chat page: Remove React Flow imports, use grid layout.\n7. Update `frontend/types/ws-protocol.ts`: Add `size` field to CanvasUpdatePayload, remove card_type references.\n8. Keep `card-renderer.tsx` unchanged — block rendering is layout-independent.\n\n**Tests:**\n- [ ] Cards display in responsive grid (3 col desktop, 2 tablet, 1 mobile)\n- [ ] Cards can be dragged to rearrange (other cards reflow)\n- [ ] Cards can be resized between small/medium/large/full widths\n- [ ] No zoom or pan controls — page scrolls naturally\n- [ ] Card renders title bar with drag handle and close button\n- [ ] CardRenderer still renders blocks array top-to-bottom\n- [ ] New cards appear at bottom of grid (auto-placement)\n- [ ] Visual styling is clean, content-first (no grid dots, A2UI-inspired)\n- [ ] test-chat page works with grid layout\n- [ ] `npm run build` passes with no TypeScript errors","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:21:16.897039+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T11:45:57.828299+11:00","closed_at":"2026-02-12T11:45:57.828299+11:00","close_reason":"Superseded by glass desktop plan — assumed react-grid-layout + (app)/ route group, replaced by custom CSS canvas + (desktop)/ route group","dependencies":[{"issue_id":"stackdocs-m7b.4.2","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-06T15:21:16.898176+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.2","depends_on_id":"stackdocs-m7b.4.10","type":"blocks","created_at":"2026-02-08T17:58:05.548419+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.2.1","title":"Wire grid layout to canvas_update messages (replace React Flow)","description":"**Goal:** Replace the static grid-layout-spike with a production grid layout that renders real canvas_update cards from the Sprite agent.\n\n**Current state:**\n- grid-layout-spike.tsx has 4 hardcoded mock cards — not connected to WebSocket messages\n- test-chat/page.tsx receives canvas_update messages and converts them to cards in state\n- But those cards only flow to StackCanvas (React Flow) — the grid view ignores them\n- Default view is grid, so users see static demo while real cards go to the hidden React Flow view\n\n**What needs to change:**\n\n1. Grid layout component (grid-layout-spike.tsx to production):\n   - Accept cards prop (same shape as React Flow cards)\n   - Use CardRenderer from card-renderer.tsx for block rendering (all 8 block types)\n   - Keep spike UX: snap drag/resize, noOverlapCompactor, ROW_HEIGHT=150, drag handle\n   - Dynamically add/remove cards as canvas_update messages arrive\n\n2. test-chat page (test-chat/page.tsx):\n   - Pass cards state to grid layout component\n   - Remove the toggle — grid layout replaces React Flow entirely\n   - Handle create_card, update_card, close_card commands\n\n3. Card wrapper:\n   - Create grid-compatible card component (no React Flow deps)\n   - Title bar with drag handle + close button\n   - Render blocks via CardRenderer\n\n4. Layout persistence:\n   - Store grid layout in localStorage or Zustand\n\n**Key files:**\n- frontend/components/canvas/grid-layout-spike.tsx (spike to production)\n- frontend/components/canvas/card-renderer.tsx (reuse as-is)\n- frontend/app/(app)/test-chat/page.tsx (wire grid to cards state)\n- frontend/components/canvas/stack-canvas.tsx (React Flow — being replaced)\n- frontend/components/canvas/canvas-card.tsx (React Flow node — being replaced)","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-08T21:55:11.272289+11:00","created_by":"thebrownproject","updated_at":"2026-02-08T22:07:55.790521+11:00","closed_at":"2026-02-08T22:07:55.790521+11:00","close_reason":"Grid layout spike wired to canvas_update messages. Accepts cards prop, renders via CardRenderer, auto-places in grid. React Flow toggle removed. tsc + next build pass.","dependencies":[{"issue_id":"stackdocs-m7b.4.2.1","depends_on_id":"stackdocs-m7b.4.2","type":"parent-child","created_at":"2026-02-08T21:55:11.278729+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.3","title":"MVP block components","description":"**Goal:** Build the 8 data-focused block components that compose into cards on the Canvas.\n**Files:** Create `frontend/components/canvas/blocks/` directory: `heading-block.tsx`, `stat-block.tsx`, `key-value-block.tsx`, `table-block.tsx`, `badge-block.tsx`, `progress-block.tsx`, `text-block.tsx`, `separator-block.tsx`\n**Depends on:** React Flow canvas and base card component\n\n**Steps:**\n1. `heading-block.tsx`: Title text + optional subtitle. Uses Card Header pattern.\n2. `stat-block.tsx`: Large value + muted label + optional trend. Custom layout.\n3. `key-value-block.tsx`: Grid of label:value pairs. Clean two-column layout.\n4. `table-block.tsx`: TanStack Table with columns + rows props. Editable cells send `canvas_interaction` with `card_id` + `block_id`. Reuse patterns from `stacks/stack-table-view.tsx`.\n5. `badge-block.tsx`: shadcn Badge with variant (default, success, warning, destructive).\n6. `progress-block.tsx`: shadcn Progress bar with value + optional label.\n7. `text-block.tsx`: Markdown rendering via `react-markdown` (already in project).\n8. `separator-block.tsx`: shadcn Separator.\n\n**Tests:**\n- [ ] Each of 8 block components renders without crash (smoke tests)\n- [ ] `table-block` renders columns and rows from props (headers visible, data in cells)\n- [ ] `table-block` cell edit triggers `canvas_interaction` with correct `card_id`, `block_id`, and `action: 'edit_cell'`\n- [ ] `stat-block` displays value prominently with muted label\n- [ ] `key-value-block` renders label:value pairs in grid layout\n- [ ] `badge-block` renders correct variant styling (success = green, destructive = red, etc.)\n- [ ] `text-block` renders markdown (headings, bold, lists)\n- [ ] Empty/missing props handled gracefully (no crashes)\n- [ ] `npm run build` passes with no TypeScript errors","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:21:22.186352+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T11:45:57.834761+11:00","closed_at":"2026-02-12T11:45:57.834761+11:00","close_reason":"Superseded by glass desktop plan — assumed react-grid-layout + (app)/ route group, replaced by custom CSS canvas + (desktop)/ route group","dependencies":[{"issue_id":"stackdocs-m7b.4.3","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-06T15:21:22.187333+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.3","depends_on_id":"stackdocs-m7b.4.2","type":"blocks","created_at":"2026-02-06T15:23:26.784139+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.4","title":"Document and notes window components","description":"**Goal:** Supporting window types for PDF preview and markdown notes on Canvas.\n**Files:** Create `frontend/components/canvas/windows/document-window.tsx`, `notes-window.tsx`\n**Depends on:** React Flow canvas and base window component\n\n**Steps:**\n1. document-window.tsx: PDF preview via react-pdf (already in project) or image via img. Page navigation for multi-page PDFs.\n2. notes-window.tsx: Markdown display using react-markdown (already in project). Agent writes content, user views.\n\n**Tests:**\n- [ ] document-window.tsx renders a PDF page (given test PDF data or mock)\n- [ ] Document window shows page navigation for multi-page PDFs\n- [ ] notes-window.tsx renders markdown string (headings, lists, bold render correctly)\n- [ ] Both components accept props and render inside CanvasWindow wrapper\n- [ ] `npm run build` passes with no TypeScript errors","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:21:27.185902+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T16:11:13.805712+11:00","closed_at":"2026-02-06T16:11:13.805712+11:00","close_reason":"Deferred: Notes functionality covered by text-block (markdown). PDF viewer deferred to post-MVP — will be added as a document block type later. Replaced by composable card system with block catalog.","dependencies":[{"issue_id":"stackdocs-m7b.4.4","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-06T15:21:27.186838+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.4","depends_on_id":"stackdocs-m7b.4.2","type":"blocks","created_at":"2026-02-06T15:23:26.900414+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.5","title":"Canvas Zustand store with WS integration","description":"**Goal:** Centralized state for all canvas cards with localStorage persistence and WebSocket message handling.\n**Files:** Create `frontend/lib/stores/canvas-store.ts`\n**Depends on:** Grid layout canvas (m7b.4.2), WebSocket connection manager (m7b.4.1 — done)\n\n**Steps:**\n1. Zustand store: `cards` Map (card_id → { title, blocks: Block[], size, layout: {x, y, w, h} }), `activeCardId`\n2. Actions: `addCard()`, `updateCard()`, `removeCard()`, `updateBlocks()`, `updateLayout()`, `updateSize()`\n3. Persist to localStorage via Zustand persist middleware\n4. Subscribe to `canvas_update` WebSocket messages → `create_card` calls `addCard()`, `update_card` calls `updateCard()` (merge changed blocks by ID), `close_card` calls `removeCard()`\n5. **Cards pop in complete** — no streaming/incremental updates for MVP. One `create_card` message = fully formed card with all blocks.\n6. `size` field (small/medium/large/full) maps to grid width units. No `card_type`.\n7. Layout positions stored per-breakpoint (react-grid-layout responsive model)\n8. User interactions (close, resize, move) update store locally + send `canvas_interaction` messages with `card_id`\n9. Both user and agent can close cards — user via UI close button, agent via `close_card` WS message\n\n**Tests:**\n- [ ] `addCard()` adds card to store, `removeCard()` removes it, `updateCard()` updates blocks\n- [ ] Store persists to localStorage (reload → cards restored from storage)\n- [ ] `canvas_update` WS message with `create_card` → `addCard()` called, card appears in store\n- [ ] `canvas_update` WS message with `update_card` → card blocks updated in store (matched by block ID)\n- [ ] `canvas_update` WS message with `close_card` → card removed from store\n- [ ] User close/resize/move → `canvas_interaction` message sent over WS with `card_id`\n- [ ] Card store includes `size` field (small/medium/large/full), NOT `card_type`","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:21:38.056031+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T11:45:57.845948+11:00","closed_at":"2026-02-12T11:45:57.845948+11:00","close_reason":"Superseded by glass desktop plan — assumed react-grid-layout + (app)/ route group, replaced by custom CSS canvas + (desktop)/ route group","dependencies":[{"issue_id":"stackdocs-m7b.4.5","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-06T15:21:38.057104+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.5","depends_on_id":"stackdocs-m7b.4.2","type":"blocks","created_at":"2026-02-06T15:23:27.017696+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.5","depends_on_id":"stackdocs-m7b.4.1","type":"blocks","created_at":"2026-02-06T15:23:27.139821+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.6","title":"Subbar, chat bar, and status indicator","description":"**Goal:** Card manager taskbar, chat input for missions, and connection status display.\n**Files:** Modify `frontend/app/(app)/stacks/[id]/@subbar/page.tsx`, create `frontend/components/canvas/chat-bar.tsx`, create `frontend/components/canvas/connection-status.tsx`\n**Depends on:** Canvas Zustand store with WS integration (m7b.4.5)\n\n**Steps:**\n1. Subbar: Replace current tab navigation with dynamic card tabs from canvas store. Click to scroll to card (no pan — grid layout scrolls). X to close. Card title as tab label.\n2. Chat bar: Text input + send button at bottom of Canvas. Sends `mission` messages over WebSocket. File upload button (paperclip icon) for alternative to drag-and-drop. Adapt patterns from existing `agent-container.tsx`.\n3. Connection status: Connecting, Sprite waking (spinner), Connected (green dot), Disconnected (red dot). Read from WS store connectionStatus. Display in header or Canvas top-right.\n4. Agent event rendering: Display `agent_event` messages in chat panel — streaming text, tool indicators, errors. Reuse existing agent card/content components.\n\n**Tests:**\n- [ ] Subbar renders one tab per open card (matches canvas store state)\n- [ ] Click tab → page scrolls to that card (smooth scroll)\n- [ ] X on tab → card closes (removed from store)\n- [ ] Chat bar sends `mission` message on submit (message captured by mock WS)\n- [ ] Connection status shows correct indicator for each state\n- [ ] Agent events render in chat panel (text streams, tool calls shown, errors displayed)\n- [ ] `npm run build` passes with no TypeScript errors","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:21:46.951863+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T11:45:57.854772+11:00","closed_at":"2026-02-12T11:45:57.854772+11:00","close_reason":"Superseded by glass desktop plan — assumed react-grid-layout + (app)/ route group, replaced by custom CSS canvas + (desktop)/ route group","dependencies":[{"issue_id":"stackdocs-m7b.4.6","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-06T15:21:46.952735+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.6","depends_on_id":"stackdocs-m7b.4.5","type":"blocks","created_at":"2026-02-06T15:23:27.256658+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.7","title":"Stack page rewrite for Canvas layout","description":"**Goal:** Replace tab-based stack detail view with grid canvas + chat layout.\n**Files:** Modify `frontend/app/(app)/stacks/[id]/page.tsx`, modify `frontend/components/stacks/stack-detail-client.tsx`\n**Depends on:** Subbar, chat bar, and status indicator (m7b.4.6)\n\n**Steps:**\n1. Replace `StackDetailClient` tabs UI with `StackCanvas` grid layout component\n2. Initialize WS connection when stack page loads (via WS store)\n3. Chat bar at bottom, subbar shows card tabs\n4. Grid canvas fills available space, overflow scrolls naturally (no viewport clamping for pan/zoom)\n5. Disconnect WS when navigating away from stack page\n6. Preserve existing stack list page (unchanged)\n\n**Tests:**\n- [ ] Stack detail page renders grid canvas (not the old tabs UI)\n- [ ] WS connection established on page load (connection status shows connecting → connected)\n- [ ] WS disconnected on navigate away (verified by store status)\n- [ ] Grid canvas fills available space, scrolls on overflow\n- [ ] Stack list page (`/stacks`) unchanged and still functional\n- [ ] `npm run build` passes with no TypeScript errors","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:21:53.770286+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T11:45:57.861321+11:00","closed_at":"2026-02-12T11:45:57.861321+11:00","close_reason":"Superseded by glass desktop plan — assumed react-grid-layout + (app)/ route group, replaced by custom CSS canvas + (desktop)/ route group","dependencies":[{"issue_id":"stackdocs-m7b.4.7","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-06T15:21:53.771114+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.7","depends_on_id":"stackdocs-m7b.4.6","type":"blocks","created_at":"2026-02-06T15:23:27.371043+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.8","title":"CSV and JSON export from table blocks","description":"**Goal:** Download extraction data as CSV or JSON directly from Canvas cards containing table blocks.\n**Files:** Modify `frontend/components/canvas/blocks/table-block.tsx` or `frontend/components/canvas/canvas-card.tsx`\n**Depends on:** MVP block components\n\n**Steps:**\n1. Add Export dropdown in card header (when card contains a table block): CSV, JSON options\n2. CSV: Serialize table data (headers as first row, values as subsequent rows), trigger browser download\n3. JSON: Serialize as array of objects, trigger browser download\n4. No server round-trip — data is already in Canvas store\n\n**Tests:**\n- [ ] Export dropdown visible in card header (when table block present) with CSV and JSON options\n- [ ] CSV download contains headers as first row, values as subsequent rows\n- [ ] JSON download contains array of objects (keys = column names)\n- [ ] Downloaded file has correct filename\n- [ ] No network request made during export (client-side only)","status":"open","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:21:58.93884+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T16:11:36.778247+11:00","dependencies":[{"issue_id":"stackdocs-m7b.4.8","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-06T15:21:58.93972+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.4.8","depends_on_id":"stackdocs-m7b.4.3","type":"blocks","created_at":"2026-02-06T15:23:27.493475+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.4.9","title":"Agent system prompt + canvas tool API update","description":"**Goal:** Update agent system prompt for proactive Canvas card usage, align tool API with grid layout (size instead of card_type), and sync protocol types across all 3 codebases.\n\n**Files:** Modify `sprite/src/runtime.py`, modify `sprite/src/agents/shared/canvas_tools.py`, modify `sprite/src/protocol.py`, modify `bridge/src/protocol.ts`, modify `frontend/types/ws-protocol.ts`, modify `sprite/tests/test_canvas_tools.py`\n\n**Owns ALL protocol changes** (to avoid merge conflicts with m7b.4.2):\n- `bridge/src/protocol.ts` — add `size` field, remove card_type\n- `frontend/types/ws-protocol.ts` — mirror bridge changes\n- `sprite/src/protocol.py` — add `size` field, remove card_type\n\n**Steps:**\n1. Protocol sync (all 3 files): Add optional `size` field ('small'|'medium'|'large'|'full') to CanvasUpdatePayload. Remove card_type references. `size` is optional on update_card (agent can resize existing cards).\n2. Update `create_card` tool in `canvas_tools.py`: Replace `card_type` param with `size` param (default \"medium\"). Update tool description with size guidance. Update validation (VALID_SIZES replaces VALID_CARD_TYPES).\n3. Update `DEFAULT_SYSTEM_PROMPT` in `runtime.py` — add Canvas section BEFORE the base tools/workspace prompt:\n   - PA framing: Canvas is a desk where you place information\n   - Cards are PRIMARY output — ALWAYS present structured data on cards\n   - \"NEVER repeat data already visible on a card\" (reinforced)\n   - Text replies: 1-2 sentences, reference what's on screen\n   - Card size guidance: small/medium/large/full with use cases\n   - Multi-card: \"Prefer one card with a table over many separate cards\"\n   - Empty results: \"If nothing to show, reply in text. Don't create empty cards\"\n   - Block composition patterns\n   - Update vs create rules: track card IDs, don't duplicate\n4. Update `sprite/tests/test_canvas_tools.py`: 9 tests pass `card_type` — change all to `size`. Add test for invalid size, test for default size when omitted.\n\n**Tests:**\n- [ ] `create_card` tool accepts `size` parameter (small/medium/large/full)\n- [ ] `create_card` rejects invalid size values\n- [ ] `create_card` defaults to \"medium\" when size omitted\n- [ ] `card_type` parameter no longer accepted\n- [ ] `update_card` accepts optional `size` to resize cards\n- [ ] System prompt includes Canvas section BEFORE base prompt\n- [ ] System prompt has reinforced \"never repeat\" and multi-card guidance\n- [ ] Protocol types include `size` field in all 3 codebases\n- [ ] All 14 canvas_tools tests pass with updated params\n- [ ] Agent on test sprite proactively creates cards for structured data\n- [ ] Agent text replies are short and reference cards","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-08T17:50:39.486082+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T11:50:53.818336+11:00","closed_at":"2026-02-13T11:50:53.818336+11:00","close_reason":"card_type → size across 3 codebases, 17 tests pass, conftest.py for local testing","dependencies":[{"issue_id":"stackdocs-m7b.4.9","depends_on_id":"stackdocs-m7b.4","type":"parent-child","created_at":"2026-02-08T17:50:39.4908+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.5","title":"Phase 4: Upload + Extraction","description":"Wire everything together into the MVP demo flow. 4 tasks. Starts after Phase 2+3 integration gate.","status":"closed","priority":1,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:17:13.686969+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T10:40:24.83691+11:00","closed_at":"2026-02-20T10:40:24.83691+11:00","close_reason":"All 3 children complete: m7b.5.1 (file upload), m7b.5.2 (extraction agent), m7b.5.3 (correction flow + canvas state). Phase 4 done.","dependencies":[{"issue_id":"stackdocs-m7b.5","depends_on_id":"stackdocs-m7b","type":"parent-child","created_at":"2026-02-06T15:17:13.687693+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.5.1","title":"File upload pipeline (frontend + Sprite)","description":"**Goal:** Drag-and-drop file onto Canvas → base64 encode → WebSocket → Sprite → save to disk → SQLite record.\n**Files:** Modify `frontend/components/canvas/stack-canvas.tsx` (drop handler), create `sprite/src/handlers/upload.py`\n**Depends on:** Canvas Zustand store with WS integration, SpriteGateway (from Phase 2)\n\n**Steps:**\n1. Frontend: Enable drag-and-drop on Canvas. Read file as base64, send `file_upload` message. Show optimistic processing card with badge block.\n2. Frontend: Upload button (paperclip) in chat bar as alternative. Support PDF, PNG, JPG, JPEG. 25MB max.\n3. Sprite: `handle_upload()` decodes base64, writes to `/workspace/documents/{uuid}_{filename}`\n4. Sprite: Create `documents` row in SQLite with `status: 'processing'`\n5. Sprite: Send `status` message back to browser\n6. Sprite: Trigger OCR as background asyncio task\n\n**Tests:**\n- [ ] Drag file onto Canvas → `file_upload` message sent over WS (captured by mock)\n- [ ] Paperclip button click → file picker opens, selected file sent as `file_upload`\n- [ ] Files \u003e 25MB rejected on frontend with error message\n- [ ] Sprite receives upload → file written to `/workspace/documents/{uuid}_{filename}`\n- [ ] SQLite `documents` row created with `status: 'processing'`\n- [ ] `status` message sent back to browser with `status: 'processing'`\n- [ ] Unsupported file types rejected (only PDF, PNG, JPG, JPEG accepted)","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:22:13.063247+11:00","created_by":"thebrownproject","updated_at":"2026-02-18T21:32:26.808761+11:00","closed_at":"2026-02-18T21:32:26.808761+11:00","close_reason":"7/7 tests pass. Commit 9916ab1. Frontend hook + chat-bar + viewport drop + gateway handler + documents table all implemented.","dependencies":[{"issue_id":"stackdocs-m7b.5.1","depends_on_id":"stackdocs-m7b.5","type":"parent-child","created_at":"2026-02-06T15:22:13.064297+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.5.1","depends_on_id":"stackdocs-m7b.4.5","type":"blocks","created_at":"2026-02-06T15:23:29.801748+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.5.1","depends_on_id":"stackdocs-m7b.3.3","type":"blocks","created_at":"2026-02-06T15:23:29.916707+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.5.2","title":"OCR and extraction agent integration","description":"**Goal:** Uploaded documents get OCR'd and extracted, with results streaming to Canvas as cards with table blocks.\n**Files:** Modify `sprite/src/services/ocr.py`, modify `sprite/src/handlers/upload.py`, wire `sprite/src/agents/extraction_agent/`\n**Depends on:** File upload pipeline, Agent runtime with WebSocket output\n\n**Steps:**\n1. OCR: Mistral OCR API call (env var key) → cache text to `/workspace/ocr/{doc_id}.md`. Also support Claude native PDF (pass base64 directly in extraction prompt). Agent decides which method per document.\n2. After OCR: Send `canvas_update` to create processing card on Canvas (heading + badge block)\n3. Run extraction agent: pass OCR text, agent calls tools to extract structured data\n4. Agent calls `create_card` tool → extraction card appears on Canvas with stat + table blocks showing extracted fields\n5. Update SQLite: extraction record with fields, document status to `completed`\n6. Update daily journal with extraction summary\n\n**Tests:**\n- [ ] OCR produces cached text at `/workspace/ocr/{doc_id}.md` (file exists, non-empty)\n- [ ] Processing card created on Canvas after OCR completes (canvas_update message sent)\n- [ ] Extraction agent runs and creates extraction card with table block showing extracted fields\n- [ ] SQLite `extractions` row created with `extracted_fields` JSON\n- [ ] Document `status` updated to `completed` in SQLite\n- [ ] Daily journal updated with extraction summary line\n- [ ] Both Mistral OCR and Claude native PDF paths work (tested separately)","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:22:22.07515+11:00","created_by":"thebrownproject","updated_at":"2026-02-18T21:45:15.83474+11:00","closed_at":"2026-02-18T21:45:15.83474+11:00","close_reason":"6/6 tests pass. Commit 7f75a24. _run_extraction() implemented — agent reads file via Bash, creates canvas card, updates document status. 3 new tests. Mistral OCR deferred (demo uses agent direct read).","dependencies":[{"issue_id":"stackdocs-m7b.5.2","depends_on_id":"stackdocs-m7b.5","type":"parent-child","created_at":"2026-02-06T15:22:22.076082+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.5.2","depends_on_id":"stackdocs-m7b.5.1","type":"blocks","created_at":"2026-02-06T15:23:30.033598+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.5.2","depends_on_id":"stackdocs-m7b.3.3","type":"blocks","created_at":"2026-02-06T15:23:30.150704+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.5.3","title":"Correction flow and Canvas state awareness","description":"**Goal:** User can correct extractions via chat. Agent receives Canvas state to know what the user sees.\n**Files:** Modify `sprite/src/gateway.py`, modify `frontend/lib/stores/canvas-store.ts`\n**Depends on:** OCR and extraction agent integration\n\n**Steps:**\n1. Canvas state injection: When mission is sent, include current Canvas state (open cards, active table block data) in context\n2. Frontend serializes Canvas state from store, sends as part of mission or at session start\n3. Agent receives corrections via chat: \"the vendor should be Acme Corp\"\n4. Agent calls `set_field` to update SQLite + `update_card` to refresh table block on Canvas\n5. Agent updates `soul.md` if correction reveals a pattern (prompt engineering)\n\n**Tests:**\n- [ ] Mission message includes serialized Canvas state (open cards, active table block data)\n- [ ] Chat \"change vendor to Acme Corp\" → `set_field` updates SQLite extraction record\n- [ ] `update_card` message sent → table block refreshes on Canvas with corrected data\n- [ ] After 3+ corrections on same field pattern → `soul.md` updated with learned rule\n- [ ] Canvas state serialization includes card_id, title, and blocks for each open card","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:22:29.69155+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T09:19:58.872122+11:00","closed_at":"2026-02-20T09:19:58.872122+11:00","close_reason":"Correction flow implemented: Canvas state injection into missions, _format_canvas_context helper, _check_correction_threshold for soul.md auto-rules, 8 tests passing. Protocol synced across bridge/frontend/sprite.","dependencies":[{"issue_id":"stackdocs-m7b.5.3","depends_on_id":"stackdocs-m7b.5","type":"parent-child","created_at":"2026-02-06T15:22:29.692365+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.5.3","depends_on_id":"stackdocs-m7b.5.2","type":"blocks","created_at":"2026-02-06T15:23:30.266186+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.6","title":"Phase 5: Memory + Polish","description":"Complete the memory system and polish the MVP demo. 3 tasks.","status":"open","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:17:14.138689+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:17:14.138689+11:00","dependencies":[{"issue_id":"stackdocs-m7b.6","depends_on_id":"stackdocs-m7b","type":"parent-child","created_at":"2026-02-06T15:17:14.139555+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.6.1","title":"FTS5 memory search","description":"**Goal:** Agent can search past memories using hybrid BM25 text search.\n**Files:** Create `sprite/src/memory/index.py`, modify `sprite/src/agents/shared/memory_tools.py`\n**Depends on:** Basic memory system (file loading + journals)\n\n**Steps:**\n1. Implement memory_fts virtual table indexing: on startup and after memory writes, chunk memory files (sliding window, ~512 tokens per chunk) and insert into FTS5\n2. Provide search_memory(query) function returning ranked BM25 results\n3. Create agent tool: search_memories(query) → returns relevant past context\n4. BM25 only for MVP (skip vector embeddings — add post-MVP)\n\n**Tests:**\n- [ ] memory_fts table populated on startup (row count \u003e 0 after indexing existing memory files)\n- [ ] search_memory(\"invoice\") returns relevant chunks ranked by BM25 score\n- [ ] Agent tool search_memories is callable and returns formatted results\n- [ ] Re-indexes after memory writes (write to journal → new content searchable)\n- [ ] Empty memory files → graceful handling (no crash, empty results)","status":"open","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:22:42.608405+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:22:42.608405+11:00","dependencies":[{"issue_id":"stackdocs-m7b.6.1","depends_on_id":"stackdocs-m7b.6","type":"parent-child","created_at":"2026-02-06T15:22:42.60965+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.6.1","depends_on_id":"stackdocs-m7b.3.5","type":"blocks","created_at":"2026-02-06T15:23:32.969361+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.6.2","title":"Session persistence and reconnection verification","description":"**Goal:** Verify the full persistence story: upload → extract → close browser → Sprite sleeps → reopen → everything intact.\n**Files:** Integration test + frontend/ reconnection improvements\n**Depends on:** OCR and extraction agent integration\n\n**Steps:**\n1. Test full cycle: upload docs, extract data, close browser, wait for Sprite sleep (35s), reopen browser\n2. Verify: Canvas loads from localStorage, agent loads memory, SQLite has all data\n3. Frontend: On reconnect, load Canvas state from localStorage + request Sprite state sync if needed\n4. Fix any gaps discovered during testing\n\n**Tests:**\n- [ ] Full cycle passes: upload → extract → close browser → wait 35s → reopen → Canvas loads\n- [ ] Canvas state restored from localStorage (same windows, positions, data)\n- [ ] Agent memory intact: soul.md, journals, MEMORY.md all present on Sprite after wake\n- [ ] SQLite data intact: documents, extractions, OCR results all queryable after wake\n- [ ] No data loss or corruption after sleep/wake cycle","status":"open","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:22:49.430367+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:22:49.430367+11:00","dependencies":[{"issue_id":"stackdocs-m7b.6.2","depends_on_id":"stackdocs-m7b.6","type":"parent-child","created_at":"2026-02-06T15:22:49.431266+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.6.2","depends_on_id":"stackdocs-m7b.5.2","type":"blocks","created_at":"2026-02-06T15:23:33.090661+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.6.3","title":"Demo polish and error handling","description":"Demo polish and error handling. Scope for Saturday demo sprint:\n- files-store.ts (ephemeral Zustand store tracking uploaded files)\n- documents-panel.tsx wired to files store (replace hardcoded stub)\n- Card size picker UI on desktop-card.tsx (protocol already supports small/medium/large/full)\n- clip-path:inset(0) fix on static glass elements (chat bar, top bar, panels — proven fix from Session 185)\n- Error handling for failed uploads (toast + badge update on card)\n- Demo run-throughs x2 before Saturday","status":"open","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-06T15:22:58.656981+11:00","created_by":"thebrownproject","updated_at":"2026-02-18T21:01:13.302727+11:00","dependencies":[{"issue_id":"stackdocs-m7b.6.3","depends_on_id":"stackdocs-m7b.6","type":"parent-child","created_at":"2026-02-06T15:22:58.657917+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.6.3","depends_on_id":"stackdocs-m7b.6.2","type":"blocks","created_at":"2026-02-06T15:23:33.211666+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.6.4","title":"Multi-turn conversation via SDK session resume + local transcript","description":"**Goal:** Enable persistent multi-turn conversation memory so the agent always understands the user across sessions.\n\n**Architecture: OpenClaw-inspired hybrid (SDK resume + pre-compaction flush + layered memory)**\nSee full research: `docs/research/openclaw-memory-architecture.md`\n\n**Key concept:** Context window = RAM (cache). Disk memory = source of truth. Compaction = garbage collection. Retrieval = page fault handler.\n\n**Within a session (multi-turn):**\n1. Use SDK `resume=session_id` for turn-to-turn continuity\n2. Store `session_id` in SQLite (survives Sprite sleep/wake)\n3. Append every turn to JSONL transcript (audit log, never loaded into context)\n\n**Between sessions (persistent memory):**\n1. Pre-compaction flush before session ends — agent writes journal + updates MEMORY.md + updates user.md\n2. New session cold start loads: soul.md + user.md + MEMORY.md + 2 days journals (~2,200 tokens)\n3. Agent knows who it is, who the user is, and what happened recently — WITHOUT replaying 1000 turns\n\n**Flush triggers (need at least 2):**\n- Context window guard: ~80% capacity → flush NOW (mandatory safety net)\n- Disconnect/inactivity: user gone for N minutes or browser closed → flush before sleep\n- Heartbeat: periodic reflection (post-MVP)\n\n**Files to modify:**\n- `sprite/src/runtime.py` — capture session_id, pass resume on subsequent turns, implement flush logic\n- `sprite/src/database.py` — sessions table (session_id, started_at, turn_count)\n- `sprite/src/memory/transcript.py` — richer JSONL (user messages, agent responses, tool calls, tool results)\n- `sprite/src/memory/journal.py` — flush writes here (agent summarizes session)\n- `sprite/src/gateway.py` — disconnect handler triggers flush\n\n**Tests:**\n- [ ] Agent remembers what user said N messages ago within a session (SDK resume)\n- [ ] session_id persisted to SQLite, survives Sprite sleep/wake\n- [ ] Pre-compaction flush writes journal entry summarizing session\n- [ ] New session cold start is \u003c3,000 tokens but agent has full context\n- [ ] Expired SDK session handled gracefully (fresh session + memory files)\n- [ ] JSONL transcript contains all event types (user, agent, tool_call, tool_result)\n- [ ] Context window guard triggers flush at ~80% capacity","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-08T12:32:48.078838+11:00","created_by":"thebrownproject","updated_at":"2026-02-08T16:34:53.798478+11:00","closed_at":"2026-02-08T16:34:53.798478+11:00","close_reason":"Multi-turn conversation working — persistent SDK client deployed and verified on sd-e2e-test sprite (session 134)","dependencies":[{"issue_id":"stackdocs-m7b.6.4","depends_on_id":"stackdocs-m7b.6","type":"parent-child","created_at":"2026-02-08T12:32:48.08087+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.7","title":"Sprite VM Structure + Memory System Redesign","description":"**Goal:** `.os/` directory structure. Two databases (transcript + memory). 6 daemon-curated memory files. Batch processing via hooks. Agent has zero memory responsibility.\n\n**Spec:** `.space-agents/exploration/planned/2026-02-08-memory-system-redesign/spec.md`\n**Plan:** `.space-agents/mission/staged/memory-system-redesign/plan.md`\n\n**Overview:**\nRestructure the Sprite VM into `.os/` (system) and user space. Replace the flat `/workspace/` layout with a clean separation. Two SQLite databases: `transcript.db` (immutable conversation log) and `memory.db` (searchable learnings). Six memory files loaded on boot solve the memory passover problem. Batch processing every ~25 turns via SDK hooks (Stop, PreCompact). Stateless Haiku calls.\n\n**Execution order:** 1 → 3 → 2 → 5 → 7 → 6 → 4 → 8 → 9\n**Execution mode:** /mission solo\n**Critical path:** 1 → 2 → 5 → 6 → 8 → 9","status":"closed","priority":1,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-12T11:58:30.743609+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T21:18:36.25364+11:00","closed_at":"2026-02-12T21:18:36.25364+11:00","close_reason":"All 10 tasks complete. Memory system redesigned: .os/ structure, dual DBs (transcript+memory), 6 memory files, SDK hooks, batch processor, bootstrap+updater. 168 unit + 32 E2E tests passing.","dependencies":[{"issue_id":"stackdocs-m7b.7","depends_on_id":"stackdocs-m7b","type":"parent-child","created_at":"2026-02-12T11:58:30.748005+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.7.1","title":"Restructure Sprite VM to .os/ layout","description":"**Goal:** Move all system files into `.os/`, establish user space directories.\n\n**Files:**\n- Modify `bridge/src/bootstrap.ts`\n- Modify `bridge/src/updater.ts`\n- Modify `sprite/src/memory/__init__.py`\n- Modify `sprite/src/database.py`\n- Modify `sprite/src/server.py`\n\n**Steps:**\n1. Update bootstrap directory creation: `.os/src/`, `.os/src/tools/`, `.os/src/memory/`, `.os/memory/`, `.os/.venv/` + user space dirs `documents/`, `ocr/`, `extractions/`, `artifacts/`\n2. Update bootstrap to deploy source files into `.os/src/` (not `/workspace/src/`)\n3. Update all Python path references: database path → `.os/memory/`, memory files → `.os/memory/`, venv → `.os/.venv/`\n4. Update `__init__.py` file paths to `.os/memory/` prefix\n5. Move VERSION to `.os/VERSION`\n6. Update `bridge/src/updater.ts` to read VERSION from `.os/VERSION` (reads via FS API — must match new path)\n7. Update venv creation path in bootstrap\n8. Update `chown` to cover `.os/` and user space dirs\n\n**Tests:**\n- [ ] Bootstrap creates correct `.os/` directory structure\n- [ ] Source files deployed to `.os/src/`\n- [ ] Memory files created at `.os/memory/`\n- [ ] VERSION at `.os/VERSION`\n- [ ] Updater reads from `.os/VERSION` (not `/workspace/VERSION`)\n- [ ] User space dirs created (documents, ocr, extractions, artifacts)","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T11:58:45.315946+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T13:44:35.227304+11:00","closed_at":"2026-02-12T13:44:35.227304+11:00","close_reason":"All 7 test criteria pass. 97 bridge + 60 sprite tests green. Inspector verified.","dependencies":[{"issue_id":"stackdocs-m7b.7.1","depends_on_id":"stackdocs-m7b.7","type":"parent-child","created_at":"2026-02-12T11:58:45.321399+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.7.10","title":"E2E test: verify SDK hooks on live Sprite","description":"Deploy to a live Sprite and verify all 4 SDK hooks fire correctly:\n- UserPromptSubmit: receives prompt text\n- PostToolUse: receives tool_name, tool_input, tool_response\n- Stop: fires on turn end, confirm no agent response in input_data\n- PreCompact: fires before compaction, verify trigger field existence\n\nTest HookMatcher registration for non-tool hooks (matcher value for UserPromptSubmit/Stop/PreCompact).\nTest that observations are written to transcript.db.\nTest that batch processor triggers at threshold.\n\nRun on golden Sprite or a test Sprite. Fix any hook signature mismatches discovered.","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T14:42:51.424968+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T21:18:30.557036+11:00","closed_at":"2026-02-12T21:18:30.557036+11:00","close_reason":"All 32 E2E tests pass on live Sprite (sd-e2e-test). Verified: imports, DB creation, HookMatcher SDK compat, all 4 hook callbacks, observation writes, batch threshold, error containment.","dependencies":[{"issue_id":"stackdocs-m7b.7.10","depends_on_id":"stackdocs-m7b.7","type":"parent-child","created_at":"2026-02-12T14:42:51.427203+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.7.10","depends_on_id":"stackdocs-m7b.7.8","type":"blocks","created_at":"2026-02-12T14:43:21.713273+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.7.2","title":"Split database into transcript.db + memory.db","description":"**Goal:** Two separate databases with distinct schemas and access patterns.\n\n**Files:**\n- Modify `sprite/src/database.py`\n- Modify `bridge/src/bootstrap.ts`\n\n**Depends on:** Task 1 (Restructure Sprite VM)\n\n**Steps:**\n1. Create `TranscriptDB` class wrapping `transcript.db` — append-only access pattern\n   - `observations` table (id, timestamp, session_id, sequence_num, user_message, tool_calls_json, agent_response, processed)\n   - `sessions` table (id, started_at, ended_at, message_count, observation_count)\n2. Create `MemoryDB` class wrapping `memory.db` — read/write for daemon, read-only for agent\n   - `learnings` table (id, created_at, session_id, type, content, source_observation_id, confidence)\n   - `pending_actions` table (id, created_at, content, priority, status, source_learning_id)\n   - `learnings_fts` FTS5 virtual table (content, type)\n3. Both databases: WAL mode, `busy_timeout=5000`, `foreign_keys=ON`\n4. Delete old `Database` class entirely — spec is explicit: no documents database. Filesystem is source of truth, `files.md` tracks the index. Update `server.py` and `gateway.py` imports.\n5. Update bootstrap `INIT_DB_SCRIPT` to create both databases at `.os/memory/`\n\n**Tests:**\n- [ ] transcript.db created with correct tables\n- [ ] memory.db created with correct tables + FTS5\n- [ ] WAL mode + busy_timeout on both\n- [ ] Insert/query operations work on both\n- [ ] Old `Database` class no longer exists in `database.py`\n- [ ] Bootstrap schema matches Python schema","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T11:58:52.456569+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T14:35:27.520674+11:00","closed_at":"2026-02-12T14:35:27.520674+11:00","close_reason":"6/6 test criteria pass. 23 database tests green, 104 bridge tests green. TranscriptDB + MemoryDB with FTS5 working.","dependencies":[{"issue_id":"stackdocs-m7b.7.2","depends_on_id":"stackdocs-m7b.7","type":"parent-child","created_at":"2026-02-12T11:58:52.462877+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.7.2","depends_on_id":"stackdocs-m7b.7.1","type":"blocks","created_at":"2026-02-12T12:00:22.365835+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.7.3","title":"Create 6 memory file templates","description":"**Goal:** soul.md, os.md, tools.md, files.md, user.md, context.md templates.\n\n**Files:**\n- Create `sprite/memory/soul.md`\n- Create `sprite/memory/os.md`\n- Create `sprite/memory/tools.md`\n- Create `sprite/memory/files.md`\n- Create `sprite/memory/user.md`\n- Create `sprite/memory/context.md`\n\n**Depends on:** None\n\n**Steps:**\n1. `soul.md` (≤200 lines) — AI personality, voice, character. Stackdocs agent identity.\n2. `os.md` (≤200 lines) — System rules, constraints, app identity. Canvas guidance, tool usage rules, autonomy boundaries.\n3. `tools.md` (≤150 lines) — Base capabilities: canvas tools, bash, read, write, search_memory. Placeholder for learned procedures.\n4. `files.md` (≤200 lines) — Initial empty state with section headers (Documents, Extractions, Recent Activity).\n5. `user.md` (≤200 lines) — Structured sections: Key Facts, Preferences, Work History. Initial empty state.\n6. `context.md` (≤200 lines) — Structured sections: Currently Working On, Remember, Follow Up. Initial empty state.\n7. Update bootstrap to deploy all 6 files to `.os/memory/`\n8. Remove old `sprite/memory/soul.md` (replaced by new soul.md + os.md)\n\n**Tests:**\n- [ ] All 6 templates exist with correct structure\n- [ ] All within line limits\n- [ ] Bootstrap deploys all 6 to `.os/memory/`","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T11:59:00.019596+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T14:15:27.949099+11:00","closed_at":"2026-02-12T14:15:27.949099+11:00","close_reason":"3/3 test criteria pass. 6 templates created, all within line limits, bootstrap deploys correctly. 104 bridge + 30 sprite tests green.","dependencies":[{"issue_id":"stackdocs-m7b.7.3","depends_on_id":"stackdocs-m7b.7","type":"parent-child","created_at":"2026-02-12T11:59:00.024626+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.7.4","title":"Update memory loader for 6-file boot sequence","description":"**Goal:** Load all 6 md files + pending_actions into system prompt at session start.\n\n**Files:**\n- Modify `sprite/src/memory/loader.py`\n- Modify `sprite/src/memory/__init__.py`\n\n**Depends on:** Task 2 (Split database), Task 3 (Memory templates)\n\n**Steps:**\n1. `async def load(memory_db) -\u003e str` — load all 6 md files from `.os/memory/` filesystem\n2. Query `pending_actions` (status=pending) from memory.db, append to prompt\n3. Format each file with clear headers: `## Soul`, `## System`, `## Tools`, `## Files`, `## User`, `## Context`, `## Pending Actions`\n4. Omit empty sections cleanly\n5. Remove old loader logic (MEMORY.md, journals, 48h learnings window)\n6. Update `__init__.py` paths: SOUL_MD, OS_MD, TOOLS_MD, FILES_MD, USER_MD, CONTEXT_MD\n\n**Tests:**\n- [ ] Loader returns all 7 sections when populated (6 files + pending actions)\n- [ ] Omits empty sections cleanly\n- [ ] Reads from `.os/memory/` paths\n- [ ] No references to MEMORY.md or journals","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T11:59:07.39146+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T16:20:06.265452+11:00","closed_at":"2026-02-12T16:20:06.265452+11:00","close_reason":"4/4 test criteria pass. 56 local tests green. Async 6-file loader with pending_actions, no legacy references.","dependencies":[{"issue_id":"stackdocs-m7b.7.4","depends_on_id":"stackdocs-m7b.7","type":"parent-child","created_at":"2026-02-12T11:59:07.392818+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.7.4","depends_on_id":"stackdocs-m7b.7.2","type":"blocks","created_at":"2026-02-12T12:00:22.546681+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.7.4","depends_on_id":"stackdocs-m7b.7.3","type":"blocks","created_at":"2026-02-12T12:00:22.709024+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.7.5","title":"Implement hook capture and turn-level observations","description":"**Goal:** Buffer tool calls during agent turn, write one observation to transcript.db on Stop hook. Track turn count for batch threshold.\n\n**Files:**\n- Create `sprite/src/memory/hooks.py`\n- Modify `sprite/src/runtime.py`\n\n**Depends on:** Task 2 (Split database)\n\n**IMPORTANT — SDK hook limitation:** The `Stop` hook does NOT carry the agent's response text. It only has `stop_hook_active: bool` + base fields (`session_id`, `transcript_path`, `cwd`). The agent response must be captured in `runtime.py` from the SDK message stream (`AssistantMessage`/`TextBlock`) via `buffer.set_agent_response(text)`, not from the Stop hook.\n\n**Steps:**\n1. **Spike first:** Verify SDK hook API before writing implementation. Create throwaway test that imports `HookMatcher`, `ClaudeAgentOptions`, registers dummy hooks, confirms signatures. Delete spike after verification.\n2. `TurnBuffer` class — accumulates user_message + tool_call summaries + agent_response in memory during a turn. Includes `set_agent_response(text)` method called from runtime's message handler.\n3. `create_hook_callbacks(transcript_db, processor, buffer)` factory:\n   - `user_prompt_submit` → set buffer.user_message\n   - `post_tool_use` → append tool summary to buffer (truncate to 2000 chars)\n   - `stop` → write ONE observation to transcript.db from buffer, clear buffer, increment turn count, trigger batch if count \u003e= 25\n   - `pre_compact` → if trigger == \"auto\", call processor.flush_all() (emergency flush)\n4. All hooks return `{}` (passthrough), wrap in try/except (never block agent)\n5. In `runtime.py`: create buffer, register hooks in ClaudeAgentOptions, call `buffer.set_agent_response()` from `_handle_sdk_message` when processing `TextBlock` content\n\n**Tests:**\n- [ ] UserPromptSubmit buffers user message\n- [ ] PostToolUse buffers tool calls (doesn't write to DB)\n- [ ] TurnBuffer.set_agent_response stores agent text\n- [ ] Stop writes one observation with all buffered data (including agent response)\n- [ ] Buffer cleared after observation written\n- [ ] Turn count increments and triggers batch at threshold\n- [ ] PreCompact triggers emergency flush on trigger=\"auto\"\n- [ ] PreCompact does NOT flush on trigger=\"manual\"\n- [ ] Hook errors never propagate (return {} on exception)","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T11:59:22.768199+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T14:59:11.577014+11:00","closed_at":"2026-02-12T14:59:11.577014+11:00","close_reason":"9/9 test criteria pass. 17 hook tests + 52 total locally-runnable tests green. HookMatcher verification deferred to m7b.7.10.","dependencies":[{"issue_id":"stackdocs-m7b.7.5","depends_on_id":"stackdocs-m7b.7","type":"parent-child","created_at":"2026-02-12T11:59:22.773099+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.7.5","depends_on_id":"stackdocs-m7b.7.2","type":"blocks","created_at":"2026-02-12T12:00:22.852128+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.7.6","title":"Build observation batch processor","description":"**Goal:** Stateless module that processes observation batches via Haiku, extracts learnings, updates md files.\n\n**Files:**\n- Create `sprite/src/memory/processor.py`\n\n**Depends on:** Task 2 (Split database), Task 3 (Memory templates)\n\n**Note:** The Anthropic client uses `anthropic.AsyncAnthropic()` which auto-reads `ANTHROPIC_BASE_URL` env var pointing at the Bridge API proxy (already deployed at `bridge/src/api-proxy.ts`). No proxy implementation needed — m7b.3.6 is complete.\n\n**Steps:**\n1. `ObservationProcessor(transcript_db, memory_db, anthropic_client, memory_dir)` class\n2. `process_batch()` — read all unprocessed observations from transcript.db, build single Haiku prompt with current md file state + observation batch, call Haiku, parse response\n3. Parse response format: FACT/PATTERN/CORRECTION/PREFERENCE/TOOL_INSTALL → learnings table. ACTION → pending_actions table. *_MD_UPDATE → rewrite corresponding md file. NONE → skip.\n4. `flush_all()` — process ALL remaining unprocessed observations (called by PreCompact and session end). No age-based skipping — all unprocessed observations are valid, including those accumulated across Sprite sleep/wake cycles.\n5. Mark observations as processed in transcript.db after successful processing\n6. Error handling: log and return on API errors (do NOT mark as processed — observations will be retried next batch)\n7. Read current md files fresh each batch (stateless — no memory of previous runs)\n\n**Tests:**\n- [ ] Haiku called with correct prompt including all 6 md files + observation batch\n- [ ] Each learning type correctly parsed and stored in memory.db\n- [ ] MD file updates rewrite the full file (not append)\n- [ ] NONE produces no learnings\n- [ ] Failed API call does NOT mark observations as processed\n- [ ] flush_all processes everything remaining\n- [ ] Empty batch (no unprocessed observations) is a no-op\n- [ ] Multiple file updates in one response all applied","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T11:59:35.02217+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T17:44:58.97386+11:00","closed_at":"2026-02-12T17:44:58.97386+11:00","close_reason":"8/8 test criteria pass. 10 processor tests (Sprite-only), 56 local tests green. ObservationProcessor with Haiku calls, learning extraction, file rewrites.","dependencies":[{"issue_id":"stackdocs-m7b.7.6","depends_on_id":"stackdocs-m7b.7","type":"parent-child","created_at":"2026-02-12T11:59:35.028981+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.7.6","depends_on_id":"stackdocs-m7b.7.2","type":"blocks","created_at":"2026-02-12T12:00:22.999945+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.7.6","depends_on_id":"stackdocs-m7b.7.3","type":"blocks","created_at":"2026-02-12T12:00:23.176402+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.7.7","title":"Add search_memory tool","description":"**Goal:** Read-only FTS5 search across all historical learnings in memory.db.\n\n**Files:**\n- Move `sprite/src/agents/shared/memory_tools.py` → `sprite/src/tools/memory.py`\n\n**Depends on:** Task 2 (Split database)\n\n**Steps:**\n1. `create_memory_tools(memory_db)` returns single tool: `search_memory(query, limit=10)`\n2. FTS5 query on `learnings_fts` table, returns matching learnings with type, content, and date\n3. Read-only — no write tools\n4. Move file from `agents/shared/memory_tools.py` to `tools/memory.py` (matches new src structure)\n5. Delete old `memory_tools.py`\n\n**Tests:**\n- [ ] search_memory returns matching learnings ranked by relevance\n- [ ] Results include type, content, and date\n- [ ] No write tools exposed\n- [ ] Empty query returns recent learnings","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T11:59:37.719665+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T15:37:07.779892+11:00","closed_at":"2026-02-12T15:37:07.779892+11:00","close_reason":"4/4 test criteria pass. 52 local tests green. search_memory FTS5 tool created, old write tools deleted. SDK-dependent tests deferred to m7b.7.10.","dependencies":[{"issue_id":"stackdocs-m7b.7.7","depends_on_id":"stackdocs-m7b.7","type":"parent-child","created_at":"2026-02-12T11:59:37.720835+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.7.7","depends_on_id":"stackdocs-m7b.7.2","type":"blocks","created_at":"2026-02-12T12:00:23.346481+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.7.8","title":"Wire memory system into AgentRuntime","description":"**Goal:** Connect hooks, processor, loader, search_memory. Remove old memory system.\n\n**Files:**\n- Modify `sprite/src/runtime.py`\n- Modify `sprite/src/server.py`\n\n**Depends on:** Task 4 (Loader), Task 5 (Hooks), Task 6 (Processor), Task 7 (search_memory)\n\n**Steps:**\n1. Create TranscriptDB + MemoryDB connections in server.py\n2. Create ObservationProcessor + TurnBuffer in runtime init\n3. Register all 4 hooks in ClaudeAgentOptions (UserPromptSubmit, PostToolUse, Stop, PreCompact)\n4. MCP server tools: canvas_tools + search_memory (no write memory tools)\n5. System prompt: `await loader.load(memory_db)`\n6. Insert session record on start\n7. In `_handle_sdk_message`, call `buffer.set_agent_response(text)` when processing `TextBlock` content\n8. Create `anthropic.AsyncAnthropic()` client in server.py (auto-reads `ANTHROPIC_BASE_URL` env var for Bridge proxy)\n9. Delete `sprite/src/memory/journal.py` (no longer used)\n10. Delete `sprite/src/memory/transcript.py` (replaced by transcript.db)\n11. Move `sprite/src/agents/shared/canvas_tools.py` → `sprite/src/tools/canvas.py` (update relative import from `...protocol` to `..protocol`)\n12. Remove `sprite/src/agents/` directory (safe — no extraction agent code exists yet; Phase 4 m7b.5 creates `agents/extraction_agent/` fresh)\n\n**Tests:**\n- [ ] All 4 hooks registered in ClaudeAgentOptions\n- [ ] MCP server has canvas + search_memory tools only (no write_memory, no update_user_prefs)\n- [ ] System prompt comes from async `load(memory_db)` with all 6 memory file sections\n- [ ] Agent response text forwarded to TurnBuffer via `buffer.set_agent_response()`\n- [ ] Session record created in transcript.db on start\n- [ ] No imports from journal.py, transcript.py, or agents/shared/\n- [ ] cwd remains `/workspace` (user space, not `.os/`)","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T11:59:44.549034+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T18:09:41.127183+11:00","closed_at":"2026-02-12T18:09:41.127183+11:00","close_reason":"All 12 steps complete. 56 local tests passing. Inspector verified.","dependencies":[{"issue_id":"stackdocs-m7b.7.8","depends_on_id":"stackdocs-m7b.7","type":"parent-child","created_at":"2026-02-12T11:59:44.554385+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.7.8","depends_on_id":"stackdocs-m7b.7.4","type":"blocks","created_at":"2026-02-12T12:00:23.494268+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.7.8","depends_on_id":"stackdocs-m7b.7.5","type":"blocks","created_at":"2026-02-12T12:00:23.676023+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.7.8","depends_on_id":"stackdocs-m7b.7.6","type":"blocks","created_at":"2026-02-12T12:00:23.837962+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.7.8","depends_on_id":"stackdocs-m7b.7.7","type":"blocks","created_at":"2026-02-12T12:00:23.983677+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.7.9","title":"Update bootstrap, clean up old files, run full test suite","description":"**Goal:** Deploy updated file structure, clean up tests, verify everything works.\n**Files:** Modify `bridge/src/bootstrap.ts`, modify `bridge/src/updater.ts`, modify/delete test files\n\n**Steps:**\n1. Bootstrap: deploy to `.os/src/` structure (tools/, memory/ subdirs), deploy 6 memory templates to `.os/memory/`, create both databases, update VERSION\n2. Update srcFiles list: add hooks.py, processor.py, tools/canvas.py, tools/memory.py; remove journal.py, transcript.py, agents/shared/*\n3. Delete `sprite/tests/test_memory_tools.py` (old write tools gone)\n4. Update `sprite/tests/test_memory_system.py` (new loader, 6 files, no MEMORY.md/journals)\n5. Update `sprite/tests/test_runtime.py` (hook assertions, new tool list)\n6. Add test for `.os/` directory structure verification\n7. Implement semver versioning: change VERSION from bare integer to semver format (e.g. `0.2.0`). Update `updater.ts` comparison logic from integer `\u003c` to semver-aware comparison. Update `bootstrap.ts` CURRENT_VERSION constant.\n8. Run full test suite\n\n**Tests:**\n- [ ] Bootstrap creates correct `.os/` layout\n- [ ] Bootstrap deploys all source files to correct paths\n- [ ] All Python tests pass\n- [ ] No references to old paths, MEMORY.md, journal.py, or old memory tools\n- [ ] VERSION uses semver format (MAJOR.MINOR.PATCH)\n- [ ] Updater correctly compares semver versions","status":"closed","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T11:59:49.438298+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T18:41:04.407668+11:00","closed_at":"2026-02-12T18:41:04.407668+11:00","close_reason":"Bootstrap updated (srcFiles, dirs, semver 0.3.0), updater has semver + stale cleanup. 168 tests passing (112 bridge + 56 sprite). Inspector verified.","dependencies":[{"issue_id":"stackdocs-m7b.7.9","depends_on_id":"stackdocs-m7b.7","type":"parent-child","created_at":"2026-02-12T11:59:49.440096+11:00","created_by":"thebrownproject"},{"issue_id":"stackdocs-m7b.7.9","depends_on_id":"stackdocs-m7b.7.8","type":"blocks","created_at":"2026-02-12T12:00:24.128648+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.8","title":"Cleanup: extract _read_safe to shared sprite util","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T21:31:34.519251+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T21:34:09.455146+11:00","closed_at":"2026-02-12T21:34:09.455146+11:00","close_reason":"Extracted read_safe to memory/__init__.py, updated loader.py and processor.py imports. 40 tests pass.","dependencies":[{"issue_id":"stackdocs-m7b.8","depends_on_id":"stackdocs-m7b","type":"parent-child","created_at":"2026-02-12T21:31:34.521345+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-m7b.9","title":"Cleanup: refactor canvas.py — block type registry, target ~280 lines","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-12T21:31:34.69847+11:00","created_by":"thebrownproject","updated_at":"2026-02-12T21:35:02.131422+11:00","closed_at":"2026-02-12T21:35:02.131422+11:00","close_reason":"Closed","dependencies":[{"issue_id":"stackdocs-m7b.9","depends_on_id":"stackdocs-m7b","type":"parent-child","created_at":"2026-02-12T21:31:34.699576+11:00","created_by":"thebrownproject"}]}
{"id":"stackdocs-oan","title":"Session memory lost on every deploy — session_id cleared forces fresh agent context","description":"## Problem\nEvery time we deploy new code to a Sprite, we manually clear /workspace/.os/session_id which forces a fresh SDK session. The agent loses all conversation history — doesn't know user's name, previous interactions, etc.\n\n## Root Cause\nThe deploy process (sprite-deploy skill) includes 'rm -f /workspace/.os/session_id' as a standard step. This was originally done to avoid resuming a broken session (before the tools/system-prompt fix), but it's now destroying valid session context on every deploy.\n\n## Impact\n- Agent forgets user name, preferences, previous conversations after every deploy\n- Breaks the 'persistent assistant' experience that's core to Stackdocs\n- Particularly bad during active development when deploys are frequent\n\n## Long-term Fix\nThe ObservationProcessor daemon should be writing learnings to user.md (daemon-managed memory file). This file persists across sessions and is loaded into the system prompt on every start. Once working, the agent would 'remember' key facts even after session_id is cleared.\n\n## Short-term Fix Options\n1. Stop clearing session_id on deploy — only clear when intentionally resetting\n2. Add a --fresh flag to sprite-deploy for when a clean start is needed\n3. Before clearing, save key context (user name, preferences) to user.md manually\n\n## Files\n- .claude/skills/sprite-deploy/SKILL.md — deploy skill includes rm session_id\n- sprite/src/runtime.py — _start_session() resume vs fresh path\n- sprite/src/memory/processor.py — ObservationProcessor (not yet running in production)\n- sprite/memory/user.md — template for user preferences (daemon-managed)","status":"closed","priority":2,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-15T16:13:51.295039+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T22:31:34.133438+11:00","closed_at":"2026-02-15T22:31:34.133438+11:00","close_reason":"Fixed: replaced ephemeral turn_count closure with DB query (SELECT COUNT(*) FROM observations WHERE processed = 0), lowered threshold 25→10. 1 new test."}
{"id":"stackdocs-ogm","title":"Clean up stale /workspace/src/ on Sprite VMs","description":"The Sprite VM has stale code at /workspace/src/ from old bootstrap. Current deploy writes to /workspace/.os/src/ (correct per m7b.7 spec). Production provisioning.ts uses PYTHONPATH=/workspace/.os to find the src package. The test script (test-e2e-v2.ts) was missing PYTHONPATH and wrong venv path, causing it to load stale /workspace/src/ code instead. test-e2e-v2.ts is now fixed. Remaining: (1) rm -rf /workspace/src on sd-e2e-test to remove stale code (2) Verify updater.ts handles the cleanup for any other Sprites.","status":"closed","priority":3,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-14T18:19:38.369143+11:00","created_by":"thebrownproject","updated_at":"2026-02-14T18:24:28.90386+11:00","closed_at":"2026-02-14T18:24:28.90386+11:00","close_reason":"Cleaned stale /workspace/src/ from sd-e2e-test Sprite. Added /workspace/src cleanup to updater.ts (will auto-clean any other Sprites on next connect). Bumped VERSION 0.3.0 → 0.3.1 to trigger update."}
{"id":"stackdocs-qdr","title":"Sign-in page flashes briefly after login","description":"[Migrated from ACTIVE.md #4]\n\nSign-in page flashes briefly after login before redirecting to /documents.\n\nDate: 2025-12-23","status":"tombstone","priority":2,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:06:55.86518+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"bug"}
{"id":"stackdocs-qj2","title":"Tab popover still showing old styling despite code changes","description":"The dots popover on glass-tab-switcher.tsx tabs still renders with old styling (large text, purple tint, rounded focus borders) despite code changes to use Radix PopoverPrimitive directly with pure glass classes.\n\nWHAT WAS DONE (session 155):\n- Replaced shadcn Popover import with raw radix PopoverPrimitive\n- Applied identical glass classes as working desktop context menu\n- Cleared .next cache, restarted dev server - still shows old styling\n- Code verified correct in file: glass-tab-switcher.tsx:86-128\n\nWHAT WORKS: Desktop right-click context menu renders perfectly with glass styling (GlassContextMenu wrapper). Both use Portal, both use identical classes.\n\nLIKELY ROOT CAUSE (needs DevTools):\n- CSS specificity: globals.css base layer or Radix data-attribute selectors overriding component classes\n- Check data-radix-popper-content-wrapper styles in DevTools\n- Check if bg-popover or text-popover-foreground CSS vars leaking from somewhere\n- Try adding !important as diagnostic test\n\nFILES: glass-tab-switcher.tsx:86-128, globals.css (base layer), glass-context-menu.tsx (working reference)","status":"closed","priority":1,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-13T12:00:19.29277+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T14:13:33.915655+11:00","closed_at":"2026-02-13T14:13:33.915655+11:00","close_reason":"Tab popover replaced with shared DesktopMenuBody; context menu already working from session 155"}
{"id":"stackdocs-s1j","title":"OCR images not rendering in Visual preview","description":"[Migrated from ACTIVE.md #6]\n\nMistral OCR extracts images as ![img-0.jpeg](img-0.jpeg) but we don't store/serve them.\n\nOptions:\n- Store extracted images to Supabase Storage during OCR\n- Or strip/hide image markdown\n\nDate: 2025-12-23","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:06:59.033904+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-sm2","title":"spriteExec uses CLI binary not available on Fly.io","description":"spriteExec (bridge/src/sprite-exec.ts) uses execFile(\"sprite\", ...) which requires the sprite CLI to be installed. On Fly.io (production), this CLI does not exist in the Docker container. This breaks:\n\n- Updater (checkAndUpdate): cannot deploy code, run mkdir, chown, pip install\n- Bootstrap (bootstrapSprite): cannot create dirs, install packages, init DB\n\nBoth fall back gracefully (best-effort try/catch) but the Sprite never gets properly updated.\n\nFix: Rewrite spriteExec to use the WebSocket exec API (same as startSpriteServer uses buildExecUrl). The exec WS API works from Fly.io — tested and confirmed.\n\nEvidence: Fly.io logs show \"Error: spawn sprite ENOENT\" on every update attempt.","status":"open","priority":1,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-13T10:57:32.914616+11:00","created_by":"thebrownproject","updated_at":"2026-02-13T10:57:32.914616+11:00"}
{"id":"stackdocs-sov","title":"Assign document to stacks from document detail page","description":"[Migrated from ACTIVE.md #30]\n\nDropdown in sub-bar to add/remove document from stacks, needs to handle re-extraction when stack membership changes.\n\nDate: 2025-12-30","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:07:59.886765+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-u18","title":"Fix: clampCardPosition never receives cardWidth — template cards clamp incorrectly","status":"open","priority":2,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-20T19:03:11.877081+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T19:03:11.877081+11:00"}
{"id":"stackdocs-z2j","title":"Support JPG/PNG image uploads","description":"[Migrated from ACTIVE.md #14]\n\nMistral OCR already handles images, just need to update accepted file types in upload dialog.\n\nDate: 2025-12-24","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:07:43.833015+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-z3t","title":"Sidebar gradual collapse to icon-only mode","description":"[Migrated from ACTIVE.md #32]\n\nIcon-only mode at tablet breakpoint (768-1024px) instead of hard switch to mobile sheet.\n\nCurrently: Single breakpoint at 1024px switches directly to mobile sheet overlay\nGoal: Desktop (\u003e=1024px) full sidebar, Tablet (768-1024px) icon-only locked, Mobile (\u003c768px) sheet\nBehavior: Icon-only mode locked (no expand), desktop state remembered when resizing back\nChanges: Update use-mobile.ts to three-state, modify SidebarProvider and Sidebar component\nReference: Linear collapses sidebar at ~1024px with similar pattern\n\nDate: 2025-12-31","status":"tombstone","priority":2,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:08:35.704286+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"stackdocs-zvl","title":"Clerk production OAuth missing client_id","description":"[Migrated from ACTIVE.md #3]\n\nGoogle, Microsoft fail; Apple removed.\n\nSetup instructions:\n- Google: Cloud Console → APIs \u0026 Credentials → Create OAuth 2.0 Client ID → Add to Clerk\n- Microsoft: Azure Portal → App Registrations → Create app → Add to Clerk\n- Clerk docs: https://clerk.com/docs/authentication/social-connections/google\n\nDate: 2025-12-23","status":"tombstone","priority":2,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-01-25T10:06:54.33104+11:00","created_by":"thebrownproject","updated_at":"2026-02-06T15:01:11.878859+11:00","deleted_at":"2026-02-06T15:01:11.878859+11:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"bug"}
{"id":"stackdocs-zxh","title":"Reconnect stuck on sprite_waking — Bridge never completes TCP proxy reconnection","description":"## Problem\nWhen the Sprite TCP connection drops (sleep/wake cycle, deploy, etc.), the Bridge sends a 'sprite_waking' system message to the frontend but the reconnection to the Sprite TCP proxy never completes. The frontend shows 'sprite_waking' status indefinitely. The user must manually refresh the page to re-establish the connection.\n\n## Observed Behavior\n1. Frontend connects successfully (auth → connected → sprite_ready → state_sync)\n2. After ~36 seconds of inactivity, Sprite goes to sleep (30s auto-sleep)\n3. Bridge detects TCP disconnect → sends sprite_waking message to frontend\n4. Frontend shows 'Sprite connection lost, reconnecting...' but nothing happens\n5. User must manually refresh to reconnect\n\n## Expected Behavior\nBridge should:\n1. Detect TCP disconnect\n2. Send sprite_waking to frontend\n3. Poll/wake the Sprite via API call\n4. Reconnect TCP proxy WebSocket\n5. Drain any buffered messages\n6. Send sprite_ready to frontend\n7. Frontend resumes normal operation\n\n## Likely Root Cause\nThe reconnect logic in bridge/src/reconnect.ts may not be triggering, or it may be failing silently. Possible issues:\n- Reconnect polling timeout too short\n- TCP proxy reconnection failing without retry\n- Bridge machine auto-stopped (Fly.io min_machines_running=0) and not restarting\n- Keepalive pings not being sent during active sessions (bridge/src/keepalive.ts)\n- Race condition: browser WebSocket to Bridge stays open but Bridge-to-Sprite TCP dies\n\n## Debug Steps\n1. Check Bridge logs during sleep/wake: flyctl logs\n2. Verify keepalive is running: should see ping messages every 15s in debug panel\n3. Check if reconnect.ts handleDisconnect is being called\n4. Test: send a message after sprite_waking — does it trigger reconnection?\n\n## Files\n- bridge/src/reconnect.ts — handleDisconnect, reconnectToSprite\n- bridge/src/keepalive.ts — ping sender (prevents 30s auto-sleep)\n- bridge/src/proxy.ts — Sprite connection management\n- bridge/src/sprite-connection.ts — TCP proxy WebSocket client\n- frontend/lib/websocket.ts — WebSocket manager (handles sprite_waking status)\n- frontend/components/desktop/ws-provider.tsx — connection state management","status":"closed","priority":1,"issue_type":"bug","owner":"fraserbrown@live.com","created_at":"2026-02-15T16:14:28.226274+11:00","created_by":"thebrownproject","updated_at":"2026-02-15T22:31:34.023276+11:00","closed_at":"2026-02-15T22:31:34.023276+11:00","close_reason":"Fixed: retry loop in handleDisconnect (5 attempts + server restart fallback), reconnect_failed broadcast to browser, onClose identity guard for race condition. 4 new tests."}
